generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model CategoryList {
  id         Int       @id @default(autoincrement())
  category   String    @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  user_id    Int?
  user       user?     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_category_list_user")
  @@map("category_list")
}

model FileList {
  id              Int                      @id @default(autoincrement())
  category        String
  title           String
  note            String?
  content_format  String?                  @db.VarChar(20)
  doc1            String?
  entry_date      String?                  @db.VarChar(50)
  entry_date_real DateTime?                @db.Date
  search_vector   Unsupported("tsvector")?
  created_at      DateTime?                @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?                @updatedAt @db.Timestamptz(6)
  semantic_vector Unsupported("vector")?
  user_id         Int?
  parsed_at       DateTime?                @db.Timestamptz(6)
  parsing_error   String?
  parsing_status  String?                  @default("pending") @db.VarChar(20)
  pages           DocumentPage[]
  chunks          FileChunk[]
  user            user?                    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([category], map: "idx_file_list_category")
  @@index([entry_date_real], map: "idx_file_list_entry_date")
  @@index([search_vector], map: "idx_search_vector", type: Gin)
  @@index([semantic_vector], map: "idx_semantic_vector")
  @@index([user_id], map: "idx_file_list_user")
  @@index([parsing_status], map: "idx_file_list_parsing_status")
  @@map("file_list")
}

/// Stores visual snapshots of document pages
model DocumentPage {
  id          Int      @id @default(autoincrement())
  file_id     Int
  page_number Int
  image_url   String
  width       Int?
  height      Int?
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  file        FileList @relation(fields: [file_id], references: [id], onDelete: Cascade)

  @@index([file_id, page_number], map: "idx_document_pages_file_page")
  @@map("document_pages")
}

/// Stores granular text chunks with layout coordinates
model FileChunk {
  id              Int                      @id @default(autoincrement())
  file_id         Int
  chunk_index     Int
  content         String
  page_number     Int?
  bbox            Json?
  token_count     Int?
  search_vector   Unsupported("tsvector")?
  semantic_vector Unsupported("vector")?
  created_at      DateTime                 @default(now()) @db.Timestamptz(6)
  file            FileList                 @relation(fields: [file_id], references: [id], onDelete: Cascade)

  @@index([file_id], map: "idx_file_chunks_file")
  @@index([search_vector], map: "idx_file_chunks_search_vector", type: Gin)
  @@index([semantic_vector], map: "idx_file_chunks_vector")
  @@map("file_chunks")
}

model user {
  id                    Int                 @id @default(autoincrement())
  username              String              @unique @db.VarChar(100)
  password_hash         String?             @db.VarChar(255)
  role                  UserRole            @default(student)
  is_active             Boolean?            @default(true)
  last_login            DateTime?           @db.Timestamptz(6)
  created_at            DateTime?           @default(now()) @db.Timestamptz(6)
  email                 String?             @unique @db.VarChar(255)
  image                 String?
  name                  String?             @db.VarChar(255)
  battle_participations BattleParticipant[]
  created_battles       Battle[]
  categories            CategoryList[]
  conversations         Conversation[]
  files                 FileList[]
  instructor_profile    Instructor?
  learning_sessions     LearningSession[]
  profile               Profile?
  quizzes               Quiz[]
  textbooks_created     Textbook[]          @relation("TextbookCreator")
  usage_tracking        UsageTracking[]
  badges                UserBadge[]
  enrollments           UserEnrollment[]
  points                UserPoints[]
  subscription          UserSubscription?
  custom_subjects       Subject[]           @relation("UserCustomSubjects")

  @@index([email], map: "idx_user_email")
}

model UserEnrollment {
  id               Int          @id @default(autoincrement())
  user_id          Int
  course_id        Int
  status           String       @default("active")
  progress         Int          @default(0)
  last_accessed_at DateTime?    @db.Timestamptz(6)
  enrolled_at      DateTime     @default(now()) @db.Timestamptz(6)
  completed_at     DateTime?    @db.Timestamptz(6)
  institution_id   BigInt?
  program_id       Int?
  is_paid          Boolean      @default(false)
  payment_id       String?      @db.VarChar(255)
  trial_ends_at    DateTime?    @db.Timestamptz(6)
  course           Course       @relation(fields: [course_id], references: [id], onDelete: Cascade)
  institution      Institution? @relation(fields: [institution_id], references: [id])
  program          Program?     @relation(fields: [program_id], references: [id])
  user             user         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, course_id])
  @@index([user_id])
  @@index([course_id])
  @@index([institution_id])
  @@index([program_id])
  @@map("user_enrollments")
}

model Course {
  id            Int              @id @default(autoincrement())
  title         String           @db.VarChar(255)
  description   String?
  thumbnail_url String?
  board_id      String
  is_published  Boolean          @default(false)
  is_free       Boolean          @default(true)
  price         Decimal?         @db.Decimal(10, 2)
  currency      String           @default("INR") @db.VarChar(3)
  instructor_id Int?
  created_at    DateTime         @default(now()) @db.Timestamptz(6)
  updated_at    DateTime         @updatedAt @db.Timestamptz(6)
  board         Board            @relation(fields: [board_id], references: [id])
  instructor    Instructor?      @relation(fields: [instructor_id], references: [id])
  enrollments   UserEnrollment[]
  subjects      Subject[]        @relation("CourseToSubject")

  @@map("courses")
}

model Instructor {
  id           Int      @id @default(autoincrement())
  user_id      Int      @unique
  bio          String?
  avatar_url   String?
  title        String?  @db.VarChar(100)
  social_links Json?    @default("{}")
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @updatedAt @db.Timestamptz(6)
  courses      Course[]
  user         user     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("instructors")
}

/// Stores conversation sessions for chat history
model Conversation {
  id              Int                   @id @default(autoincrement())
  user_id         Int
  title           String                @default("New Conversation") @db.VarChar(255)
  created_at      DateTime              @default(now()) @db.Timestamptz(6)
  updated_at      DateTime              @updatedAt @db.Timestamptz(6)
  last_message_at DateTime?             @db.Timestamptz(6)
  message_count   Int                   @default(0)
  is_pinned       Boolean               @default(false)
  is_archived     Boolean               @default(false)
  chapter_id      BigInt?
  subject_id      Int?
  messages        ConversationMessage[]
  chapter         Chapter?              @relation(fields: [chapter_id], references: [id])
  subject         Subject?              @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  user            user                  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, updated_at(sort: Desc)], map: "idx_conversations_user_updated")
  @@index([user_id, is_pinned, updated_at(sort: Desc)], map: "idx_conversations_user_pinned")
  @@index([subject_id])
  @@index([chapter_id])
  @@map("conversations")
}

/// Stores individual messages within conversations
model ConversationMessage {
  id              Int          @id @default(autoincrement())
  conversation_id Int
  role            MessageRole
  content         String
  sources         Json?
  token_count     Json?
  metadata        Json?
  created_at      DateTime     @default(now()) @db.Timestamptz(6)
  conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id, created_at], map: "idx_conversation_messages_conversation")
  @@map("conversation_messages")
}

/// Stores encrypted API keys and metadata for AI providers
model AiApiKey {
  id            Int       @id @default(autoincrement())
  provider      Provider
  label         String    @db.VarChar(100)
  api_key_enc   String
  active        Boolean   @default(true)
  priority      Int       @default(0)
  success_count Int       @default(0)
  error_count   Int       @default(0)
  last_used_at  DateTime? @db.Timestamptz(6)
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @updatedAt @db.Timestamptz(6)

  @@index([provider, active, priority], map: "idx_ai_api_keys_active_priority")
  @@map("ai_api_keys")
}

/// Lists available models per provider, manageable by admin
model AiModel {
  id         Int      @id @default(autoincrement())
  provider   Provider
  name       String   @db.VarChar(100)
  label      String   @db.VarChar(150)
  active     Boolean  @default(true)
  priority   Int      @default(0)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  @@unique([provider, name], map: "uq_ai_model_provider_name")
  @@index([provider, active, priority], map: "idx_ai_models_active_priority")
  @@map("ai_models")
}

/// Cache for AI chat responses to reduce API calls
model AiResponseCache {
  id            Int      @id @default(autoincrement())
  cache_key     String   @unique @db.VarChar(255)
  query_type    String   @db.VarChar(50)
  chapter_id    BigInt?
  subject_id    BigInt?
  question      String
  response_text String
  input_tokens  Int
  output_tokens Int
  hit_count     Int      @default(1)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  expires_at    DateTime @db.Timestamptz(6)
  images        String[] @default([])

  @@index([expires_at], map: "idx_ai_response_cache_expires")
  @@index([chapter_id], map: "idx_ai_response_cache_chapter")
  @@index([subject_id], map: "idx_ai_response_cache_subject")
  @@map("ai_response_cache")
}

model app_settings {
  key        String    @id
  value      String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Subscription plans available for users
model SubscriptionPlan {
  id                       Int                @id @default(autoincrement())
  name                     String             @unique @db.VarChar(100)
  display_name             String             @db.VarChar(150)
  description              String?
  price_monthly            Decimal            @db.Decimal(10, 2)
  price_yearly             Decimal?           @db.Decimal(10, 2)
  razorpay_plan_id_monthly String?            @db.VarChar(255)
  razorpay_plan_id_yearly  String?            @db.VarChar(255)
  features                 Json?
  limits                   Json
  is_active                Boolean            @default(true)
  is_default               Boolean            @default(false)
  created_at               DateTime           @default(now()) @db.Timestamptz(6)
  updated_at               DateTime           @updatedAt @db.Timestamptz(6)
  subscriptions            UserSubscription[]

  @@index([is_active, is_default], map: "idx_subscription_plans_active")
  @@map("subscription_plans")
}

/// User subscription information
model UserSubscription {
  id                       Int                @id @default(autoincrement())
  user_id                  Int                @unique
  plan_id                  Int
  razorpay_subscription_id String?            @unique @db.VarChar(255)
  razorpay_customer_id     String?            @db.VarChar(255)
  razorpay_order_id        String?            @db.VarChar(255)
  status                   SubscriptionStatus @default(active)
  billing_cycle            BillingCycle       @default(monthly)
  current_period_start     DateTime           @db.Timestamptz(6)
  current_period_end       DateTime           @db.Timestamptz(6)
  cancel_at_period_end     Boolean            @default(false)
  canceled_at              DateTime?          @db.Timestamptz(6)
  created_at               DateTime           @default(now()) @db.Timestamptz(6)
  updated_at               DateTime           @updatedAt @db.Timestamptz(6)
  plan                     SubscriptionPlan   @relation(fields: [plan_id], references: [id])
  user                     user               @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([status, current_period_end], map: "idx_user_subscriptions_status")
  @@index([razorpay_subscription_id], map: "idx_user_subscriptions_razorpay")
  @@map("user_subscriptions")
}

/// Usage tracking for subscription limits
model UsageTracking {
  id           Int       @id @default(autoincrement())
  user_id      Int
  usage_type   UsageType
  count        Int       @default(1)
  period_start DateTime  @db.Timestamptz(6)
  period_end   DateTime  @db.Timestamptz(6)
  metadata     Json?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  user         user      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, usage_type, period_start], map: "idx_usage_tracking_user_type")
  @@index([period_start, period_end], map: "idx_usage_tracking_period")
  @@map("usage_tracking")
}

model Country {
  id        String  @id
  name      String
  currency  String
  locale    String  @default("en")
  is_active Boolean @default(true)
  boards    Board[]

  @@map("countries")
}

model Board {
  id           String              @id
  name         String
  country_id   String              @default("IN")
  state        String?
  is_active    Boolean             @default(true)
  created_at   DateTime            @default(now())
  updated_at   DateTime            @updatedAt
  type         String              @default("academic")
  hide_textbook Boolean            @default(false)
  country      Country             @relation(fields: [country_id], references: [id])
  chunkBoards  ChapterChunkBoard[]
  courses      Course[]
  institutions Institution[]
  programs     Program[]

  @@index([country_id, is_active])
  @@index([type])
  @@map("boards")
}

model Institution {
  id             BigInt           @id @default(autoincrement())
  board_id       String
  name           String
  type           String
  district       String?
  state          String?
  license_expiry DateTime?
  is_active      Boolean          @default(true)
  created_at     DateTime         @default(now())
  board          Board            @relation(fields: [board_id], references: [id])
  programs       Program[]
  enrollments    UserEnrollment[]

  @@index([board_id, is_active])
  @@map("institutions")
}

model Program {
  id             Int              @id @default(autoincrement())
  board_id       String
  institution_id BigInt?
  name           String
  code           String?
  level          String?
  duration_years Int?
  is_active      Boolean          @default(true)
  created_at     DateTime         @default(now())
  exam_category  String?          @db.VarChar(50)
  board          Board            @relation(fields: [board_id], references: [id])
  institution    Institution?     @relation(fields: [institution_id], references: [id])
  subjects       Subject[]
  enrollments    UserEnrollment[]

  @@unique([board_id, institution_id, name])
  @@index([board_id, level])
  @@map("programs")
}

model Profile {
  id           Int     @id @default(autoincrement())
  user_id      Int     @unique
  is_premium   Boolean @default(false)
  last_sync_at BigInt?
  user         user    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Subject {
  id              Int            @id @default(autoincrement())
  name            String
  code            String?
  is_active       Boolean        @default(true)
  created_at      DateTime       @default(now())
  program_id      Int
  term            String?
  exam_id         String?
  quizzes_enabled Boolean        @default(true)
  created_by_user_id Int?
  chapters        Chapter[]
  conversations   Conversation[]
  quizzes         Quiz[]
  exam            Exam?          @relation(fields: [exam_id], references: [id])
  program         Program        @relation(fields: [program_id], references: [id])
  created_by_user user?          @relation("UserCustomSubjects", fields: [created_by_user_id], references: [id], onDelete: Cascade)
  textbooks       Textbook[]
  courses         Course[]       @relation("CourseToSubject")

  @@unique([program_id, name, created_by_user_id])
  @@index([created_by_user_id])
  @@index([program_id])
  @@index([exam_id])
  @@map("subjects")
}

model Chapter {
  id                BigInt            @id @default(autoincrement())
  subject_id        Int
  title             String
  chapter_number    Int?
  content_json      Json
  version_id        String            @default(cuid())
  accessible_boards String[]
  is_global         Boolean           @default(false)
  is_active         Boolean           @default(true)
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt
  parsed_at         DateTime?
  error_message     String?
  processed_at      DateTime?
  processing_status ChapterStatus     @default(PENDING)
  pdf_url           String?
  quiz_regen_status QuizRegenStatus   @default(IDLE)
  quizzes_enabled   Boolean           @default(true)
  key_points        String?           @db.Text
  chunks            ChapterChunk[]
  subject           Subject           @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  conversations     Conversation[]
  learning_sessions LearningSession[]
  questions         Question[]
  quizzes           Quiz[]
  quiz_questions    QuizQuestion[]
  study_materials   StudyMaterial?

  @@index([subject_id, chapter_number])
  @@index([accessible_boards], type: Gin)
  @@index([processing_status])
  @@map("chapters")
}

model ChapterChunk {
  id              BigInt                   @id @default(autoincrement())
  chapter_id      BigInt
  chunk_index     Int
  content         String
  page_number     Int?
  search_vector   Unsupported("tsvector")?
  semantic_vector Unsupported("vector")?
  subject_id      Int?
  created_at      DateTime                 @default(now())
  chunkBoards     ChapterChunkBoard[]
  chapter         Chapter                  @relation(fields: [chapter_id], references: [id], onDelete: Cascade)

  @@index([chapter_id, chunk_index])
  @@index([search_vector], type: Gin)
  @@index([semantic_vector])
  @@index([subject_id])
  @@map("chapter_chunks")
}

model ChapterChunkBoard {
  chunk_id BigInt
  board_id String
  board    Board        @relation(fields: [board_id], references: [id])
  chunk    ChapterChunk @relation(fields: [chunk_id], references: [id], onDelete: Cascade)

  @@id([chunk_id, board_id])
  @@index([board_id])
  @@map("chapter_chunk_boards")
}

/// System-wide settings for quiz configuration
model SystemSetting {
  id         Int      @id @default(autoincrement())
  key        String   @unique @db.VarChar(255)
  value      String
  type       String   @db.VarChar(50)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  @@map("system_settings")
}

model Quiz {
  id           String         @id @default(cuid())
  user_id      Int
  subject_id   Int
  chapter_id   BigInt?
  title        String
  description  String?
  status       QuizStatus     @default(IN_PROGRESS)
  score        Int            @default(0)
  total_points Int            @default(0)
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt
  completed_at DateTime?
  battles      Battle[]
  questions    QuizQuestion[]
  chapter      Chapter?       @relation(fields: [chapter_id], references: [id])
  subject      Subject        @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  user         user           @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([subject_id])
  @@map("quizzes")
}

model QuizQuestion {
  id             String       @id @default(cuid())
  quiz_id        String
  question_text  String
  question_type  QuestionType
  options        Json?
  correct_answer Json
  user_answer    Json?
  is_correct     Boolean?
  points         Int          @default(1)
  explanation    String?
  feedback       String?
  chapter_id     BigInt?
  chapter        Chapter?     @relation(fields: [chapter_id], references: [id], onDelete: SetNull)
  quiz           Quiz         @relation(fields: [quiz_id], references: [id], onDelete: Cascade)

  @@index([quiz_id])
  @@index([chapter_id])
  @@map("quiz_questions")
}

/// Question Bank Model - Stores pre-generated questions for chapters
model Question {
  id             String       @id @default(cuid())
  chapter_id     BigInt
  question_text  String
  question_type  QuestionType
  difficulty     String
  options        Json?
  correct_answer Json
  explanation    String?
  points         Int          @default(1)
  is_active      Boolean      @default(true)
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt
  chapter        Chapter      @relation(fields: [chapter_id], references: [id], onDelete: Cascade)

  @@index([chapter_id, difficulty, question_type])
  @@map("questions")
}

model UserPoints {
  id         String   @id @default(cuid())
  user_id    Int
  points     Int
  reason     String
  metadata   Json?
  created_at DateTime @default(now())
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("user_points")
}

model StudyMaterial {
  id             BigInt   @id @default(autoincrement())
  chapter_id     BigInt   @unique
  summary        Json?
  definitions    Json?
  flashcards     Json?
  mind_map       String?
  video_queries  String[]
  curated_videos Json?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  chapter        Chapter  @relation(fields: [chapter_id], references: [id], onDelete: Cascade)

  @@index([chapter_id])
  @@map("study_materials")
}

model Exam {
  id            String     @id @default(cuid())
  name          String     @db.VarChar(255)
  description   String?
  is_active     Boolean    @default(true)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  code          String     @unique @db.VarChar(50)
  short_name    String?    @db.VarChar(100)
  exam_type     String     @default("board") @db.VarChar(30)
  parent_id     String?
  display_order Int        @default(0)
  parent        Exam?      @relation("ExamHierarchy", fields: [parent_id], references: [id])
  children      Exam[]     @relation("ExamHierarchy")
  subjects      Subject[]
  syllabi       Syllabus[]
  textbooks     Textbook[]

  @@index([exam_type])
  @@index([is_active, display_order])
  @@map("exams")
}

model StreakBadge {
  id          String      @id @default(cuid())
  name        String
  icon        String
  min_streak  Int         @unique
  is_active   Boolean     @default(true)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  user_badges UserBadge[]

  @@map("streak_badges")
}

model UserBadge {
  id        String      @id @default(cuid())
  user_id   Int
  badge_id  String
  earned_at DateTime    @default(now())
  badge     StreakBadge @relation(fields: [badge_id], references: [id], onDelete: Cascade)
  user      user        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, badge_id])
  @@index([user_id])
  @@index([badge_id])
  @@map("user_badges")
}

model LearningSession {
  id            String   @id @default(cuid())
  user_id       Int
  chapter_id    BigInt
  status        String   @default("active")
  current_topic String?
  progress      Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  chapter       Chapter  @relation(fields: [chapter_id], references: [id], onDelete: Cascade)
  user          user     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, chapter_id])
  @@map("learning_sessions")
}

model Battle {
  id               String              @id @default(cuid())
  quiz_id          String
  code             String              @unique @db.VarChar(10)
  status           BattleStatus        @default(WAITING)
  created_by       Int
  created_at       DateTime            @default(now())
  started_at       DateTime?
  ended_at         DateTime?
  settings         Json?
  duration_minutes Int                 @default(5)
  is_public        Boolean             @default(true)
  participants     BattleParticipant[]
  creator          user                @relation(fields: [created_by], references: [id])
  quiz             Quiz                @relation(fields: [quiz_id], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([status])
  @@index([created_by])
  @@map("battles")
}

model BattleParticipant {
  id              String    @id @default(cuid())
  battle_id       String
  user_id         Int
  score           Int       @default(0)
  current_q_index Int       @default(0)
  finished        Boolean   @default(false)
  joined_at       DateTime  @default(now())
  last_active     DateTime  @default(now())
  is_ready        Boolean   @default(false)
  completed_at    DateTime?
  points_change   Int       @default(0)
  rank            Int       @default(0)
  battle          Battle    @relation(fields: [battle_id], references: [id], onDelete: Cascade)
  user            user      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([battle_id, user_id])
  @@map("battle_participants")
}

model Syllabus {
  id                 Int            @id @default(autoincrement())
  title              String         @db.VarChar(255)
  description        String?
  board              String         @default("MBSE")
  class_level        String         @db.VarChar(20)
  stream             String?        @db.VarChar(50)
  subject            String         @db.VarChar(255)
  academic_year      String?        @db.VarChar(20)
  raw_text           String?
  status             SyllabusStatus @default(DRAFT)
  created_at         DateTime       @default(now()) @db.Timestamptz(6)
  updated_at         DateTime       @updatedAt @db.Timestamptz(6)
  exam_category      String?        @default("academic_board") @db.VarChar(50)
  parent_syllabus_id Int?
  syllabus_mode      String?        @default("single") @db.VarChar(20)
  exam_id            String?
  exam               Exam?          @relation(fields: [exam_id], references: [id])
  parent             Syllabus?      @relation("SyllabusSplit", fields: [parent_syllabus_id], references: [id])
  children           Syllabus[]     @relation("SyllabusSplit")
  units              SyllabusUnit[]
  textbooks          Textbook[]

  @@index([exam_id])
  @@index([parent_syllabus_id])
  @@map("syllabi")
}

model SyllabusUnit {
  id          Int               @id @default(autoincrement())
  syllabus_id Int
  title       String            @db.VarChar(255)
  order       Int
  description String?
  chapters    SyllabusChapter[]
  syllabus    Syllabus          @relation(fields: [syllabus_id], references: [id], onDelete: Cascade)

  @@unique([syllabus_id, order])
  @@map("syllabus_units")
}

model SyllabusChapter {
  id             Int          @id @default(autoincrement())
  unit_id        Int
  chapter_number String       @db.VarChar(10)
  title          String       @db.VarChar(255)
  order          Int
  subtopics      Json?
  unit           SyllabusUnit @relation(fields: [unit_id], references: [id], onDelete: Cascade)

  @@unique([unit_id, order])
  @@map("syllabus_chapters")
}

/// Represents a complete textbook project
model Textbook {
  id               Int                     @id @default(autoincrement())
  title            String                  @db.VarChar(255)
  description      String?
  class_level      String                  @db.VarChar(20)
  stream           String?                 @db.VarChar(50)
  subject_name     String?                 @db.VarChar(255)
  board_id         String?                 @default("MBSE")
  academic_year    String?                 @db.VarChar(20)
  author           String?                 @db.VarChar(255)
  raw_syllabus     String?
  status           TextbookStatus          @default(DRAFT)
  progress         Int                     @default(0)
  cover_image_url  String?
  pdf_url          String?
  created_at       DateTime                @default(now()) @db.Timestamptz(6)
  updated_at       DateTime                @updatedAt @db.Timestamptz(6)
  created_by       Int
  compiled_pdf_url String?
  subject_id       Int?
  syllabus_id      Int?
  content_style    String?                 @default("academic") @db.VarChar(30)
  exam_id          String?
  generation_jobs  TextbookGenerationJob[]
  units            TextbookUnit[]
  creator          user                    @relation("TextbookCreator", fields: [created_by], references: [id])
  exam             Exam?                   @relation(fields: [exam_id], references: [id])
  subject          Subject?                @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  syllabus         Syllabus?               @relation(fields: [syllabus_id], references: [id])

  @@index([exam_id])
  @@index([status, created_at(sort: Desc)])
  @@index([board_id, class_level])
  @@index([created_by])
  @@map("textbooks")
}

/// Represents a unit/part within a textbook
model TextbookUnit {
  id          Int               @id @default(autoincrement())
  textbook_id Int
  order       Int
  title       String            @db.VarChar(255)
  description String?
  created_at  DateTime          @default(now()) @db.Timestamptz(6)
  updated_at  DateTime          @updatedAt @db.Timestamptz(6)
  chapters    TextbookChapter[]
  textbook    Textbook          @relation(fields: [textbook_id], references: [id], onDelete: Cascade)

  @@unique([textbook_id, order])
  @@map("textbook_units")
}

/// Represents a chapter within a unit
model TextbookChapter {
  id                 Int               @id @default(autoincrement())
  unit_id            Int
  chapter_number     String            @db.VarChar(10)
  title              String            @db.VarChar(255)
  order              Int
  raw_syllabus_text  String?
  subtopics          Json?
  content_markdown   String?
  content_html       String?
  learning_outcomes  Json?
  key_takeaways      Json?
  neet_relevant      Boolean           @default(false)
  jee_relevant       Boolean           @default(false)
  cuet_relevant      Boolean           @default(false)
  exam_highlights    Json?
  mcq_questions      Json?
  short_questions    Json?
  long_questions     Json?
  model_used         String?           @db.VarChar(100)
  tokens_used        Json?
  generation_time_ms Int?
  status             ChapterGenStatus  @default(PENDING)
  generation_error   String?
  created_at         DateTime          @default(now()) @db.Timestamptz(6)
  updated_at         DateTime          @updatedAt @db.Timestamptz(6)
  content            String?
  generated_at       DateTime?         @db.Timestamptz(6)
  pdf_url            String?
  summary            String?
  image_count        Int?
  long_answer_count  Int?
  max_words          Int?
  mcq_count          Int?
  min_words          Int?
  short_answer_count Int?
  unit               TextbookUnit      @relation(fields: [unit_id], references: [id], onDelete: Cascade)
  images             TextbookImage[]
  sections           TextbookSection[]

  @@unique([unit_id, order])
  @@index([status])
  @@map("textbook_chapters")
}

/// Represents a recursive section within a chapter (Topic -> Subtopic -> Detail)
model TextbookSection {
  id         String            @id @default(cuid())
  chapter_id Int
  parent_id  String?
  order      Int
  title      String            @db.VarChar(255)
  level      Int               @default(1)
  content    String?
  status     ChapterGenStatus  @default(PENDING)
  created_at DateTime          @default(now()) @db.Timestamptz(6)
  updated_at DateTime          @updatedAt @db.Timestamptz(6)
  chapter    TextbookChapter   @relation(fields: [chapter_id], references: [id], onDelete: Cascade)
  parent     TextbookSection?  @relation("SectionHierarchy", fields: [parent_id], references: [id], onDelete: Cascade)
  children   TextbookSection[] @relation("SectionHierarchy")

  @@index([chapter_id])
  @@index([parent_id])
  @@map("textbook_sections")
}

/// Stores generated images/diagrams for chapters
model TextbookImage {
  id                 Int               @id @default(autoincrement())
  chapter_id         Int
  type               TextbookImageType
  prompt             String?
  alt_text           String?           @db.VarChar(255)
  image_url          String?
  order              Int               @default(0)
  model_used         String?           @db.VarChar(100)
  generation_time_ms Int?
  created_at         DateTime          @default(now()) @db.Timestamptz(6)
  generated_at       DateTime?         @db.Timestamptz(6)
  placement          String?           @db.VarChar(255)
  status             ImageGenStatus    @default(PENDING)
  url                String?
  caption            String?           @db.VarChar(500)
  chapter            TextbookChapter   @relation(fields: [chapter_id], references: [id], onDelete: Cascade)

  @@index([chapter_id, type])
  @@index([status])
  @@map("textbook_images")
}

/// Tracks generation jobs for async processing
model TextbookGenerationJob {
  id            Int                       @id @default(autoincrement())
  textbook_id   Int
  job_type      TextbookGenerationJobType
  status        TextbookJobStatus         @default(QUEUED)
  target_id     Int?
  input_data    Json?
  output_data   Json?
  error_message String?
  progress      Int                       @default(0)
  started_at    DateTime?                 @db.Timestamptz(6)
  completed_at  DateTime?                 @db.Timestamptz(6)
  attempts      Int                       @default(0)
  max_attempts  Int                       @default(3)
  created_at    DateTime                  @default(now()) @db.Timestamptz(6)
  textbook      Textbook                  @relation(fields: [textbook_id], references: [id], onDelete: Cascade)

  @@index([status, created_at])
  @@index([textbook_id, job_type])
  @@map("textbook_generation_jobs")
}

enum ChapterStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@map("chapter_status")
}

enum QuizRegenStatus {
  IDLE
  GENERATING
  COMPLETED
  FAILED

  @@map("quiz_regen_status")
}

enum MessageRole {
  user
  assistant

  @@map("message_role")
}

enum UserRole {
  admin
  institution
  student
  instructor

  @@map("user_role")
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
  incomplete
  incomplete_expired

  @@map("subscription_status")
}

enum BillingCycle {
  monthly
  yearly

  @@map("billing_cycle")
}

enum UsageType {
  file_upload
  chat_message
  document_export
  ai_processing
  quiz_generation
  battle_match
  ai_tutor_session
  image_generation

  @@map("usage_type")
}

/// Provider enum for AI key management
enum Provider {
  gemini
  openai
  anthropic
  llamaparse
  openrouter
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  FILL_IN_BLANK
  SHORT_ANSWER
  LONG_ANSWER
}

enum QuizStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum BattleStatus {
  WAITING
  STARTING
  IN_PROGRESS
  COMPLETED
  ABANDONED
  EXPIRED
}

enum SyllabusStatus {
  DRAFT
  PARSING
  PARSED
  ARCHIVED

  @@map("syllabus_status")
}

enum TextbookStatus {
  DRAFT
  PARSING
  GENERATING
  REVIEWING
  PUBLISHED
  ARCHIVED

  @@map("textbook_status")
}

enum ChapterGenStatus {
  PENDING
  GENERATING
  GENERATED
  FAILED
  REVIEWED
  COMPLETED

  @@map("chapter_gen_status")
}

enum ImageGenStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED

  @@map("image_gen_status")
}

enum TextbookImageType {
  DIAGRAM
  CHART
  MAP
  ILLUSTRATION
  COVER
  GRAPH
  ANATOMY
  CIRCUIT
  FLOWCHART
  INFOGRAPHIC
  MINDMAP
  MOLECULAR
  ANATOMICAL
  EXPERIMENTAL
  GEOMETRIC
  TIMELINE
  COMPARISON
  PHOTO
  ICON

  @@map("textbook_image_type")
}

enum TextbookGenerationJobType {
  PARSE_SYLLABUS
  GENERATE_CHAPTER
  GENERATE_QUESTIONS
  GENERATE_IMAGE
  COMPILE_PDF
  FULL_TEXTBOOK

  @@map("textbook_generation_job_type")
}

enum TextbookJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED

  @@map("textbook_job_status")
}
