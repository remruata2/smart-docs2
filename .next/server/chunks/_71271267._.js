module.exports=[510453,e=>e.a(async(t,r)=>{try{var a=e.i(698043),i=e.i(292938),s=e.i(799160),n=e.i(924868),o=e.i(814747),l=e.i(522734),d=e.i(233405),c=t([s]);async function u(t,r,c="llamaparse"){try{console.log(`[FILE-PARSING] Starting parsing for file ${t}, path: ${r}`),await a.prisma.fileList.update({where:{id:t},data:{parsing_status:"processing"}});let u=[],p="";if("docling"===c){let{convertFileWithDocling:t}=await e.A(844625),a=await t(r);if(!a)throw Error("Docling parsing failed to return content");p=a}else{let e=new i.LlamaParseDocumentParser,t=await e.parseFile(r);Array.isArray(t)?(u=t,p=t.map((e,t)=>{let r=e.md||e.text||"",a=e.pageNumber||t+1;return r.trim()?`--- Page ${a} ---

${r.trim()}`:""}).filter(e=>e.length>0).join("\n\n")):p=t}console.log(`[FILE-PARSING] Parsed ${u.length} pages for file ${t}`);let f=o.default.join(process.cwd(),"public","files",String(t)),g=!1;if((0,l.existsSync)(f)&&(console.log(`[FILE-PARSING] Image directory already exists for file ${t}, cleaning up...`),await n.default.rm(f,{recursive:!0,force:!0})),await n.default.mkdir(f,{recursive:!0}),r.toLowerCase().endsWith(".pdf"))try{console.log(`[FILE-PARSING] Generating images for file ${t}...`);let e=(0,d.spawn)("pdftocairo",["-jpeg","-scale-to","1024",r,o.default.join(f,"page")]);for(let t of(await new Promise((t,r)=>{e.on("close",e=>{0===e?t():r(Error(`pdftocairo exited with code ${e}`))}),e.on("error",e=>{r(e)}),e.stderr.on("data",e=>{console.error(`[pdftocairo stderr]: ${e}`)})}),await n.default.readdir(f))){let e=t.match(/^page-0*(\d+)\.jpg$/);if(e){let r=parseInt(e[1],10),a=o.default.join(f,t),i=o.default.join(f,`page-${r}.jpg`);a===i||(0,l.existsSync)(i)||await n.default.rename(a,i)}}let a=(await n.default.readdir(f)).filter(e=>e.endsWith(".jpg"));a.length>0?(g=!0,console.log(`[FILE-PARSING] Generated ${a.length} page images for file ${t}`)):console.warn(`[FILE-PARSING] No image files found after generation for file ${t}`)}catch(e){console.error(`[FILE-PARSING] Failed to generate images for file ${t}:`,e)}if(u.length>0){let e=u.map((e,r)=>{let i=r+1,s=g?`/files/${t}/page-${i}.jpg`:null;return a.prisma.documentPage.create({data:{file_id:t,page_number:i,image_url:s||"",width:e.width||0,height:e.height||0}})});await Promise.all(e),console.log(`[FILE-PARSING] Created ${u.length} DocumentPage records for file ${t}`)}let h=0;for(let e=0;e<u.length;e++){let r=u[e],i=r.width||595,s=r.height||842,n=e+1,o="",l=[],d=r.items||r.layout||[];if(Array.isArray(d)&&d.length>0)for(let e of d.filter(e=>!!(e.text||e.value||e.md))){let t=e.text||e.value||e.md||"";if(t.trim()&&(o+=t.trim()+"\n\n",e.bBox&&"object"==typeof e.bBox))if("number"==typeof e.bBox.x&&"number"==typeof e.bBox.y&&"number"==typeof e.bBox.w&&"number"==typeof e.bBox.h){let r=function(e,t=595,r=842){let a=e.x??0,i=e.y??0,s=e.w??1,n=e.h??1;return(t<=0||r<=0)&&(console.warn(`[FILE-PARSING] Invalid page dimensions: ${t}x${r}, using defaults`),t=595,r=842),[Math.max(0,Math.min(1,a/t)),Math.max(0,Math.min(1,i/r)),Math.max(0,Math.min(1,s/t)),Math.max(0,Math.min(1,n/r))]}(e.bBox,i,s),a=t.trim().substring(0,200);l.push({text:a,bbox:r})}else console.warn(`[FILE-PARSING] Invalid bbox structure for item on page ${n}:`,e.bBox)}else o=r.text||r.md||"";if(!o.trim())continue;let c=await a.prisma.fileChunk.create({data:{file_id:t,chunk_index:h++,content:o.trim(),page_number:n,bbox:l.length>0?l:[0,0,1,1]}});await a.prisma.$executeRaw`
				UPDATE file_chunks
				SET search_vector = to_tsvector('english', ${o.trim()})
				WHERE id = ${c.id}
			`}console.log(`[FILE-PARSING] Created ${h} FileChunk records for file ${t}`);let m=await a.prisma.fileList.findUnique({where:{id:t},select:{title:!0,category:!0,note:!0,entry_date:!0,entry_date_real:!0}});m&&await a.prisma.$executeRaw`
				UPDATE file_list
				SET search_vector = to_tsvector('english',
					COALESCE('Title: ' || ${m.title}, '') || ' | ' ||
					COALESCE('Category: ' || ${m.category}, '') || ' | ' ||
					COALESCE('Content: ' || ${p}, '') || ' | ' ||
					COALESCE(${m.entry_date||""}, '') || ' ' ||
					COALESCE(EXTRACT(YEAR FROM ${m.entry_date_real})::text, '')
				)
				WHERE id = ${t}
			`;try{await s.SemanticVectorService.updateSemanticVector(t),await s.SemanticVectorService.generateChunkVectors(t),console.log(`[FILE-PARSING] Generated semantic vectors for file ${t}`)}catch(e){console.error(`[FILE-PARSING] Semantic vector update failed for file ${t}:`,e)}return await a.prisma.fileList.update({where:{id:t},data:{parsing_status:"completed",parsed_at:new Date,note:p}}),console.log(`[FILE-PARSING] Successfully completed parsing for file ${t}`),{success:!0}}catch(r){console.error(`[FILE-PARSING] Error parsing file ${t}:`,r);let e="Unknown error during parsing";if(r instanceof Error){if(e=r.message,r.isCreditLimit||r.message.includes("credit limit")||r.message.includes("exceeded the maximum number of credits"))e="LlamaParse API credit limit exceeded. Please upgrade your LlamaParse plan or wait for credits to reset.";else if(r.message.includes("returned no documents")){let t=JSON.stringify(r);(t.includes("exceeded the maximum number of credits")||t.includes("credits for your plan"))&&(e="LlamaParse API credit limit exceeded. Please upgrade your LlamaParse plan or wait for credits to reset.")}}return await a.prisma.fileList.update({where:{id:t},data:{parsing_status:"failed",parsing_error:e}}),{success:!1,error:e}}}[s]=c.then?(await c)():c,e.s(["processFileParsing",()=>u]),r()}catch(e){r(e)}},!1),626769,e=>e.a(async(t,r)=>{try{var a=e.i(89171),i=e.i(757660),s=e.i(856292),n=e.i(698043),o=e.i(510453),l=e.i(814747),d=e.i(522734),c=t([o]);async function u(e){console.log("[PROCESS-FILE] API called");let t=await (0,i.getServerSession)(s.authOptions);if(!t?.user?.id){let t=e.headers.get("x-api-key");if(!t||t!==process.env.BACKGROUND_PROCESSING_API_KEY)return a.NextResponse.json({error:"Unauthorized"},{status:401})}try{let{searchParams:t}=new URL(e.url),r=parseInt(t.get("limit")||"1",10),i=t.get("fileId"),s=[];if(i)s=await n.prisma.fileList.findMany({where:{id:parseInt(i,10),parsing_status:"pending"},take:1});else{let e=await n.prisma.$transaction(async e=>{let t=await e.fileList.findMany({where:{parsing_status:"pending",doc1:{not:null}},orderBy:{created_at:"asc"},take:r,select:{id:!0}});return t.length>0&&await e.fileList.updateMany({where:{id:{in:t.map(e=>e.id)},parsing_status:"pending"},data:{parsing_status:"processing"}}),t});s=e.length>0?await n.prisma.fileList.findMany({where:{id:{in:e.map(e=>e.id)},parsing_status:"processing"}}):[]}if(0===s.length)return a.NextResponse.json({success:!0,message:"No pending files to process",processed:0});console.log(`[PROCESS-FILE] Found ${s.length} pending file(s) to process`);let c=[];for(let e of(l.default.join(process.cwd(),"public","uploads","documents"),s))try{if(!e.doc1){console.log(`[PROCESS-FILE] File ${e.id} has no doc1 path, skipping`);continue}let t=l.default.join(process.cwd(),"public",e.doc1);if(!(0,d.existsSync)(t)){console.error(`[PROCESS-FILE] File not found: ${t}`),await n.prisma.fileList.update({where:{id:e.id},data:{parsing_status:"failed",parsing_error:`File not found: ${t}`}}),c.push({fileId:e.id,success:!1,error:"File not found"});continue}console.log(`[PROCESS-FILE] Processing file ${e.id}: ${e.title}`);let r=await (0,o.processFileParsing)(e.id,t,"llamaparse");r.success?c.push({fileId:e.id,success:!0}):c.push({fileId:e.id,success:!1,error:r.error})}catch(r){console.error(`[PROCESS-FILE] Error processing file ${e.id}:`,r);let t=r instanceof Error?r.message:"Unknown error";await n.prisma.fileList.update({where:{id:e.id},data:{parsing_status:"failed",parsing_error:t}}),c.push({fileId:e.id,success:!1,error:t})}let u=c.filter(e=>e.success).length,p=c.filter(e=>!e.success).length;return a.NextResponse.json({success:!0,message:`Processed ${u} file(s) successfully, ${p} failed`,processed:c.length,results:c})}catch(e){return console.error("[PROCESS-FILE] Error:",e),a.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function p(e){try{let{searchParams:t}=new URL(e.url),r=t.get("fileId");if(r){let e=await n.prisma.fileList.findUnique({where:{id:parseInt(r,10)},select:{id:!0,parsing_status:!0,parsing_error:!0,parsed_at:!0}});if(!e)return a.NextResponse.json({error:"File not found"},{status:404});return a.NextResponse.json({fileId:e.id,status:e.parsing_status,error:e.parsing_error,parsedAt:e.parsed_at})}{let[e,t,r,i]=await Promise.all([n.prisma.fileList.count({where:{parsing_status:"pending"}}),n.prisma.fileList.count({where:{parsing_status:"processing"}}),n.prisma.fileList.count({where:{parsing_status:"completed"}}),n.prisma.fileList.count({where:{parsing_status:"failed"}})]);return a.NextResponse.json({pending:e,processing:t,completed:r,failed:i,total:e+t+r+i})}}catch(e){return console.error("[PROCESS-FILE] GET Error:",e),a.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}[o]=c.then?(await c)():c,e.s(["GET",()=>p,"POST",()=>u,"runtime",0,"nodejs"]),r()}catch(e){r(e)}},!1),47985,e=>e.a(async(t,r)=>{try{var a=e.i(747909),i=e.i(174017),s=e.i(996250),n=e.i(759756),o=e.i(561916),l=e.i(114444),d=e.i(837092),c=e.i(869741),u=e.i(316795),p=e.i(487718),f=e.i(995169),g=e.i(47587),h=e.i(666012),m=e.i(570101),w=e.i(626937),E=e.i(10372),R=e.i(193695);e.i(52474);var x=e.i(257297),y=e.i(626769),S=t([y]);[y]=S.then?(await S)():S;let _=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/process-file/route",pathname:"/api/process-file",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/process-file/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:v,workUnitAsyncStorage:C,serverHooks:A}=_;function P(){return(0,s.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:C})}async function I(e,t,r){_.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/process-file/route";a=a.replace(/\/index$/,"")||"/";let s=await _.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:S,nextConfig:P,parsedUrl:I,isDraftMode:v,prerenderManifest:C,routerServerContext:A,isOnDemandRevalidate:$,revalidateOnlyGenerated:L,resolvedPathname:N,clientReferenceManifest:b,serverActionsManifest:F}=s,O=(0,c.normalizeAppPath)(a),T=!!(C.dynamicRoutes[O]||C.routes[N]),j=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,I,!1):t.end("This page could not be found"),null);if(T&&!v){let e=!!C.routes[N],t=C.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(P.experimental.adapterPath)return await j();throw new R.NoFallbackError}}let M=null;!T||_.isDev||v||(M=N,M="/index"===M?"/":M);let U=!0===_.isDev||!T,k=T&&!U;F&&b&&(0,l.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:b,serverActionsManifest:F,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:F})});let G=e.method||"GET",D=(0,o.getTracer)(),H=D.getActiveScopeSpan(),q={params:S,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!P.experimental.authInterrupts},cacheComponents:!!P.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:P.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>_.onRequestError(e,t,a,A)},sharedContext:{buildId:y}},B=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let s=async e=>_.handle(V,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${G} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${G} ${a}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var o,d;let c=async({previousCacheEntry:i})=>{try{if(!l&&$&&L&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(n);e.fetchMetrics=q.renderOpts.fetchMetrics;let o=q.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let d=q.renderOpts.collectedTags;if(!T)return await (0,h.sendResponse)(B,K,a,q.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[E.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,i=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:$})},A),t}},u=await _.handleResponse({req:e,nextConfig:P,cacheKey:M,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:$,revalidateOnlyGenerated:L,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!T)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",$?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&T||p.delete(E.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,w.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(B,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};H?await d(H):await D.withPropagatedContext(e.headers,()=>D.trace(f.BaseServerSpan.handleRequest,{spanName:`${G} ${a}`,kind:o.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},d))}catch(t){if(t instanceof R.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:$})}),T)throw t;return await (0,h.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>P,"routeModule",()=>_,"serverHooks",()=>A,"workAsyncStorage",()=>v,"workUnitAsyncStorage",()=>C]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_71271267._.js.map