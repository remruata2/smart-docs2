module.exports=[925699,e=>e.a(async(t,r)=>{try{var s=e.i(89171),a=e.i(757660),n=e.i(856292),o=e.i(946502),i=e.i(79832),u=e.i(341890),l=e.i(249526),d=e.i(219166),c=e.i(237295),p=e.i(660724),h=t([o]);async function g(e){try{let t=await (0,a.getServerSession)(n.authOptions);if(!t?.user)return s.NextResponse.json({error:"Authentication required"},{status:401});let r=t.user.role,h=parseInt(t.user.id);if(!(0,i.isAdmin)(r)){let e=await (0,d.enforceUsageLimit)(p.UsageType.chat_message,h);if(!e.success)return s.NextResponse.json({error:e.error,limitExceeded:!0},{status:e.status})}let g=t.user.email||t.user.id||"unknown",m=await u.chatRateLimiter.check(g);if(!m.allowed)return s.NextResponse.json({error:`Rate limit exceeded. You can make ${m.remaining} more requests. Try again in ${Math.ceil(m.resetIn/1e3)} seconds.`,errorCode:"RATE_LIMIT_EXCEEDED",resetAt:m.resetAt},{status:429});let y=await e.json(),{message:R,provider:f,model:E,keyId:v,stream:C,boardId:w,subjectId:A,chapterId:N}=y,x=y.conversationHistory;if(!R||"string"!=typeof R)return s.NextResponse.json({error:"Message is required and must be a string"},{status:400});if(0===R.trim().length)return s.NextResponse.json({error:"Message cannot be empty"},{status:400});if(R.length>1e3)return s.NextResponse.json({error:"Message is too long (max 1000 characters)"},{status:400});let T=(0,l.sanitizeAIInput)(R,1e3);T.removedPatterns.length>0&&console.warn(`[SECURITY] Sanitized input for user ${g}. Removed patterns:`,T.removedPatterns);let S=T.sanitized;if(x){let e=(0,l.validateConversationHistory)(x,50,1e3);if(!e.valid)return s.NextResponse.json({error:e.error},{status:400});x=e.sanitized}let I={};if(f){if("gemini"!==f)return s.NextResponse.json({error:"Unsupported provider. Currently only 'gemini' is supported."},{status:400});I.provider=f}if(E&&"string"==typeof E&&(I.model=E),void 0!==v){let e=Number(v);if(!Number.isFinite(e))return s.NextResponse.json({error:"keyId must be a number"},{status:400});I.keyId=e}let M={boardId:w||"CBSE"};if(A&&(M.subjectId=Number(A)),N&&(M.chapterId=Number(N)),console.log(`[ADMIN CHAT] User ${t.user.email} asked a question (length: ${S.length})`),C){console.log("[ADMIN CHAT] Using streaming mode");let e=new TextEncoder,t=new ReadableStream({async start(t){try{let s=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a={},n=[],u={};for await(let r of(0,o.processChatMessageEnhancedStream)(S,x||[],void 0,!0,I,M))if("metadata"===r.type){a={searchQuery:r.searchQuery,searchMethod:r.searchMethod,queryType:r.queryType,analysisUsed:r.analysisUsed,stats:r.stats};let s=JSON.stringify({type:"metadata",...a});t.enqueue(e.encode(`data: ${s}

`))}else if("progress"===r.type){let s=JSON.stringify({type:"progress",progress:r.progress});t.enqueue(e.encode(`data: ${s}

`))}else if("token"===r.type){let s=JSON.stringify({type:"token",text:r.text});t.enqueue(e.encode(`data: ${s}

`))}else if("sources"===r.type){n=r.sources||[];let s=JSON.stringify({type:"sources",sources:n});t.enqueue(e.encode(`data: ${s}

`))}else if("done"===r.type){u=r.tokenCount||{};let a=JSON.stringify({type:"done",tokenCount:u,messageId:s});t.enqueue(e.encode(`data: ${a}

`))}(0,i.isAdmin)(r)||await (0,c.trackUsage)(h,p.UsageType.chat_message),t.close()}catch(s){console.error("[ADMIN CHAT] Streaming error:",s);let r=JSON.stringify({type:"error",error:"Failed to process your question. Please try again."});t.enqueue(e.encode(`data: ${r}

`)),t.close()}}});return new s.NextResponse(t,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}{let e=await (0,o.processChatMessageEnhanced)(S,x||[],void 0,!0,I,M),t={id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,role:"assistant",content:e.response,timestamp:new Date,sources:e.sources,tokenCount:e.tokenCount};return console.log(`[ADMIN CHAT] Response generated with ${e.sources.length} sources`),(0,i.isAdmin)(r)||await (0,c.trackUsage)(h,p.UsageType.chat_message),s.NextResponse.json({success:!0,message:t,sources:e.sources,searchQuery:e.searchQuery,searchMethod:e.searchMethod,queryType:e.queryType,analysisUsed:e.analysisUsed,timestamp:new Date().toISOString()})}}catch(e){if(console.error("[ADMIN CHAT] Error processing chat message:",e),"RATE_LIMIT_EXCEEDED"===e.message)return s.NextResponse.json({success:!1,error:"You are asking too fast, please try again after some time.",errorCode:"RATE_LIMIT_EXCEEDED"},{status:429});return e instanceof Error&&e.message,s.NextResponse.json({success:!1,error:"Failed to process your question. Please try again.",details:void 0},{status:500})}}async function m(e){try{let e=await (0,a.getServerSession)(n.authOptions);if(!e?.user)return s.NextResponse.json({error:"Authentication required"},{status:401});let t=e.user.role;if(!(0,i.isAdmin)(t))return s.NextResponse.json({error:"Admin privileges required"},{status:403});return s.NextResponse.json({success:!0,message:"Zirna Chat API is available",user:e.user.email,timestamp:new Date().toISOString()})}catch(e){return console.error("[ADMIN CHAT] Error in GET endpoint:",e),s.NextResponse.json({success:!1,error:"API endpoint error"},{status:500})}}[o]=h.then?(await h)():h,e.s(["GET",()=>m,"POST",()=>g]),r()}catch(e){r(e)}},!1),923690,e=>e.a(async(t,r)=>{try{var s=e.i(747909),a=e.i(174017),n=e.i(996250),o=e.i(759756),i=e.i(561916),u=e.i(114444),l=e.i(837092),d=e.i(869741),c=e.i(316795),p=e.i(487718),h=e.i(995169),g=e.i(47587),m=e.i(666012),y=e.i(570101),R=e.i(626937),f=e.i(10372),E=e.i(193695);e.i(52474);var v=e.i(257297),C=e.i(925699),w=t([C]);[C]=w.then?(await w)():w;let x=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/admin/chat/route",pathname:"/api/admin/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/chat/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:T,workUnitAsyncStorage:S,serverHooks:I}=x;function A(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:S})}async function N(e,t,r){x.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/admin/chat/route";s=s.replace(/\/index$/,"")||"/";let n=await x.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:C,params:w,nextConfig:A,parsedUrl:N,isDraftMode:T,prerenderManifest:S,routerServerContext:I,isOnDemandRevalidate:M,revalidateOnlyGenerated:b,resolvedPathname:_,clientReferenceManifest:q,serverActionsManifest:O}=n,D=(0,d.normalizeAppPath)(s),P=!!(S.dynamicRoutes[D]||S.routes[_]),U=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,N,!1):t.end("This page could not be found"),null);if(P&&!T){let e=!!S.routes[_],t=S.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await U();throw new E.NoFallbackError}}let k=null;!P||x.isDev||T||(k=_,k="/index"===k?"/":k);let j=!0===x.isDev||!P,H=P&&!j;O&&q&&(0,u.setReferenceManifestsSingleton)({page:s,clientReferenceManifest:q,serverActionsManifest:O,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:O})});let $=e.method||"GET",F=(0,i.getTracer)(),L=F.getActiveScopeSpan(),K={params:w,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>x.onRequestError(e,t,s,I)},sharedContext:{buildId:C}},B=new c.NodeNextRequest(e),J=new c.NodeNextResponse(t),X=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let n=async e=>x.handle(X,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${s}`)}),u=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var i,l;let d=async({previousCacheEntry:a})=>{try{if(!u&&M&&b&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(o);e.fetchMetrics=K.renderOpts.fetchMetrics;let i=K.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let l=K.renderOpts.collectedTags;if(!P)return await (0,m.sendResponse)(B,J,s,K.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:M})},I),t}},c=await x.handleResponse({req:e,nextConfig:A,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:M,revalidateOnlyGenerated:b,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:u});if(!P)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",M?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,y.fromNodeOutgoingHttpHeaders)(c.value.headers);return u&&P||p.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,R.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(B,J,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};L?await l(L):await F.withPropagatedContext(e.headers,()=>F.trace(h.BaseServerSpan.handleRequest,{spanName:`${$} ${s}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof E.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:M})}),P)throw t;return await (0,m.sendResponse)(B,J,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>A,"routeModule",()=>x,"serverHooks",()=>I,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>S]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_77cc65fd._.js.map