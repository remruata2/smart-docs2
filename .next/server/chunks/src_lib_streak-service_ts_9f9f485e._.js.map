{"version":3,"sources":["../../../src/lib/streak-service.ts"],"sourcesContent":["import { prisma } from \"@/lib/prisma\";\n\nexport async function calculateStreak(userId: number): Promise<number> {\n    const userPoints = await prisma.userPoints.findMany({\n        where: { user_id: userId },\n        select: { created_at: true },\n        orderBy: { created_at: 'desc' }\n    });\n\n    if (userPoints.length === 0) return 0;\n\n    // Get all unique dates with activity\n    const activityDates = Array.from(new Set(\n        userPoints.map(p => new Date(p.created_at).toISOString().split('T')[0])\n    )).sort().reverse(); // Newest first\n\n    const today = new Date().toISOString().split('T')[0];\n    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];\n\n    // Check if active today or yesterday to keep streak alive\n    if (!activityDates.includes(today) && !activityDates.includes(yesterday)) {\n        return 0;\n    }\n\n    let currentStreak = 1;\n\n    // Iterate and check if dates are consecutive\n    for (let i = 0; i < activityDates.length - 1; i++) {\n        const current = new Date(activityDates[i]);\n        const next = new Date(activityDates[i + 1]);\n\n        const diffTime = Math.abs(current.getTime() - next.getTime());\n        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n\n        if (diffDays === 1) {\n            currentStreak++;\n        } else {\n            break;\n        }\n    }\n\n    return currentStreak;\n}\n\nexport async function checkAndAwardBadges(userId: number, currentStreak: number) {\n    // Find all active badges that match the current streak\n    // We award badges for streaks <= currentStreak that haven't been awarded yet\n    // Actually, usually you award for exact match or milestones. \n    // Let's award for any milestone <= currentStreak that user doesn't have.\n\n    const eligibleBadges = await prisma.streakBadge.findMany({\n        where: {\n            is_active: true,\n            min_streak: { lte: currentStreak }\n        }\n    });\n\n    for (const badge of eligibleBadges) {\n        // Check if user already has this badge\n        const existingBadge = await prisma.userBadge.findUnique({\n            where: {\n                user_id_badge_id: {\n                    user_id: userId,\n                    badge_id: badge.id\n                }\n            }\n        });\n\n        if (!existingBadge) {\n            // Award badge\n            await prisma.userBadge.create({\n                data: {\n                    user_id: userId,\n                    badge_id: badge.id\n                }\n            });\n\n            // Optionally create a notification or user point event for earning a badge\n            // For now, just logging\n            console.log(`Awarded badge ${badge.name} to user ${userId}`);\n        }\n    }\n}\n"],"names":[],"mappings":"wCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QAEO,eAAe,EAAgB,CAAc,EAChD,IAAM,EAAa,MAAM,EAAA,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAChD,MAAO,CAAE,QAAS,CAAO,EACzB,OAAQ,CAAE,YAAY,CAAK,EAC3B,QAAS,CAAE,WAAY,MAAO,CAClC,GAEA,GAAI,AAAsB,MAAX,MAAM,CAAQ,OAAO,EAGpC,IAAM,EAAgB,MAAM,IAAI,CAAC,IAAI,IACjC,EAAW,GAAG,CAAC,GAAK,IAAI,KAAK,EAAE,UAAU,EAAE,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,IACvE,IAAI,GAAG,OAAO,GAEX,CAFe,CAEP,IAAI,OAAO,GAFW,QAEA,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAC9C,EAAY,IAAI,KAAK,KAAK,GAAG,GAAK,OAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAG7E,GAAI,CAAC,EAAc,QAAQ,CAAC,IAAU,CAAC,EAAc,QAAQ,CAAC,GAC1D,OAAO,EAGX,AAJ0E,IAItE,EAAgB,EAGpB,IAAK,IAAI,EAAI,EAAG,EAAI,EAAc,MAAM,CAAG,EAAG,IAAK,CAC/C,IAAM,EAAU,IAAI,KAAK,CAAa,CAAC,EAAE,EACnC,EAAO,IAAI,KAAK,CAAa,CAAC,EAAI,EAAE,EAK1C,GAAI,AAAa,GAAG,CAFH,KAAK,IAAI,CADT,AACU,KADL,GAAG,CAAC,EACY,AADJ,OAAO,GAAK,EAAK,OAAO,IACnB,OAAO,AAG1C,KAH+C,IAK/C,CALoD,EAAE,EAO9D,CAEA,OAAO,CACX,CAEO,eAAe,EAAoB,CAAc,CAAE,CAAqB,EAa3E,IAAK,IAAM,KAPY,IAOH,EAPS,EAAA,MAAM,CAAC,IAOA,OAPW,CAAC,QAAQ,CAAC,CACrD,MAAO,CACH,WAAW,EACX,WAAY,CAAE,IAAK,CAAc,CACrC,CACJ,EAAA,EAI0B,MAAM,EAAA,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,CACpD,MAAO,CACH,iBAAkB,CACd,QAAS,EACT,SAAU,EAAM,EAAE,AACtB,CACJ,CACJ,KAII,MAAM,EAAA,MAAM,CAAC,SAAS,CAAC,MAAM,CAAC,CAC1B,KAAM,CACF,QAAS,EACT,SAAU,EAAM,EAAE,AACtB,CACJ,GAIA,QAAQ,GAAG,CAAC,CAAC,cAAc,EAAE,EAAM,IAAI,CAAC,SAAS,EAAE,EAAA,CAAQ,EAGvE"}