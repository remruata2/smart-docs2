{"version":3,"sources":["../../../../src/lib/semantic-vector.ts","turbopack:///[project]/node_modules/openid-client/package.json","../../../../src/lib/db.ts","../../../../node_modules/next/src/server/web/spec-extension/cookies.ts","../../../../src/lib/prisma.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../.next-internal/server/app/app/files/%5Bid%5D/edit/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["// semantic-vector.ts\nimport { pipeline } from \"@xenova/transformers\";\nimport { db as prisma } from \"./db\";\n\n// Define the model we want to use.\n// 'Xenova/all-MiniLM-L6-v2' is standard for RAG: fast, small (23MB), and accurate.\nconst EMBEDDING_MODEL = \"Xenova/all-MiniLM-L6-v2\";\n\nexport class SemanticVectorService {\n\t// Singleton instance of the embedder pipeline to avoid reloading model on every call\n\tprivate static embedder: any = null;\n\n\t/**\n\t * Initialize the local embedding pipeline.\n\t * This downloads the model files (once) and caches them.\n\t */\n\tstatic async initialize() {\n\t\tif (!this.embedder) {\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Initializing local embedder model: ${EMBEDDING_MODEL}...`\n\t\t\t);\n\t\t\tthis.embedder = await pipeline(\"feature-extraction\", EMBEDDING_MODEL);\n\t\t\tconsole.log(\"[SEMANTIC] Embedder initialized successfully\");\n\t\t}\n\t}\n\n\t/**\n\t * Generates a vector embedding locally using Transformers.js\n\t * No API limits, no costs.\n\t */\n\tstatic async generateEmbedding(text: string): Promise<number[]> {\n\t\tawait this.initialize();\n\n\t\tif (!text || !text.trim()) {\n\t\t\tthrow new Error(\"Text is required for embedding generation\");\n\t\t}\n\n\t\t// 1. Pre-process text:\n\t\t// Replace newlines to keep semantic meaning consistent and trim\n\t\tconst cleanedText = text.replace(/\\n+/g, \" \").trim();\n\n\t\t// 2. Truncate text to avoid model limits (512 tokens approx ~2000 chars)\n\t\t// We truncate to 2000 characters to be safe.\n\t\t// For full document search, you should ideally chunk the document and average the vectors,\n\t\t// but for a simple file-level vector, truncating the first 2000 chars (header + summary) works well.\n\t\tconst truncatedText = cleanedText.substring(0, 2000);\n\n\t\ttry {\n\t\t\t// 3. Run inference\n\t\t\tconst result = await this.embedder(truncatedText, {\n\t\t\t\tpooling: \"mean\", // Average the token vectors to get one sentence vector\n\t\t\t\tnormalize: true, // Important for cosine similarity\n\t\t\t});\n\n\t\t\t// 4. Convert Float32Array to regular number array\n\t\t\treturn Array.from(result.data);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[SEMANTIC] Error generating embedding:\", error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Updates the semantic vector for a specific file.\n\t * @deprecated This function references the old file_list table. Use chapter-processor.ts for chapter chunks instead.\n\t */\n\tstatic async updateSemanticVector(fileId: number) {\n\t\ttry {\n\t\t\tconst file = await prisma.fileList.findUnique({\n\t\t\t\twhere: { id: fileId },\n\t\t\t\tselect: { title: true, category: true, note: true },\n\t\t\t});\n\n\t\t\tif (!file) {\n\t\t\t\tthrow new Error(`File with ID ${fileId} not found`);\n\t\t\t}\n\n\t\t\t// Combine fields.\n\t\t\t// Tip: Put the most important keywords (Title/Category) FIRST\n\t\t\t// because truncation happens at the end.\n\t\t\tconst textToEmbed = `Title: ${file.title}. Category: ${file.category\n\t\t\t\t}. Content: ${file.note || \"\"}`;\n\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Generating vector for file ${fileId} (${textToEmbed.length} chars)...`\n\t\t\t);\n\n\t\t\tconst embedding = await this.generateEmbedding(textToEmbed);\n\n\t\t\t// Update DB using raw query for pgvector compatibility\n\t\t\tawait prisma.$executeRaw`\n\t\t\t\tUPDATE file_list\n\t\t\t\tSET semantic_vector = ${JSON.stringify(embedding)}::vector\n\t\t\t\tWHERE id = ${fileId}\n\t\t\t`;\n\n\t\t\tconsole.log(`[SEMANTIC] Successfully updated vector for file ${fileId}`);\n\t\t} catch (error) {\n\t\t\tconsole.error(\n\t\t\t\t`[SEMANTIC] Failed to update vector for file ${fileId}:`,\n\t\t\t\terror\n\t\t\t);\n\t\t\t// Don't throw here if this is part of a background batch job, just log it.\n\t\t\t// throw error;\n\t\t}\n\t}\n\n\t/**\n\t * Generate semantic vectors for file chunks\n\t * @deprecated This function references the old file_chunks table. Use chapter-processor.ts for chapter chunks instead.\n\t */\n\tstatic async generateChunkVectors(fileId: number) {\n\t\ttry {\n\t\t\t// Get all chunks for this file\n\t\t\tconst chunks = await prisma.fileChunk.findMany({\n\t\t\t\twhere: { file_id: fileId },\n\t\t\t\tselect: { id: true, content: true },\n\t\t\t});\n\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Generating vectors for ${chunks.length} chunks of file ${fileId}...`\n\t\t\t);\n\n\t\t\tfor (const chunk of chunks) {\n\t\t\t\ttry {\n\t\t\t\t\tconst embedding = await this.generateEmbedding(chunk.content);\n\n\t\t\t\t\t// Update chunk's semantic vector\n\t\t\t\t\tawait prisma.$executeRaw`\n\t\t\t\t\t\tUPDATE file_chunks\n\t\t\t\t\t\tSET semantic_vector = ${JSON.stringify(embedding)}::vector\n\t\t\t\t\t\tWHERE id = ${chunk.id}\n\t\t\t\t\t`;\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t`[SEMANTIC] Failed to generate vector for chunk ${chunk.id}:`,\n\t\t\t\t\t\terr\n\t\t\t\t\t);\n\t\t\t\t\t// Continue with other chunks\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Successfully updated vectors for file ${fileId} chunks`\n\t\t\t);\n\t\t} catch (error) {\n\t\t\tconsole.error(\n\t\t\t\t`[SEMANTIC] Failed to generate chunk vectors for file ${fileId}:`,\n\t\t\t\terror\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Batch/Repair function: Find all files missing vectors and generate them.\n\t * @deprecated This function references the old file_list table. Use updateSearchVectors() in ai-service-enhanced.ts for chapter chunks instead.\n\t */\n\tstatic async batchUpdateSemanticVectors() {\n\t\tconsole.log(\"[SEMANTIC] Starting batch update for missing vectors...\");\n\n\t\t// Find IDs where vector is NULL\n\t\tconst records = await prisma.$queryRaw<{ id: number }[]>`\n\t\t\tSELECT id FROM file_list WHERE semantic_vector IS NULL\n\t\t`;\n\n\t\tconsole.log(`[SEMANTIC] Found ${records.length} records to update.`);\n\n\t\tfor (const record of records) {\n\t\t\tawait this.updateSemanticVector(record.id);\n\t\t}\n\n\t\tconsole.log(\"[SEMANTIC] Batch update completed.\");\n\t}\n}\n","{\"name\":\"openid-client\",\"version\":\"5.7.1\",\"description\":\"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs\",\"keywords\":[\"auth\",\"authentication\",\"basic\",\"certified\",\"client\",\"connect\",\"dynamic\",\"electron\",\"hybrid\",\"identity\",\"implicit\",\"oauth\",\"oauth2\",\"oidc\",\"openid\",\"passport\",\"relying party\",\"strategy\"],\"homepage\":\"https://github.com/panva/openid-client\",\"repository\":\"panva/openid-client\",\"funding\":{\"url\":\"https://github.com/sponsors/panva\"},\"license\":\"MIT\",\"author\":\"Filip Skokan <panva.ip@gmail.com>\",\"exports\":{\"types\":\"./types/index.d.ts\",\"import\":\"./lib/index.mjs\",\"require\":\"./lib/index.js\"},\"main\":\"./lib/index.js\",\"types\":\"./types/index.d.ts\",\"files\":[\"lib\",\"types/index.d.ts\"],\"scripts\":{\"format\":\"npx prettier --loglevel silent --write ./lib ./test ./certification ./types\",\"test\":\"mocha test/**/*.test.js\"},\"dependencies\":{\"jose\":\"^4.15.9\",\"lru-cache\":\"^6.0.0\",\"object-hash\":\"^2.2.0\",\"oidc-token-hash\":\"^5.0.3\"},\"devDependencies\":{\"@types/node\":\"^16.18.106\",\"@types/passport\":\"^1.0.16\",\"base64url\":\"^3.0.1\",\"chai\":\"^4.5.0\",\"mocha\":\"^10.7.3\",\"nock\":\"^13.5.5\",\"prettier\":\"^2.8.8\",\"readable-mock-req\":\"^0.2.2\",\"sinon\":\"^9.2.4\",\"timekeeper\":\"^2.3.1\"},\"standard-version\":{\"scripts\":{\"postchangelog\":\"sed -i '' -e 's/### \\\\[/## [/g' CHANGELOG.md\"},\"types\":[{\"type\":\"feat\",\"section\":\"Features\"},{\"type\":\"fix\",\"section\":\"Fixes\"},{\"type\":\"chore\",\"hidden\":true},{\"type\":\"docs\",\"hidden\":true},{\"type\":\"style\",\"hidden\":true},{\"type\":\"refactor\",\"section\":\"Refactor\",\"hidden\":false},{\"type\":\"perf\",\"section\":\"Performance\",\"hidden\":false},{\"type\":\"test\",\"hidden\":true}]}}","import { PrismaClient } from '../generated/prisma';\n\n// Define the global type for PrismaClient\ndeclare global {\n  var prisma: PrismaClient | undefined;\n}\n\n// PrismaClient is attached to the `global` object in development to prevent\n// exhausting your database connection limit.\nexport const db = global.prisma || new PrismaClient();\n\n// In development, keep the connection alive between hot reloads\nif (process.env.NODE_ENV !== 'production') global.prisma = db;\n","export {\n  RequestCookies,\n  ResponseCookies,\n  stringifyCookie,\n} from 'next/dist/compiled/@edge-runtime/cookies'\n","import { db } from \"./db\";\n\nexport const prisma = db;\nexport default prisma;\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","export {getCategoryListItems as '001ee4775408d012df34af58446b70b327f1542b72'} from 'ACTIONS_MODULE0'\nexport {getFilterOptions as '00570227622e84abc249b84fe60ac8bfcd3325c716'} from 'ACTIONS_MODULE0'\nexport {createFileAction as '4056b319635b72e6579124176168dc0ffec5957469'} from 'ACTIONS_MODULE0'\nexport {getFileById as '408adab7fe432dc379a3e3f2a49120b9c0c14c13c4'} from 'ACTIONS_MODULE0'\nexport {retryFileParsingAction as '409d9c2b9f28b96fd8d5b94c813d761c9962714a32'} from 'ACTIONS_MODULE0'\nexport {getFilesPaginated as '40a2f435e8b637bcef17415b0917d7c85c05555738'} from 'ACTIONS_MODULE0'\nexport {deleteFileAction as '40b8244abf8819b75d96dd4dc517bdbc92733812cb'} from 'ACTIONS_MODULE0'\nexport {updateFileAction as '6084e702f4bf89558f52ec076dc20196ff3abc2cb8'} from 'ACTIONS_MODULE0'\n"],"names":["RequestCookies","ResponseCookies","stringifyCookie","registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[3,5,6]}