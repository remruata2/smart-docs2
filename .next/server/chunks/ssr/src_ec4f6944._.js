module.exports=[784933,a=>{"use strict";var b=a.i(432697);let c={documents:{mimeTypes:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","text/markdown"],extensions:["pdf","doc","docx","txt","md"]},images:{mimeTypes:["image/jpeg","image/png","image/gif","image/webp"],extensions:["jpg","jpeg","png","gif","webp"]}};async function d(a,e="documents",f){let g=c[e],h=await (0,b.fileTypeFromBuffer)(a);if(!h){let b=f?.split(".").pop()?.toLowerCase();return b&&["txt","md"].includes(b)&&function(a){let b=Math.min(a.length,8192);for(let c=0;c<b;c++)if(0===a[c])return!1;return!0}(a)?{valid:!0,detectedType:{mime:"md"===b?"text/markdown":"text/plain",ext:b}}:{valid:!1,error:"Unable to determine file type. The file may be corrupted or empty."}}if(!g.mimeTypes.includes(h.mime))return{valid:!1,error:`File type "${h.mime}" is not allowed. Allowed types: ${g.extensions.join(", ")}`,detectedType:{mime:h.mime,ext:h.ext}};if(f){let a=f.split(".").pop()?.toLowerCase();if(a&&!g.extensions.includes(a))return{valid:!1,error:`File extension ".${a}" is not allowed. Detected type: ${h.mime}`,detectedType:{mime:h.mime,ext:h.ext}}}return{valid:!0,detectedType:{mime:h.mime,ext:h.ext}}}function e(a,b=0x3200000){if(a>b){let a=Math.round(b/1024/1024);return{valid:!1,error:`File size exceeds maximum allowed size of ${a}MB`}}return{valid:!0}}a.s(["MAX_FILE_SIZE",0,0x3200000,"validateFileSize",()=>e,"validateFileType",()=>d])},198720,a=>a.a(async(b,c)=>{try{var d=a.i(137936),e=a.i(766518),f=a.i(794431),g=a.i(547256),h=a.i(591727),i=a.i(983111),j=a.i(924868),k=a.i(814747),l=a.i(522734),m=a.i(934304),n=a.i(784933),o=a.i(713095),p=b([m]);[m]=p.then?(await p)():p;let z=k.default.join(process.cwd(),"public","uploads","documents");function q(){(0,l.existsSync)(z)||(0,l.mkdirSync)(z,{recursive:!0})}async function r(a={}){let b=await (0,f.getServerSession)(g.authOptions);if(!b?.user?.id)return{items:[],total:0,page:1,pageSize:50};let c=parseInt(b.user.id),d=Math.max(1,a.page??1),h=Math.min(200,Math.max(1,a.pageSize??50)),i={user_id:c};if(a.category&&""!==a.category.trim()&&(i.category=a.category),a.year&&Number.isFinite(a.year)){let b=a.year,c=new Date(Date.UTC(b,0,1)),d=new Date(Date.UTC(b+1,0,1));i.entry_date_real={gte:c,lt:d}}if(a.q&&""!==a.q.trim()){let b=a.q.trim();i.OR=[{title:{contains:b,mode:"insensitive"}},{category:{contains:b,mode:"insensitive"}}]}try{let[a,b]=await Promise.all([e.prisma.fileList.count({where:i}),e.prisma.fileList.findMany({where:i,orderBy:[{entry_date_real:"desc"},{id:"desc"}],select:{id:!0,category:!0,title:!0,entry_date_real:!0,created_at:!0,doc1:!0,parsing_status:!0,parsing_error:!0,parsed_at:!0},skip:(d-1)*h,take:h})]);return{items:b.map(a=>({...a,entry_date_real:a.entry_date_real?.toISOString()||null,created_at:a.created_at?.toISOString()||null,parsed_at:a.parsed_at?.toISOString()||null})),total:a,page:d,pageSize:h}}catch(a){throw console.error("Error fetching paginated files:",a),console.error("Error details:",a instanceof Error?a.message:String(a)),console.error("Error stack:",a instanceof Error?a.stack:"No stack"),Error(`Failed to fetch files: ${a instanceof Error?a.message:String(a)}`)}}async function s(){let a=await (0,f.getServerSession)(g.authOptions);if(!a?.user?.id)return{categories:[],years:[]};let b=parseInt(a.user.id);try{let a=(await e.prisma.$queryRaw`
      SELECT DISTINCT category
      FROM file_list
      WHERE category IS NOT NULL AND category <> '' AND user_id = ${b}
      ORDER BY category ASC
    `).map(a=>a.category).filter(a=>"string"==typeof a&&""!==a.trim()),c=(await e.prisma.$queryRaw`
      SELECT DISTINCT EXTRACT(YEAR FROM entry_date_real)::int AS year
      FROM file_list
      WHERE entry_date_real IS NOT NULL AND user_id = ${b}
      ORDER BY year DESC
    `).map(a=>"number"==typeof a.year?a.year:null).filter(a=>null!==a);return{categories:a,years:c}}catch(a){return console.error("Error fetching filter options:",a),{categories:[],years:[]}}}let A=a=>a?a.replace(RegExp("[Image removed - please upload images separately]".replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),"").trim():"",B=i.z.object({category:i.z.string().max(500,{message:"Category must be 500 characters or less"}).optional(),title:i.z.string().max(500,{message:"Title must be 500 characters or less"}).optional(),note:i.z.string().optional(),entry_date:i.z.string().optional().nullable(),content_format:i.z.enum(["html","markdown"]).optional()});async function t(a){let b=await (0,f.getServerSession)(g.authOptions);if(!b?.user?.id)return null;let c=parseInt(b.user.id);try{let b=await e.prisma.fileList.findFirst({where:{id:a,user_id:c},select:{id:!0,category:!0,title:!0,note:!0,content_format:!0,doc1:!0,entry_date:!0,entry_date_real:!0,created_at:!0,updated_at:!0}});if(!b)return null;return{id:b.id,category:b.category,title:b.title,note:b.note,content_format:b.content_format,doc1:b.doc1,entry_date:b.entry_date,entry_date_real:b.entry_date_real?.toISOString().split("T")[0]||"",created_at:b.created_at?.toISOString()||null,updated_at:b.updated_at?.toISOString()||null}}catch(b){throw console.error(`Error fetching file with id ${a}:`,b),Error("Failed to fetch file details.")}}async function u(b){let c=await (0,f.getServerSession)(g.authOptions);if(!c?.user?.id)return{success:!1,error:"Unauthorized"};let d=parseInt(c.user.id),{enforceUsageLimit:i,checkUsageLimit:o}=await a.A(25031),{UsageType:p}=await a.A(262143),r=await o(p.file_upload,d);if(!r.allowed)return{success:!1,error:r.reason||"Usage limit exceeded"};let s=await i(p.file_upload,d);if(!s.success)return{success:!1,error:s.error||"Usage limit exceeded"};q();let t=b.get("doc1"),u=Object.fromEntries(b.entries());t&&0===t.size&&delete u.doc1;let v=B.safeParse(u);if(!v.success)return{success:!1,error:"Validation failed. Please check the fields.",fieldErrors:v.error.flatten().fieldErrors};let w=null,x=A(v.data.note);if(t&&t.size>0)try{let a,b,c=Buffer.from(await t.arrayBuffer()),d=(0,n.validateFileSize)(c.length,n.MAX_FILE_SIZE);if(!d.valid)return{success:!1,error:d.error||"File too large"};let e=await (0,n.validateFileType)(c,"documents",t.name);if(!e.valid)return{success:!1,error:e.error||"Invalid file type"};let f=t.name.replace(/[^a-zA-Z0-9._-]/g,"_"),g=0;do{if(a=Date.now()+"-"+Math.round(1e9*Math.random())+"-"+f,b=k.default.join(z,a),g++,(0,l.existsSync)(b)){if(g>=10)throw Error("Unable to generate unique filename after multiple attempts");await new Promise(a=>setTimeout(a,1));continue}break}while(g<10)await j.default.writeFile(b,c),w=`/uploads/documents/${a}`}catch(a){return console.error("Error uploading file:",a),{success:!1,error:"File upload failed. Please try again."}}let{note:y,entry_date:C,content_format:D,...E}=v.data,{district:F,...G}=E,H=D??(t&&t.size>0?"markdown":"html"),I=null;if(C&&""!==C.trim()){let a=new Date(C);isNaN(a.getTime())||(I=a)}let J=G.title;!J&&t&&t.size>0&&(J=t.name.replace(/\.[^/.]+$/,""));let K=G.category;if(!K||0===K.trim().length)return{success:!1,error:"Category is required",fieldErrors:{category:["Category is required"]}};try{let b=t&&t.size>0?"pending":"completed",c=await e.prisma.$transaction(async c=>{let e=await c.fileList.create({data:{...G,title:J||"Untitled",category:K,note:x,content_format:H,doc1:w,entry_date:C,entry_date_real:I,user_id:d,parsing_status:b,parsed_at:"completed"===b?new Date:null}});await c.$executeRaw`
        UPDATE file_list
        SET search_vector = to_tsvector('english',
          COALESCE('Title: ' || title, '') || ' | ' ||
          COALESCE('Category: ' || category, '') || ' | ' ||
          COALESCE('Content: ' || ${x}, '') || ' | ' ||
          COALESCE(entry_date, '') || ' ' ||
          COALESCE(EXTRACT(YEAR FROM entry_date_real)::text, '')
        )
        WHERE id = ${e.id}
      `;try{let{trackUsage:b}=await a.A(873955),{UsageType:c}=await a.A(262143);await b(d,c.file_upload)}catch(a){console.error("Usage tracking failed:",a)}return e});if("completed"===b)try{await m.SemanticVectorService.updateSemanticVector(c.id)}catch(a){console.error("Semantic vector update failed:",a)}return(0,h.revalidatePath)("/app/files"),{success:!0,message:"File created successfully."}}catch(a){return console.error("Error creating file:",a),{success:!1,error:"Database error: Failed to create file."}}}async function v(a,b){let c=await (0,f.getServerSession)(g.authOptions);if(!c?.user?.id)return{success:!1,error:"Unauthorized"};let d=parseInt(c.user.id);q();let i=b.get("doc1"),o=Object.fromEntries(b.entries());i&&0===i.size&&delete o.doc1;let p=B.safeParse(o);if(!p.success)return{success:!1,error:"Validation failed. Please check the fields.",fieldErrors:p.error.flatten().fieldErrors};let{note:r,entry_date:s,content_format:t,...u}=p.data,v=A(r),w=t??(i&&i.size>0?"markdown":"html"),x=null;if(s&&""!==s.trim()){let a=new Date(s);isNaN(a.getTime())||(x=a)}else""===s&&(x=null);let y={...u,note:v,content_format:w,entry_date:s,entry_date_real:x};if(i&&i.size>0)try{let b=await e.prisma.fileList.findFirst({where:{id:a,user_id:d},select:{doc1:!0}});if(!b)return{success:!1,error:"File not found or unauthorized."};if(b?.doc1){let a=k.default.join(process.cwd(),"public",b.doc1);if((0,l.existsSync)(a))try{await j.default.unlink(a)}catch(b){console.error(`Error deleting old file ${a}:`,b)}}let c=Buffer.from(await i.arrayBuffer()),f=(0,n.validateFileSize)(c.length,n.MAX_FILE_SIZE);if(!f.valid)return{success:!1,error:f.error||"File too large"};let g=await (0,n.validateFileType)(c,"documents",i.name);if(!g.valid)return{success:!1,error:g.error||"Invalid file type"};let h=Date.now()+"-"+Math.round(1e9*Math.random()),m=i.name.replace(/[^a-zA-Z0-9._-]/g,"_"),o=h+"-"+m,p=k.default.join(z,o);await j.default.writeFile(p,c),y.doc1=`/uploads/documents/${o}`,y.note=v}catch(a){return console.error("Error uploading file during update:",a),{success:!1,error:"File upload failed during update. Please try again."}}try{if(!await e.prisma.fileList.findFirst({where:{id:a,user_id:d}}))return{success:!1,error:"File not found or unauthorized."};await e.prisma.fileList.update({where:{id:a},data:y}),await e.prisma.$executeRaw`
      UPDATE file_list
      SET search_vector = to_tsvector('english',
        COALESCE('Title: ' || title, '') || ' | ' ||
        COALESCE('Category: ' || category, '') || ' | ' ||
        COALESCE('Content: ' || ${v}, '') || ' | ' ||
        COALESCE(entry_date, '') || ' ' ||
        COALESCE(EXTRACT(YEAR FROM entry_date_real)::text, '')
      )
      WHERE id = ${a}
    `;try{await m.SemanticVectorService.updateSemanticVector(a)}catch(a){console.error("âŒ Semantic vector update failed:",a)}return(0,h.revalidatePath)("/app/files"),(0,h.revalidatePath)(`/app/files/${a}/edit`),{success:!0,message:"File updated successfully."}}catch(b){return console.error(`Error updating file ${a}:`,b),{success:!1,error:"Database error: Failed to update file."}}}async function w(a){let b=await (0,f.getServerSession)(g.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let c=parseInt(b.user.id);try{let b=await e.prisma.fileList.findFirst({where:{id:a,user_id:c}});if(!b)return{success:!1,error:"File not found or unauthorized."};try{let c=k.default.join(process.cwd(),"public","files",String(a));if((0,l.existsSync)(c)&&(await j.default.rm(c,{recursive:!0,force:!0}),console.log(`[DELETE-FILE] Deleted images directory: ${c}`)),b.doc1){let a=k.default.join(process.cwd(),"public",b.doc1);(0,l.existsSync)(a)&&(await j.default.unlink(a),console.log(`[DELETE-FILE] Deleted document file: ${a}`))}}catch(b){console.error(`[DELETE-FILE] Error deleting files for file ${a}:`,b)}return await e.prisma.fileList.delete({where:{id:a}}),(0,h.revalidatePath)("/app/files"),{success:!0,message:"File deleted successfully."}}catch(a){return console.error("Error deleting file:",a),{success:!1,error:"Database error: Failed to delete file."}}}async function x(a){let b=await (0,f.getServerSession)(g.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let c=parseInt(b.user.id);try{if(!await e.prisma.fileList.findFirst({where:{id:a,user_id:c}}))return{success:!1,error:"File not found or access denied."};return await e.prisma.fileList.update({where:{id:a},data:{parsing_status:"pending",parsing_error:null}}),(0,h.revalidatePath)("/app/files"),{success:!0,message:"File parsing queued for retry. Processing will happen in the background."}}catch(a){return console.error("Error retrying file parsing:",a),{success:!1,error:"Database error: Failed to retry parsing."}}}async function y(){let a=await (0,f.getServerSession)(g.authOptions);if(!a?.user?.id)return[];let b=parseInt(a.user.id);try{return await e.prisma.categoryList.findMany({where:{user_id:b},select:{id:!0,category:!0},orderBy:{category:"asc"}})}catch(a){return console.error("Error fetching category list items:",a),[]}}(0,o.ensureServerEntryExports)([r,s,t,u,v,w,x,y]),(0,d.registerServerReference)(r,"40a2f435e8b637bcef17415b0917d7c85c05555738",null),(0,d.registerServerReference)(s,"00570227622e84abc249b84fe60ac8bfcd3325c716",null),(0,d.registerServerReference)(t,"408adab7fe432dc379a3e3f2a49120b9c0c14c13c4",null),(0,d.registerServerReference)(u,"4056b319635b72e6579124176168dc0ffec5957469",null),(0,d.registerServerReference)(v,"6084e702f4bf89558f52ec076dc20196ff3abc2cb8",null),(0,d.registerServerReference)(w,"40b8244abf8819b75d96dd4dc517bdbc92733812cb",null),(0,d.registerServerReference)(x,"409d9c2b9f28b96fd8d5b94c813d761c9962714a32",null),(0,d.registerServerReference)(y,"001ee4775408d012df34af58446b70b327f1542b72",null),a.s(["createFileAction",()=>u,"deleteFileAction",()=>w,"getCategoryListItems",()=>y,"getFileById",()=>t,"getFilesPaginated",()=>r,"getFilterOptions",()=>s,"retryFileParsingAction",()=>x,"updateFileAction",()=>v]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=src_ec4f6944._.js.map