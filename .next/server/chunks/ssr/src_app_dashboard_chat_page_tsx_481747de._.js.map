{"version":3,"sources":["../../../../src/app/dashboard/chat/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useRef, useEffect, Suspense } from \"react\";\nimport Link from \"next/link\";\nimport { useSearchParams } from \"next/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport {\n\tLoader2,\n\tSend,\n\tBot,\n\tUser,\n\tFileText,\n\tAlertCircle,\n\tMessageSquare,\n\tExternalLink,\n\tCopy,\n\tCheck,\n\tFileDown,\n} from \"lucide-react\";\n// PDF generation removed - using text export instead\nimport { toast } from \"sonner\";\nimport { ChatMessage } from \"@/lib/ai-service-enhanced\";\nimport ReactMarkdown from \"react-markdown\";\nimport remarkGfm from \"remark-gfm\";\nimport ConversationSidebar from \"@/components/ConversationSidebar\";\nimport { SmartChart } from \"@/components/dashboard/SmartChart\";\n\ninterface ChatSource {\n\tid: number;\n\ttitle: string;\n}\n\nfunction DashboardChatPageContent() {\n\tconst [messages, setMessages] = useState<ChatMessage[]>([]);\n\tconst [inputMessage, setInputMessage] = useState(\"\");\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [error, setError] = useState<string | null>(null);\n\n\t// Conversation state\n\tconst [currentConversationId, setCurrentConversationId] = useState<\n\t\tnumber | null\n\t>(null);\n\tconst [conversationTitle, setConversationTitle] =\n\t\tuseState<string>(\"New Conversation\");\n\tconst [sidebarRefreshTrigger, setSidebarRefreshTrigger] = useState(0);\n\n\tconst [model, setModel] = useState<string>(\"gemini-2.5-pro\");\n\tconst [models, setModels] = useState<Array<{ name: string; label: string }>>([\n\t\t{ name: \"gemini-2.5-pro\", label: \"Gemini 2.5 Pro\" },\n\t\t{ name: \"gemini-2.5-flash\", label: \"Gemini 2.5 Flash\" },\n\t]);\n\tconst [modelsLoading, setModelsLoading] = useState<boolean>(false);\n\tconst [lastResponseMeta, setLastResponseMeta] = useState<{\n\t\tqueryType?: string;\n\t\tsearchQuery?: string;\n\t\tanalysisUsed?: boolean;\n\t} | null>(null);\n\tconst [copiedMessageId, setCopiedMessageId] = useState<string | null>(null);\n\t// Track expanded source lists by message ID\n\tconst [expandedSources, setExpandedSources] = useState<\n\t\tRecord<string, boolean>\n\t>({});\n\t// Subject and Chapter filters\n\tconst [subjects, setSubjects] = useState<Array<{ id: number; name: string }>>(\n\t\t[]\n\t);\n\tconst [subjectsLoading, setSubjectsLoading] = useState<boolean>(false);\n\tconst [selectedSubjectId, setSelectedSubjectId] = useState<number | null>(\n\t\tnull\n\t);\n\tconst [selectedSubjectName, setSelectedSubjectName] = useState<string>(\"\");\n\n\tconst [chapters, setChapters] = useState<\n\t\tArray<{ id: string; title: string; chapter_number: number | null }>\n\t>([]);\n\tconst [chaptersLoading, setChaptersLoading] = useState<boolean>(false);\n\tconst [selectedChapterId, setSelectedChapterId] = useState<string | null>(\n\t\tnull\n\t);\n\tconst [selectedChapterTitle, setSelectedChapterTitle] = useState<string>(\"\");\n\n\t// Get filters from URL\n\tconst searchParams = useSearchParams();\n\tconst urlSubjectId = searchParams.get(\"subjectId\");\n\tconst urlChapterId = searchParams.get(\"chapterId\");\n\n\t// Load available models for current provider\n\tuseEffect(() => {\n\t\tlet cancelled = false;\n\t\tasync function loadModels() {\n\t\t\ttry {\n\t\t\t\tsetModelsLoading(true);\n\t\t\t\tconst res = await fetch(`/api/dashboard/ai/models?provider=gemini`);\n\t\t\t\tif (!res.ok) throw new Error(\"Failed to load models\");\n\t\t\t\tconst data = await res.json();\n\t\t\t\tif (cancelled) return;\n\t\t\t\tconst list: Array<{ name: string; label: string }> = Array.isArray(\n\t\t\t\t\tdata.models\n\t\t\t\t)\n\t\t\t\t\t? data.models\n\t\t\t\t\t: [];\n\t\t\t\t// Always have at least fallback models\n\t\t\t\tconst finalModels =\n\t\t\t\t\tlist.length > 0\n\t\t\t\t\t\t? list\n\t\t\t\t\t\t: [\n\t\t\t\t\t\t\t\t{ name: \"gemini-2.5-pro\", label: \"Gemini 2.5 Pro\" },\n\t\t\t\t\t\t\t\t{ name: \"gemini-2.5-flash\", label: \"Gemini 2.5 Flash\" },\n\t\t\t\t\t\t  ];\n\t\t\t\tsetModels(finalModels);\n\t\t\t\t// If current model not in list, set to first available\n\t\t\t\tif (\n\t\t\t\t\tfinalModels.length > 0 &&\n\t\t\t\t\t!finalModels.some((m) => m.name === model)\n\t\t\t\t) {\n\t\t\t\t\tsetModel(finalModels[0].name);\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"[DashboardChat] Failed to fetch models\", e);\n\t\t\t\t// Fallback to default models if API fails\n\t\t\t\tif (!cancelled) {\n\t\t\t\t\tconst fallbackModels = [\n\t\t\t\t\t\t{ name: \"gemini-2.5-pro\", label: \"Gemini 2.5 Pro\" },\n\t\t\t\t\t\t{ name: \"gemini-2.5-flash\", label: \"Gemini 2.5 Flash\" },\n\t\t\t\t\t];\n\t\t\t\t\tsetModels(fallbackModels);\n\t\t\t\t\tif (!fallbackModels.some((m) => m.name === model)) {\n\t\t\t\t\t\tsetModel(fallbackModels[0].name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tif (!cancelled) setModelsLoading(false);\n\t\t\t}\n\t\t}\n\t\tloadModels();\n\t\treturn () => {\n\t\t\tcancelled = true;\n\t\t};\n\t}, [model]);\n\n\t// Load available subjects\n\tuseEffect(() => {\n\t\tasync function loadSubjects() {\n\t\t\ttry {\n\t\t\t\tsetSubjectsLoading(true);\n\t\t\t\tconst res = await fetch(\"/api/dashboard/subjects\");\n\t\t\t\tif (!res.ok) throw new Error(\"Failed to load subjects\");\n\t\t\t\tconst data = await res.json();\n\t\t\t\tsetSubjects(data.subjects || []);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"[DashboardChat] Failed to fetch subjects\", e);\n\t\t\t\tsetSubjects([]);\n\t\t\t} finally {\n\t\t\t\tsetSubjectsLoading(false);\n\t\t\t}\n\t\t}\n\t\tloadSubjects();\n\t}, []);\n\n\t// Load chapters when subject is selected\n\tuseEffect(() => {\n\t\tif (!selectedSubjectId) {\n\t\t\tsetChapters([]);\n\t\t\tsetSelectedChapterId(null);\n\t\t\tsetSelectedChapterTitle(\"\");\n\t\t\treturn;\n\t\t}\n\n\t\tasync function loadChapters() {\n\t\t\ttry {\n\t\t\t\tsetChaptersLoading(true);\n\t\t\t\tconst res = await fetch(\n\t\t\t\t\t`/api/dashboard/chapters?subjectId=${selectedSubjectId}`\n\t\t\t\t);\n\t\t\t\tif (!res.ok) throw new Error(\"Failed to load chapters\");\n\t\t\t\tconst data = await res.json();\n\t\t\t\tsetChapters(data.chapters || []);\n\n\t\t\t\t// If URL has chapterId, preselect it\n\t\t\t\tif (urlChapterId && data.chapters) {\n\t\t\t\t\tconst chapter = data.chapters.find((c: any) => c.id === urlChapterId);\n\t\t\t\t\tif (chapter) {\n\t\t\t\t\t\tsetSelectedChapterId(chapter.id);\n\t\t\t\t\t\tsetSelectedChapterTitle(chapter.title);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"[DashboardChat] Failed to fetch chapters\", e);\n\t\t\t\tsetChapters([]);\n\t\t\t} finally {\n\t\t\t\tsetChaptersLoading(false);\n\t\t\t}\n\t\t}\n\t\tloadChapters();\n\t}, [selectedSubjectId, urlChapterId]);\n\n\t// Preselect subject/chapter from URL params on mount\n\tuseEffect(() => {\n\t\tif (urlSubjectId && subjects.length > 0) {\n\t\t\tconst subjectIdNum = parseInt(urlSubjectId, 10);\n\t\t\tif (!isNaN(subjectIdNum)) {\n\t\t\t\tconst subject = subjects.find((s) => s.id === subjectIdNum);\n\t\t\t\tif (subject) {\n\t\t\t\t\tsetSelectedSubjectId(subjectIdNum);\n\t\t\t\t\tsetSelectedSubjectName(subject.name);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}, [urlSubjectId, subjects]);\n\n\tconst scrollAreaRef = useRef<HTMLDivElement>(null);\n\tconst inputRef = useRef<HTMLInputElement>(null);\n\n\t// Initial number of sources to show\n\tconst INITIAL_SOURCES_SHOWN = 15;\n\n\t// Auto-scroll to bottom when new messages arrive\n\tuseEffect(() => {\n\t\tif (scrollAreaRef.current) {\n\t\t\tscrollAreaRef.current.scrollTo({\n\t\t\t\ttop: scrollAreaRef.current.scrollHeight,\n\t\t\t\tbehavior: \"smooth\",\n\t\t\t});\n\t\t}\n\t}, [messages]);\n\n\t// Focus input on mount\n\tuseEffect(() => {\n\t\tinputRef.current?.focus();\n\t}, []);\n\n\t// === CONVERSATION MANAGEMENT FUNCTIONS ===\n\n\t// Generate a title from the first user message\n\tconst generateTitleFromQuery = (query: string): string => {\n\t\t// Clean up the query\n\t\tlet title = query.trim();\n\n\t\t// Remove common prefixes\n\t\ttitle = title.replace(\n\t\t\t/^(show|list|find|get|tell|what|who|when|where|how|can you|please)\\s+/i,\n\t\t\t\"\"\n\t\t);\n\n\t\t// Limit length to 50 characters\n\t\tif (title.length > 50) {\n\t\t\ttitle = title.substring(0, 47) + \"...\";\n\t\t}\n\n\t\t// Capitalize first letter\n\t\tif (title.length > 0) {\n\t\t\ttitle = title.charAt(0).toUpperCase() + title.slice(1);\n\t\t}\n\n\t\t// Fallback if empty\n\t\treturn title || \"New Conversation\";\n\t};\n\n\t// Create a new conversation\n\tconst createNewConversation = async (\n\t\tfirstMessage?: string\n\t): Promise<number> => {\n\t\ttry {\n\t\t\tconst title = firstMessage\n\t\t\t\t? generateTitleFromQuery(firstMessage)\n\t\t\t\t: \"New Conversation\";\n\n\t\t\tconst response = await fetch(\"/api/dashboard/conversations\", {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\tbody: JSON.stringify({ title }),\n\t\t\t});\n\n\t\t\tif (!response.ok) throw new Error(\"Failed to create conversation\");\n\n\t\t\tconst data = await response.json();\n\t\t\treturn data.conversation.id;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error creating conversation:\", error);\n\t\t\ttoast.error(\"Failed to create conversation\");\n\t\t\tthrow error;\n\t\t}\n\t};\n\n\t// Save a message to the current conversation\n\tconst saveMessageToConversation = async (\n\t\tconversationId: number,\n\t\tmessage: {\n\t\t\trole: \"user\" | \"assistant\";\n\t\t\tcontent: string;\n\t\t\tsources?: any[];\n\t\t\ttokenCount?: any;\n\t\t\tmetadata?: any;\n\t\t\tchartData?: any;\n\t\t}\n\t) => {\n\t\ttry {\n\t\t\tconst response = await fetch(\n\t\t\t\t`/api/dashboard/conversations/${conversationId}/messages`,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\t\tbody: JSON.stringify(message),\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tif (!response.ok) throw new Error(\"Failed to save message\");\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error saving message:\", error);\n\t\t\t// Don't show error toast - this is background operation\n\t\t}\n\t};\n\n\t// Generate AI title for conversation after first exchange\n\tconst _generateConversationTitle = async (conversationId: number) => {\n\t\ttry {\n\t\t\tconst response = await fetch(\n\t\t\t\t`/api/dashboard/conversations/${conversationId}/generate-title`,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tif (!response.ok) throw new Error(\"Failed to generate title\");\n\n\t\t\tconst data = await response.json();\n\t\t\tsetConversationTitle(data.title);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error generating title:\", error);\n\t\t\t// Don't show error toast\n\t\t}\n\t};\n\n\t// Load a conversation and its messages\n\tconst loadConversation = async (conversationId: number) => {\n\t\ttry {\n\t\t\tconst response = await fetch(\n\t\t\t\t`/api/dashboard/conversations/${conversationId}`\n\t\t\t);\n\n\t\t\tif (!response.ok) throw new Error(\"Failed to load conversation\");\n\n\t\t\tconst data = await response.json();\n\t\t\tconst conversation = data.conversation;\n\n\t\t\t// Set conversation details\n\t\t\tsetCurrentConversationId(conversation.id);\n\t\t\tsetConversationTitle(conversation.title);\n\n\t\t\t// Load messages\n\t\t\tconst loadedMessages: ChatMessage[] = conversation.messages.map(\n\t\t\t\t(msg: any) => ({\n\t\t\t\t\tid: msg.id.toString(),\n\t\t\t\t\trole: msg.role,\n\t\t\t\t\tcontent: msg.content,\n\t\t\t\t\ttimestamp: new Date(msg.timestamp),\n\t\t\t\t\tsources: msg.sources || [],\n\t\t\t\t\ttokenCount: msg.tokenCount,\n\t\t\t\t\tchartData: msg.metadata?.chartData || null, // Extract chartData from metadata\n\t\t\t\t\t// For assistant messages, always show filters\n\t\t\t\t\tfilters:\n\t\t\t\t\t\tmsg.role === \"assistant\" ? msg.metadata?.filters || {} : undefined,\n\t\t\t\t})\n\t\t\t);\n\n\t\t\tsetMessages(loadedMessages);\n\t\t\tsetError(null);\n\n\t\t\ttoast.success(`Loaded: ${conversation.title}`);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error loading conversation:\", error);\n\t\t\ttoast.error(\"Failed to load conversation\");\n\t\t}\n\t};\n\n\t// Start a new conversation (clear messages, reset state)\n\tconst startNewConversation = () => {\n\t\tsetCurrentConversationId(null);\n\t\tsetConversationTitle(\"New Conversation\");\n\t\tsetMessages([]);\n\t\tsetError(null);\n\t\tsetLastResponseMeta(null);\n\t\tsetInputMessage(\"\");\n\t\ttoast.success(\"Started new conversation\");\n\t};\n\n\t// === END CONVERSATION MANAGEMENT ===\n\n\tconst handleSendMessage = async () => {\n\t\tif (!inputMessage.trim() || isLoading) return;\n\n\t\tconst userMessage: ChatMessage = {\n\t\t\tid: `user_${Date.now()}`,\n\t\t\trole: \"user\",\n\t\t\tcontent: inputMessage.trim(),\n\t\t\ttimestamp: new Date(),\n\t\t};\n\n\t\t// Add user message to chat\n\t\tsetMessages((prev) => [...prev, userMessage]);\n\t\tsetInputMessage(\"\");\n\t\tsetIsLoading(true);\n\t\tsetError(null);\n\n\t\t// === AUTO-SAVE: Create conversation if it doesn't exist ===\n\t\tlet conversationId = currentConversationId;\n\t\tif (!conversationId) {\n\t\t\ttry {\n\t\t\t\t// Generate title from first user message\n\t\t\t\tconversationId = await createNewConversation(userMessage.content);\n\t\t\t\tsetCurrentConversationId(conversationId);\n\t\t\t\t// Trigger sidebar refresh to show new conversation\n\t\t\t\tsetSidebarRefreshTrigger((prev) => prev + 1);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\"Failed to create conversation:\", error);\n\t\t\t\t// Continue anyway - conversation saving is not critical\n\t\t\t}\n\t\t}\n\n\t\t// === AUTO-SAVE: Save user message ===\n\t\tif (conversationId) {\n\t\t\tawait saveMessageToConversation(conversationId, {\n\t\t\t\trole: \"user\",\n\t\t\t\tcontent: userMessage.content,\n\t\t\t});\n\t\t\t// Trigger sidebar refresh to update message count\n\t\t\tsetSidebarRefreshTrigger((prev) => prev + 1);\n\t\t}\n\n\t\t// Create a placeholder assistant message for streaming with thinking indicator\n\t\tconst assistantMessageId = `assistant_${Date.now()}`;\n\n\t\t// Always include filters\n\t\tconst activeFilters: {\n\t\t\tsubjectId?: number;\n\t\t\tchapterId?: number;\n\t\t\tsubjectName?: string;\n\t\t\tchapterTitle?: string;\n\t\t} = {};\n\t\tif (selectedSubjectId) {\n\t\t\tactiveFilters.subjectId = selectedSubjectId;\n\t\t\tactiveFilters.subjectName = selectedSubjectName;\n\t\t}\n\t\tif (selectedChapterId) {\n\t\t\tactiveFilters.chapterId = parseInt(selectedChapterId, 10);\n\t\t\tactiveFilters.chapterTitle = selectedChapterTitle;\n\t\t}\n\n\t\tconst assistantMessage: ChatMessage = {\n\t\t\tid: assistantMessageId,\n\t\t\trole: \"assistant\",\n\t\t\tcontent: \"Analyzing your question and searching database...\",\n\t\t\ttimestamp: new Date(),\n\t\t\tsources: [],\n\t\t\tfilters: activeFilters,\n\t\t};\n\t\tsetMessages((prev) => [...prev, assistantMessage]);\n\n\t\ttry {\n\t\t\tconst response = await fetch(\"/api/dashboard/chat\", {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tmessage: userMessage.content,\n\t\t\t\t\tconversationHistory: messages,\n\t\t\t\t\tprovider: \"gemini\",\n\t\t\t\t\tmodel,\n\t\t\t\t\tsubjectId: selectedSubjectId || undefined,\n\t\t\t\t\tchapterId: selectedChapterId\n\t\t\t\t\t\t? parseInt(selectedChapterId, 10)\n\t\t\t\t\t\t: undefined,\n\t\t\t\t\tstream: true, // Enable streaming\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst contentType = response.headers.get(\"content-type\");\n\t\t\t\tif (contentType && contentType.indexOf(\"application/json\") !== -1) {\n\t\t\t\t\tconst errorData = await response.json();\n\t\t\t\t\tif (response.status === 429) {\n\t\t\t\t\t\ttoast.error(\n\t\t\t\t\t\t\terrorData.error ||\n\t\t\t\t\t\t\t\t\"You are making requests too quickly. Please wait and try again.\"\n\t\t\t\t\t\t);\n\t\t\t\t\t\t// Remove the placeholder message\n\t\t\t\t\t\tsetMessages((prev) =>\n\t\t\t\t\t\t\tprev.filter((m) => m.id !== assistantMessageId)\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tthrow new Error(errorData.error || \"An unknown error occurred\");\n\t\t\t\t} else {\n\t\t\t\t\tconst errorText = await response.text();\n\t\t\t\t\tconsole.error(\"Received non-JSON error response:\", errorText);\n\n\t\t\t\t\tlet errorMessage = \"The server returned an unexpected response\";\n\t\t\t\t\tif (errorText.includes(\"504 Gateway Time-out\")) {\n\t\t\t\t\t\terrorMessage = \"Server timeout. Please try again later.\";\n\t\t\t\t\t} else if (errorText.includes(\"502 Bad Gateway\")) {\n\t\t\t\t\t\terrorMessage = \"Server error. Please try again later.\";\n\t\t\t\t\t} else if (errorText.includes(\"500 Internal Server Error\")) {\n\t\t\t\t\t\terrorMessage = \"Internal server error. Please try again later.\";\n\t\t\t\t\t}\n\n\t\t\t\t\ttoast.error(errorMessage);\n\t\t\t\t\tthrow new Error(errorMessage);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Handle streaming response\n\t\t\tconst reader = response.body?.getReader();\n\t\t\tconst decoder = new TextDecoder();\n\t\t\tlet accumulatedContent = \"\";\n\t\t\tlet metadata: any = {};\n\t\t\tlet isFirstToken = true;\n\t\t\tlet assistantSources: any[] = [];\n\t\t\tlet assistantTokenCount: any = null;\n\t\t\tlet assistantChartData: any = null;\n\n\t\t\tif (!reader) {\n\t\t\t\tthrow new Error(\"Failed to get response reader\");\n\t\t\t}\n\n\t\t\twhile (true) {\n\t\t\t\tconst { done, value } = await reader.read();\n\t\t\t\tif (done) break;\n\n\t\t\t\tconst chunk = decoder.decode(value, { stream: true });\n\t\t\t\tconst lines = chunk.split(\"\\n\");\n\n\t\t\t\tfor (const line of lines) {\n\t\t\t\t\tif (line.startsWith(\"data: \")) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst data = JSON.parse(line.slice(6));\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\"[STREAM] Received event type:\",\n\t\t\t\t\t\t\t\tdata.type,\n\t\t\t\t\t\t\t\t\"for message:\",\n\t\t\t\t\t\t\t\tassistantMessageId\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tif (data.type === \"metadata\") {\n\t\t\t\t\t\t\t\tmetadata = data;\n\t\t\t\t\t\t\t\tsetLastResponseMeta({\n\t\t\t\t\t\t\t\t\tqueryType: data.queryType,\n\t\t\t\t\t\t\t\t\tsearchQuery: data.searchQuery,\n\t\t\t\t\t\t\t\t\tanalysisUsed: data.analysisUsed,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t// Don't update content here - progress events handle that\n\t\t\t\t\t\t\t} else if (data.type === \"progress\") {\n\t\t\t\t\t\t\t\t// Update with progress message\n\t\t\t\t\t\t\t\tsetMessages((prev) =>\n\t\t\t\t\t\t\t\t\tprev.map((msg) =>\n\t\t\t\t\t\t\t\t\t\tmsg.id === assistantMessageId\n\t\t\t\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\t\t\t\t...msg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcontent: data.progress || \"Processing...\",\n\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t: msg\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t} else if (data.type === \"token\") {\n\t\t\t\t\t\t\t\t// Clear placeholder only on first token\n\t\t\t\t\t\t\t\tif (isFirstToken) {\n\t\t\t\t\t\t\t\t\tisFirstToken = false;\n\t\t\t\t\t\t\t\t\taccumulatedContent = data.text || \"\";\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\taccumulatedContent += data.text || \"\";\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetMessages((prev) =>\n\t\t\t\t\t\t\t\t\tprev.map((msg) =>\n\t\t\t\t\t\t\t\t\t\tmsg.id === assistantMessageId\n\t\t\t\t\t\t\t\t\t\t\t? { ...msg, content: accumulatedContent }\n\t\t\t\t\t\t\t\t\t\t\t: msg\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t} else if (data.type === \"sources\") {\n\t\t\t\t\t\t\t\t// Update sources\n\t\t\t\t\t\t\t\tassistantSources = data.sources || [];\n\t\t\t\t\t\t\t\tsetMessages((prev) =>\n\t\t\t\t\t\t\t\t\tprev.map((msg) =>\n\t\t\t\t\t\t\t\t\t\tmsg.id === assistantMessageId\n\t\t\t\t\t\t\t\t\t\t\t? { ...msg, sources: assistantSources }\n\t\t\t\t\t\t\t\t\t\t\t: msg\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t} else if (data.type === \"data\") {\n\t\t\t\t\t\t\t\t// Handle chart data\n\t\t\t\t\t\t\t\tconsole.log(\"[CHART FRONTEND] Received 'data' event:\", data);\n\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Current assistantMessageId:\",\n\t\t\t\t\t\t\t\t\tassistantMessageId\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tif (data.chartData) {\n\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Chart data present, updating message:\",\n\t\t\t\t\t\t\t\t\t\tassistantMessageId\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Chart data:\",\n\t\t\t\t\t\t\t\t\t\tJSON.stringify(data.chartData, null, 2)\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tsetMessages((prev) => {\n\t\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Current messages before update:\",\n\t\t\t\t\t\t\t\t\t\t\tprev.map((m) => ({\n\t\t\t\t\t\t\t\t\t\t\t\tid: m.id,\n\t\t\t\t\t\t\t\t\t\t\t\thasChartData: !!m.chartData,\n\t\t\t\t\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tconst messageExists = prev.some(\n\t\t\t\t\t\t\t\t\t\t\t(m) => m.id === assistantMessageId\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Message exists:\",\n\t\t\t\t\t\t\t\t\t\t\tmessageExists\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tif (!messageExists) {\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Message not found! Cannot update chartData\"\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\treturn prev;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tconst updated = prev.map((msg) =>\n\t\t\t\t\t\t\t\t\t\t\tmsg.id === assistantMessageId\n\t\t\t\t\t\t\t\t\t\t\t\t? { ...msg, chartData: data.chartData }\n\t\t\t\t\t\t\t\t\t\t\t\t: msg\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tconst updatedMessage = updated.find(\n\t\t\t\t\t\t\t\t\t\t\t(m) => m.id === assistantMessageId\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Updated message chartData:\",\n\t\t\t\t\t\t\t\t\t\t\tupdatedMessage?.chartData ? \"PRESENT\" : \"MISSING\"\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tif (updatedMessage?.chartData) {\n\t\t\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] Chart data structure:\",\n\t\t\t\t\t\t\t\t\t\t\t\tObject.keys(updatedMessage.chartData)\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\treturn updated;\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t\t\t\t\"[CHART FRONTEND] 'data' event received but chartData is missing\"\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if (data.type === \"done\") {\n\t\t\t\t\t\t\t\t// Update token count and chart data\n\t\t\t\t\t\t\t\tassistantTokenCount = data.tokenCount;\n\t\t\t\t\t\t\t\tconst chartDataFromDone = data.chartData;\n\t\t\t\t\t\t\t\tif (chartDataFromDone) {\n\t\t\t\t\t\t\t\t\tassistantChartData = chartDataFromDone;\n\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\"[CHART] Chart data in done event:\",\n\t\t\t\t\t\t\t\t\t\tchartDataFromDone\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tsetMessages((prev) =>\n\t\t\t\t\t\t\t\t\tprev.map((msg) => {\n\t\t\t\t\t\t\t\t\t\tif (msg.id === assistantMessageId) {\n\t\t\t\t\t\t\t\t\t\t\t// Preserve existing chartData if done event doesn't have it\n\t\t\t\t\t\t\t\t\t\t\tconst finalChartData =\n\t\t\t\t\t\t\t\t\t\t\t\tchartDataFromDone ||\n\t\t\t\t\t\t\t\t\t\t\t\tassistantChartData ||\n\t\t\t\t\t\t\t\t\t\t\t\tmsg.chartData;\n\t\t\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\t\t\"[CHART DONE] Final chartData:\",\n\t\t\t\t\t\t\t\t\t\t\t\tfinalChartData ? \"PRESENT\" : \"MISSING\"\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\t\t...msg,\n\t\t\t\t\t\t\t\t\t\t\t\ttokenCount: assistantTokenCount,\n\t\t\t\t\t\t\t\t\t\t\t\tchartData: finalChartData,\n\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\treturn msg;\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\t// === AUTO-SAVE: Save assistant message ===\n\t\t\t\t\t\t\t\tif (conversationId) {\n\t\t\t\t\t\t\t\t\tconst saveFilters: {\n\t\t\t\t\t\t\t\t\t\tsubjectId?: number;\n\t\t\t\t\t\t\t\t\t\tchapterId?: number;\n\t\t\t\t\t\t\t\t\t\tsubjectName?: string;\n\t\t\t\t\t\t\t\t\t\tchapterTitle?: string;\n\t\t\t\t\t\t\t\t\t} = {};\n\t\t\t\t\t\t\t\t\tif (selectedSubjectId) {\n\t\t\t\t\t\t\t\t\t\tsaveFilters.subjectId = selectedSubjectId;\n\t\t\t\t\t\t\t\t\t\tsaveFilters.subjectName = selectedSubjectName;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif (selectedChapterId) {\n\t\t\t\t\t\t\t\t\t\tsaveFilters.chapterId = parseInt(selectedChapterId, 10);\n\t\t\t\t\t\t\t\t\t\tsaveFilters.chapterTitle = selectedChapterTitle;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t// Use the tracked chartData\n\t\t\t\t\t\t\t\t\tconst finalChartData =\n\t\t\t\t\t\t\t\t\t\tchartDataFromDone || assistantChartData;\n\n\t\t\t\t\t\t\t\t\tawait saveMessageToConversation(conversationId, {\n\t\t\t\t\t\t\t\t\t\trole: \"assistant\",\n\t\t\t\t\t\t\t\t\t\tcontent: accumulatedContent,\n\t\t\t\t\t\t\t\t\t\tsources: assistantSources,\n\t\t\t\t\t\t\t\t\t\ttokenCount: assistantTokenCount,\n\t\t\t\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t\t\t\tqueryType: metadata.queryType,\n\t\t\t\t\t\t\t\t\t\t\tsearchMethod: metadata.searchMethod,\n\t\t\t\t\t\t\t\t\t\t\tanalysisUsed: metadata.analysisUsed,\n\t\t\t\t\t\t\t\t\t\t\tfilters: saveFilters,\n\t\t\t\t\t\t\t\t\t\t\tchartData: finalChartData, // Store chartData in metadata\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t// Trigger sidebar refresh to update message count\n\t\t\t\t\t\t\t\t\tsetSidebarRefreshTrigger((prev) => prev + 1);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if (data.type === \"error\") {\n\t\t\t\t\t\t\t\tthrow new Error(data.error || \"Streaming error occurred\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (parseError) {\n\t\t\t\t\t\t\tconsole.error(\"Error parsing SSE data:\", parseError);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// If no content was received, show error\n\t\t\tif (!accumulatedContent) {\n\t\t\t\tthrow new Error(\"No response received from server\");\n\t\t\t}\n\n\t\t\t// Auto-save is now handled in the 'done' event to ensure we have all data including chartData\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(\"Chat error:\", error);\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error ? error.message : \"An unexpected error occurred\";\n\t\t\tsetError(errorMessage);\n\n\t\t\tconst displayMessage = `I apologize, but I encountered an error: ${errorMessage}. Please try again.`;\n\n\t\t\t// Update the assistant message with error\n\t\t\tsetMessages((prev) =>\n\t\t\t\tprev.map((msg) =>\n\t\t\t\t\tmsg.id === assistantMessageId\n\t\t\t\t\t\t? { ...msg, content: displayMessage }\n\t\t\t\t\t\t: msg\n\t\t\t\t)\n\t\t\t);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t};\n\n\tconst handleKeyPress = (e: React.KeyboardEvent) => {\n\t\tif (e.key === \"Enter\" && !e.shiftKey) {\n\t\t\te.preventDefault();\n\t\t\thandleSendMessage();\n\t\t}\n\t};\n\n\tconst clearChat = () => {\n\t\tsetMessages([]);\n\t\tsetError(null);\n\t\tsetExpandedSources({});\n\t};\n\n\t// Toggle source expansion for a specific message\n\tconst toggleSourceExpansion = (messageId: string) => {\n\t\tsetExpandedSources((prev) => ({\n\t\t\t...prev,\n\t\t\t[messageId]: !prev[messageId],\n\t\t}));\n\t};\n\n\tconst formatTimestamp = (timestamp: Date | string | undefined) => {\n\t\tif (!timestamp) return \"\";\n\t\tconst date = new Date(timestamp);\n\t\treturn date.toLocaleString();\n\t};\n\n\t// Truncate source title for display\n\tconst truncateTitle = (title: string, maxLength: number = 40) => {\n\t\tif (title.length <= maxLength) return title;\n\t\treturn title.substring(0, maxLength).trim() + \"...\";\n\t};\n\n\t// Copy message content to clipboard\n\tconst handleCopy = async (text: string, messageId: string) => {\n\t\tif (!text) return;\n\t\ttry {\n\t\t\tawait navigator.clipboard.writeText(text);\n\t\t\tsetCopiedMessageId(messageId);\n\t\t\tsetTimeout(() => {\n\t\t\t\tsetCopiedMessageId(null);\n\t\t\t}, 2000);\n\t\t} catch (err) {\n\t\t\tconsole.error(\"Failed to copy text: \", err);\n\t\t}\n\t};\n\n\treturn (\n\t\t<div className=\"flex h-screen overflow-hidden\">\n\t\t\t{/* Sidebar */}\n\t\t\t<ConversationSidebar\n\t\t\t\tcurrentConversationId={currentConversationId}\n\t\t\t\tonSelectConversation={loadConversation}\n\t\t\t\tonNewConversation={startNewConversation}\n\t\t\t\trefreshTrigger={sidebarRefreshTrigger}\n\t\t\t\tbasePath=\"/api/dashboard/conversations\"\n\t\t\t/>\n\n\t\t\t{/* Main Chat Area */}\n\t\t\t<div className=\"flex-1 flex flex-col overflow-hidden bg-gray-50/50 dark:bg-gray-900/50\">\n\t\t\t\t<div className=\"flex-1 flex flex-col overflow-hidden min-h-0\">\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div className=\"border-b bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm p-4 flex items-center justify-between sticky top-0 z-10\">\n\t\t\t\t\t\t<div className=\"flex items-center gap-3\">\n\t\t\t\t\t\t\t<div className=\"p-2 bg-primary/10 rounded-lg\">\n\t\t\t\t\t\t\t\t<Bot className=\"h-5 w-5 text-primary\" />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<h2 className=\"font-semibold text-gray-900 dark:text-gray-100\">\n\t\t\t\t\t\t\t\t\t{conversationTitle}\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2 text-xs text-gray-500\">\n\t\t\t\t\t\t\t\t\t<span className=\"flex items-center gap-1\">\n\t\t\t\t\t\t\t\t\t\t<div className=\"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse\" />\n\t\t\t\t\t\t\t\t\t\tOnline\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t<span>•</span>\n\t\t\t\t\t\t\t\t\t<span>{model}</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tonClick={clearChat}\n\t\t\t\t\t\t\t\tdisabled={messages.length === 0 || isLoading}\n\t\t\t\t\t\t\t\tclassName=\"hidden sm:flex\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<MessageSquare className=\"h-4 w-4 mr-2\" />\n\t\t\t\t\t\t\t\tNew Chat\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Messages Area */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tref={scrollAreaRef}\n\t\t\t\t\t\tclassName=\"flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth min-h-0\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{messages.length === 0 ? (\n\t\t\t\t\t\t\t<div className=\"h-full flex flex-col items-center justify-center text-center p-8 animate-in fade-in duration-500\">\n\t\t\t\t\t\t\t\t<div className=\"w-24 h-24 bg-primary/5 rounded-full flex items-center justify-center mb-6 ring-1 ring-primary/10\">\n\t\t\t\t\t\t\t\t\t<Bot className=\"h-12 w-12 text-primary/80\" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<h3 className=\"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2\">\n\t\t\t\t\t\t\t\t\tHow can I help you today?\n\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t<p className=\"text-gray-500 max-w-md mb-8\">\n\t\t\t\t\t\t\t\t\tI can analyze your documents, summarize information, and\n\t\t\t\t\t\t\t\t\tanswer questions about your files.\n\t\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t\t<div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-2xl w-full\">\n\t\t\t\t\t\t\t\t\t{[\n\t\t\t\t\t\t\t\t\t\t\"Summarize the latest documents\",\n\t\t\t\t\t\t\t\t\t\t\"Find information about...\",\n\t\t\t\t\t\t\t\t\t\t\"What are the key points in...\",\n\t\t\t\t\t\t\t\t\t\t\"Compare documents related to...\",\n\t\t\t\t\t\t\t\t\t].map((suggestion, i) => (\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\tkey={i}\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetInputMessage(suggestion);\n\t\t\t\t\t\t\t\t\t\t\t\tinputRef.current?.focus();\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"p-4 text-left text-sm bg-white dark:bg-gray-800 border rounded-xl hover:border-primary/50 hover:shadow-sm transition-all duration-200 group\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-gray-700 dark:text-gray-300 group-hover:text-primary transition-colors\">\n\t\t\t\t\t\t\t\t\t\t\t\t{suggestion}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<div className=\"space-y-6 pb-4\">\n\t\t\t\t\t\t\t\t{messages.map((msg) => (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tkey={msg.id}\n\t\t\t\t\t\t\t\t\t\tclassName={`flex gap-4 ${\n\t\t\t\t\t\t\t\t\t\t\tmsg.role === \"assistant\" ? \"bg-transparent\" : \"\"\n\t\t\t\t\t\t\t\t\t\t} animate-in slide-in-from-bottom-2 duration-300`}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tclassName={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-1 shadow-sm ${\n\t\t\t\t\t\t\t\t\t\t\t\tmsg.role === \"assistant\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t? \"bg-primary text-primary-foreground ring-2 ring-primary/20\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t: \"bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300\"\n\t\t\t\t\t\t\t\t\t\t\t}`}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{msg.role === \"assistant\" ? (\n\t\t\t\t\t\t\t\t\t\t\t\t<Bot className=\"h-5 w-5\" />\n\t\t\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t\t\t<User className=\"h-5 w-5\" />\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex-1 min-w-0 space-y-2\">\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\n\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"font-medium text-sm text-gray-900 dark:text-gray-100\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t{msg.role === \"assistant\" ? \"AI Assistant\" : \"You\"}\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-xs text-gray-400\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{formatTimestamp(msg.timestamp)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{msg.role === \"assistant\" && (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvariant=\"ghost\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsize=\"icon\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"h-6 w-6 text-gray-400 hover:text-gray-600\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tonClick={() => handleCopy(msg.content, msg.id)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{copiedMessageId === msg.id ? (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Check className=\"h-3 w-3 text-green-500\" />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Copy className=\"h-3 w-3\" />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t\t\t{/* Filters Badge (Assistant Only) */}\n\t\t\t\t\t\t\t\t\t\t\t{msg.role === \"assistant\" && msg.filters && (\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex flex-wrap gap-2 mb-2\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t{(msg.filters as any).subjectName && (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"text-[10px] h-5 px-2 bg-purple-50 text-purple-700 border-purple-200\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSubject: {(msg.filters as any).subjectName}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</Badge>\n\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t{(msg.filters as any).chapterTitle && (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"text-[10px] h-5 px-2 bg-blue-50 text-blue-700 border-blue-200\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tChapter: {(msg.filters as any).chapterTitle}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</Badge>\n\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`prose prose-sm max-w-none dark:prose-invert ${\n\t\t\t\t\t\t\t\t\t\t\t\t\tmsg.role === \"user\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"bg-white dark:bg-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 dark:border-gray-700\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: \"\"\n\t\t\t\t\t\t\t\t\t\t\t\t}`}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{msg.role === \"assistant\" ? (\n\t\t\t\t\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/* Show loading indicator for placeholder and progress messages */}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{msg.content.includes(\"Analyzing your question\") ||\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmsg.content.includes(\"Generating response\") ||\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmsg.content.includes(\"Processing\") ||\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmsg.content.includes(\"Synthesizing\") ? (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2 text-gray-600 dark:text-gray-400\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Loader2 className=\"h-4 w-4 animate-spin\" />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span>{msg.content}</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<ReactMarkdown\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tremarkPlugins={[remarkGfm]}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcomponents={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttable: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"overflow-x-auto my-4 rounded-lg border\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<table\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"min-w-full divide-y divide-gray-200 dark:divide-gray-700\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tthead: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<thead\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"bg-gray-50 dark:bg-gray-800\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tth: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<th\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttd: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 border-t border-gray-100 dark:border-gray-700\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ta: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"text-primary hover:underline\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tp: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"mb-2 last:mb-0\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tul: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<ul\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"list-disc pl-4 mb-2 space-y-1\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tol: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<ol\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"list-decimal pl-4 mb-2 space-y-1\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tli: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<li className=\"pl-1\" {...props} />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tblockquote: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<blockquote\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"border-l-4 border-primary/30 pl-4 italic text-gray-600 dark:text-gray-400 my-2\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcode: ({ node, ...props }) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<code\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-sm font-mono text-pink-600 dark:text-pink-400\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{msg.content}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</ReactMarkdown>\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/* Chart Section */}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{(() => {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tconst hasChartData = !!msg.chartData;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t`[CHART RENDER] Message ${msg.id} - hasChartData:`,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\thasChartData,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"chartData:\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmsg.chartData\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\treturn hasChartData ? (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"mt-4\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<SmartChart\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tconfig={msg.chartData as any}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t) : null;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})()}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t\t\t\tmsg.content\n\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t\t\t{/* Sources Section */}\n\t\t\t\t\t\t\t\t\t\t\t{msg.sources && msg.sources.length > 0 && (\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"mt-3\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tvariant=\"ghost\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tonClick={() => toggleSourceExpansion(msg.id)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"text-xs text-gray-500 hover:text-gray-900 flex items-center gap-1 h-6 px-2\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<FileText className=\"h-3 w-3\" />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{msg.sources.length} Source\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{msg.sources.length !== 1 ? \"s\" : \"\"} Used\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{expandedSources[msg.id] ? (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-[10px] ml-1\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(Click to hide)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-[10px] ml-1\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(Click to view)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</Button>\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t{expandedSources[msg.id] && (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"mt-2 grid gap-2 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 animate-in fade-in slide-in-from-top-1 duration-200\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{msg.sources\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.slice(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\texpandedSources[msg.id]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? undefined\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: INITIAL_SOURCES_SHOWN\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.map((source: any, idx: number) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Link\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tkey={idx}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\thref={`/dashboard/files/${source.id}`}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"block group\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Card className=\"h-full hover:shadow-md transition-all duration-200 border-l-4 border-l-primary/20 hover:border-l-primary cursor-pointer bg-white/50 dark:bg-gray-800/50\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<CardContent className=\"p-3\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-start justify-between gap-2\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex-1 min-w-0\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-xs font-medium text-gray-900 dark:text-gray-100 truncate group-hover:text-primary transition-colors\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{truncateTitle(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsource.title ||\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Untitled Document\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2 mt-1\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"text-[10px] h-4 px-1 font-normal bg-gray-100 text-gray-600\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tID: {source.id}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</Badge>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{source.similarity && (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-[10px] text-green-600 font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsource.similarity * 100\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t).toFixed(0)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t% match\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<ExternalLink className=\"h-3 w-3 text-gray-400 group-hover:text-primary opacity-0 group-hover:opacity-100 transition-all\" />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</CardContent>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</Card>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t\t\t\t\t{/* Token Usage Info (Optional) */}\n\t\t\t\t\t\t\t\t\t\t\t{msg.tokenCount && (\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"mt-1 text-[10px] text-gray-400 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span>Input: {msg.tokenCount.input || 0} tokens</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span>•</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tOutput: {msg.tokenCount.output || 0} tokens\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t))}\n\n\t\t\t\t\t\t\t\t{/* Loading Indicator */}\n\t\t\t\t\t\t\t\t{isLoading &&\n\t\t\t\t\t\t\t\t\tmessages[messages.length - 1]?.role === \"user\" && (\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex gap-4 animate-in fade-in duration-300\">\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0 ring-1 ring-primary/20\">\n\t\t\t\t\t\t\t\t\t\t\t\t<Loader2 className=\"h-4 w-4 text-primary animate-spin\" />\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex-1 space-y-2\">\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"font-medium text-sm text-gray-900 dark:text-gray-100\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tAI Assistant\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-xs text-gray-400 animate-pulse\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tThinking...\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"h-4 w-24 bg-gray-200 dark:bg-gray-700 rounded animate-pulse\" />\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<div ref={scrollAreaRef} />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Input Area */}\n\t\t\t\t\t<div className=\"p-4 bg-white dark:bg-gray-900 border-t shadow-lg z-20 flex-shrink-0\">\n\t\t\t\t\t\t<div className=\"max-w-4xl mx-auto space-y-3\">\n\t\t\t\t\t\t\t{/* Filters Row */}\n\t\t\t\t\t\t\t<div className=\"flex flex-wrap items-center gap-2\">\n\t\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\t\tclassName=\"text-xs border rounded-md px-2 py-1 bg-gray-50 dark:bg-gray-800 focus:ring-1 focus:ring-primary outline-none\"\n\t\t\t\t\t\t\t\t\tvalue={selectedSubjectId || \"\"}\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst subjectId = e.target.value\n\t\t\t\t\t\t\t\t\t\t\t? parseInt(e.target.value, 10)\n\t\t\t\t\t\t\t\t\t\t\t: null;\n\t\t\t\t\t\t\t\t\t\tsetSelectedSubjectId(subjectId);\n\t\t\t\t\t\t\t\t\t\tif (subjectId) {\n\t\t\t\t\t\t\t\t\t\t\tconst subject = subjects.find((s) => s.id === subjectId);\n\t\t\t\t\t\t\t\t\t\t\tsetSelectedSubjectName(subject?.name || \"\");\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\tsetSelectedSubjectName(\"\");\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t// Clear chapter when subject changes\n\t\t\t\t\t\t\t\t\t\tsetSelectedChapterId(null);\n\t\t\t\t\t\t\t\t\t\tsetSelectedChapterTitle(\"\");\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tdisabled={isLoading || subjectsLoading}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<option value=\"\">All Subjects</option>\n\t\t\t\t\t\t\t\t\t{subjects.map((s) => (\n\t\t\t\t\t\t\t\t\t\t<option key={s.id} value={s.id}>\n\t\t\t\t\t\t\t\t\t\t\t{s.name}\n\t\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t</select>\n\n\t\t\t\t\t\t\t\t{selectedSubjectId && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div className=\"h-4 w-px bg-gray-200 dark:bg-gray-700 mx-1\" />\n\t\t\t\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"text-xs border rounded-md px-2 py-1 bg-gray-50 dark:bg-gray-800 focus:ring-1 focus:ring-primary outline-none\"\n\t\t\t\t\t\t\t\t\t\t\tvalue={selectedChapterId || \"\"}\n\t\t\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\tconst chapterId = e.target.value || null;\n\t\t\t\t\t\t\t\t\t\t\t\tsetSelectedChapterId(chapterId);\n\t\t\t\t\t\t\t\t\t\t\t\tif (chapterId) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst chapter = chapters.find(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t(c) => c.id === chapterId\n\t\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\t\t\tsetSelectedChapterTitle(chapter?.title || \"\");\n\t\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsetSelectedChapterTitle(\"\");\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tdisabled={isLoading || chaptersLoading}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<option value=\"\">All Chapters</option>\n\t\t\t\t\t\t\t\t\t\t\t{chapters.map((c) => (\n\t\t\t\t\t\t\t\t\t\t\t\t<option key={c.id} value={c.id}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{c.chapter_number ? `Ch. ${c.chapter_number}: ` : \"\"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t{c.title}\n\t\t\t\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t\t<div className=\"h-4 w-px bg-gray-200 dark:bg-gray-700 mx-1\" />\n\n\t\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\t\tclassName=\"text-xs border rounded-md px-2 py-1 bg-gray-50 dark:bg-gray-800 focus:ring-1 focus:ring-primary outline-none\"\n\t\t\t\t\t\t\t\t\tvalue={model}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setModel(e.target.value)}\n\t\t\t\t\t\t\t\t\tdisabled={isLoading || modelsLoading}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{models.map((m) => (\n\t\t\t\t\t\t\t\t\t\t<option key={m.name} value={m.name}>\n\t\t\t\t\t\t\t\t\t\t\t{m.label}\n\t\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Input Row */}\n\t\t\t\t\t\t\t<div className=\"flex gap-2 relative\">\n\t\t\t\t\t\t\t\t<Input\n\t\t\t\t\t\t\t\t\tref={inputRef}\n\t\t\t\t\t\t\t\t\tplaceholder={\n\t\t\t\t\t\t\t\t\t\tisLoading\n\t\t\t\t\t\t\t\t\t\t\t? \"Please wait for response...\"\n\t\t\t\t\t\t\t\t\t\t\t: \"Ask a question about your documents...\"\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tvalue={inputMessage}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setInputMessage(e.target.value)}\n\t\t\t\t\t\t\t\t\tonKeyDown={handleKeyPress}\n\t\t\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\t\t\tclassName=\"flex-1 pr-12 py-6 text-base shadow-sm focus-visible:ring-primary/50\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\tonClick={handleSendMessage}\n\t\t\t\t\t\t\t\t\tdisabled={!inputMessage.trim() || isLoading}\n\t\t\t\t\t\t\t\t\tclassName=\"absolute right-1.5 top-1.5 h-9 w-9 p-0 rounded-lg shadow-sm\"\n\t\t\t\t\t\t\t\t\tsize=\"icon\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t\t\t\t\t<Loader2 className=\"h-4 w-4 animate-spin\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<Send className=\"h-4 w-4\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div className=\"flex justify-between items-center px-1\">\n\t\t\t\t\t\t\t\t<p className=\"text-[10px] text-gray-400\">\n\t\t\t\t\t\t\t\t\tAI can make mistakes. Please verify important information from\n\t\t\t\t\t\t\t\t\tsource documents.\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t{messages.length > 0 && (\n\t\t\t\t\t\t\t\t\t<span className=\"text-[10px] text-gray-400\">\n\t\t\t\t\t\t\t\t\t\t{messages.length} message{messages.length !== 1 ? \"s\" : \"\"}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n}\n\nexport default function DashboardChatPage() {\n\treturn (\n\t\t<Suspense fallback={<div className=\"container mx-auto px-4 py-8\">Loading...</div>}>\n\t\t\t<DashboardChatPageContent />\n\t\t</Suspense>\n\t);\n}\n"],"names":[],"mappings":"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"}