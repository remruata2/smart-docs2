module.exports=[54532,a=>a.a(async(b,c)=>{try{var d=a.i(766518),e=a.i(742150),f=b([e]);async function g(a,b){console.log(`[QUESTION-BANK] Starting generation for chapter ${a}`);try{let c=BigInt(a),f=await d.prisma.chapterChunk.findMany({where:{chapter_id:c},orderBy:{chunk_index:"asc"},select:{id:!0,content:!0,page_number:!0,chunk_index:!0}});if(0===f.length)return void console.warn(`[QUESTION-BANK] No chunks found for chapter ${a}`);let g=[],h=[],i=f[0].page_number||1;for(let a of f){let b=a.page_number||0;h.length>0&&(b>i+3||b>(h[h.length-1].page_number||0)+2)&&(g.push({startPage:i,endPage:h[h.length-1].page_number||i,content:h.map(a=>a.content).join("\n\n"),chunkIds:h.map(a=>a.id)}),h=[],i=b),h.push(a)}h.length>0&&g.push({startPage:i,endPage:h[h.length-1].page_number||i,content:h.map(a=>a.content).join("\n\n"),chunkIds:h.map(a=>a.id)}),console.log(`[QUESTION-BANK] Split chapter into ${g.length} sections for processing`);let j=g.length,k=g.map((a,c)=>{let d={easy:{},medium:{},hard:{}};return["easy","medium","hard"].forEach(a=>{Object.entries(b[a]).forEach(([b,e])=>{let{base:f,remainder:g}={base:Math.floor(e/j),remainder:e%j},h=f+ +(c<g);h>0&&(d[a][b]=h)})}),{section:a,config:d}});for(let a=0;a<k.length;a+=3){let b=k.slice(a,a+3);await Promise.all(b.map(async a=>{if(Object.values(a.config).some(a=>Object.keys(a).length>0)){console.log(`[QUESTION-BANK] Generating questions for section Pages ${a.section.startPage}-${a.section.endPage}`);try{let b=await (0,e.generateBatchQuestions)({context:a.section.content,config:a.config,chapterTitle:`Pages ${a.section.startPage}-${a.section.endPage}`});b.length>0&&(await d.prisma.question.createMany({data:b.map(a=>({chapter_id:c,question_text:a.question_text,question_type:a.question_type,difficulty:a.difficulty,options:a.options?a.options:void 0,correct_answer:a.correct_answer,explanation:a.explanation,points:a.points,is_active:!0}))}),console.log(`[QUESTION-BANK] Saved ${b.length} questions for section Pages ${a.section.startPage}-${a.section.endPage}`))}catch(b){console.error(`[QUESTION-BANK] Failed to generate for section Pages ${a.section.startPage}-${a.section.endPage}:`,b)}}}))}console.log(`[QUESTION-BANK] Completed generation for chapter ${a}`)}catch(b){throw console.error(`[QUESTION-BANK] Critical error generating question bank for ${a}:`,b),b}}[e]=f.then?(await f)():f,a.s(["generateQuestionBank",()=>g]),c()}catch(a){c(a)}},!1),539088,a=>a.a(async(b,c)=>{try{var d=a.i(766518),e=a.i(376469),f=a.i(934304),g=a.i(924868),h=a.i(814747),i=a.i(446786),j=a.i(866967),k=a.i(742150),l=a.i(222353),m=a.i(54532),n=b([f,k,m]);async function o(a,b){try{let c=BigInt(a);if(await d.prisma.studyMaterial.findUnique({where:{chapter_id:c}}))return void console.log(`[BG-PROCESSOR] Study materials already exist for chapter ${a}, skipping`);let e=await d.prisma.chapter.findUnique({where:{id:c}});if(!e)return;let f=e.content_json,g=f.text||f.markdown||JSON.stringify(f),h={subject:b.subject.name,chapterTitle:b.title,content:g},i=await (0,k.generateStudyMaterials)(h),j=(await Promise.all(i.youtube_search_queries.map(a=>(0,l.searchYouTubeVideos)({query:a,maxResults:2})))).flat().slice(0,6);await d.prisma.studyMaterial.create({data:{chapter_id:c,summary:{brief:i.summary_markdown,key_points:i.key_terms.map(a=>a.term),important_formulas:i.important_formulas||[]},definitions:i.key_terms,flashcards:i.flashcards,mind_map:i.mind_map_mermaid,video_queries:i.youtube_search_queries,curated_videos:j}}),console.log(`[BG-PROCESSOR] Successfully generated study materials for chapter ${a}`)}catch(b){console.error(`[BG-PROCESSOR] Error generating study materials for chapter ${a}:`,b)}}async function p(a){let{chapterId:b,pdfBuffer:c,fileName:k,startPage:l,endPage:n}=a,p=BigInt(b);try{await d.prisma.chapter.update({where:{id:p},data:{processing_status:"PROCESSING",error_message:null}});let k=l&&n?`(Pages ${l}-${n})`:"(Full Document)";console.log(`[BG-PROCESSOR] Starting processing for chapter ${b} ${k}`);let q=(0,h.join)((0,i.tmpdir)(),`chapter-${b}-${Date.now()}.pdf`);await (0,g.writeFile)(q,c),console.log("[BG-PROCESSOR] Running LlamaParse...");let r=new e.LlamaParseDocumentParser,s=await r.parseFile(q);if(!s||!Array.isArray(s)||0===s.length)throw Error("LlamaParse returned no pages");let t=s;if(void 0!==l&&void 0!==n&&(t=s.filter(a=>a.page>=l&&a.page<=n)),0===t.length){let a=l&&n?`in range ${l}-${n}`:"in document";throw console.warn(`[BG-PROCESSOR] No pages found ${a}. LlamaParse returned pages: ${s.map(a=>a.page).join(", ")}`),Error(`No content found ${a}`)}console.log(`[BG-PROCESSOR] Processing ${t.length} pages (from ${s.length} total)`),await d.prisma.chapter.update({where:{id:p},data:{content_json:t,parsed_at:new Date}}),console.log(`[BG-PROCESSOR] Parsed ${t.length} pages`);let u=[];for(let a of t){let b=a.items||[],c=a.width||595,d=a.height||842,e="",f=[];for(let g of b){if(!g.md||0===g.md.trim().length)continue;let b=g.md.trim();e+=b+"\n\n";let h=g.bbox||g.bBox;if(h&&"object"==typeof h)if("number"==typeof h.x&&"number"==typeof h.y&&"number"==typeof h.w&&"number"==typeof h.h){let a=function(a,b=595,c=842){let d=a.x??0,e=a.y??0,f=a.w??1,g=a.h??1;return(b<=0||c<=0)&&(console.warn(`[BG-PROCESSOR] Invalid page dimensions: ${b}x${c}, using defaults`),b=595,c=842),[Math.max(0,Math.min(1,d/b)),Math.max(0,Math.min(1,e/c)),Math.max(0,Math.min(1,f/b)),Math.max(0,Math.min(1,g/c))]}(h,c,d);f.push({text:b,bbox:a})}else console.warn(`[BG-PROCESSOR] Invalid bbox structure for item on page ${a.page}:`,h)}!e.trim()&&(a.text||a.md)&&(e=(a.text||a.md||"").trim()),e.trim()&&u.push({content:e.trim(),page_number:a.page,bbox:f.length>0?f:null})}console.log(`[BG-PROCESSOR] Created ${u.length} chunks (one per page)`);let v=await d.prisma.chapter.findUnique({where:{id:p},select:{subject_id:!0,accessible_boards:!0,is_global:!0}});if(!v)throw Error("Chapter not found");let w=await Promise.all(u.map((a,b)=>d.prisma.chapterChunk.create({data:{chapter_id:p,chunk_index:b,content:a.content,page_number:a.page_number,bbox:a.bbox,subject_id:v.subject_id}})));if(console.log(`[BG-PROCESSOR] Inserted ${w.length} chunks into DB`),!v.is_global&&v.accessible_boards.length>0){console.log(`[BG-PROCESSOR] Creating board access entries for ${w.length} chunks...`);let a=[];for(let b of w)for(let c of v.accessible_boards)a.push({chunk_id:b.id,board_id:c});a.length>0&&(await d.prisma.chapterChunkBoard.createMany({data:a}),console.log(`[BG-PROCESSOR] Created ${a.length} board access entries`))}else v.is_global?console.log("[BG-PROCESSOR] Chapter is global, skipping board access entries"):console.warn("[BG-PROCESSOR] Chapter has no accessible_boards and is not global - chunks may not be searchable!");let x=await d.prisma.chapter.findUnique({where:{id:p},select:{title:!0,subject:{select:{name:!0}}}});if(!x)throw Error("Chapter not found for vector generation");for(let a of(console.log("[BG-PROCESSOR] Generating embeddings and search vectors..."),w)){let b=await f.SemanticVectorService.generateEmbedding(a.content);await d.prisma.$executeRaw`
                UPDATE "chapter_chunks"
                SET semantic_vector = ${JSON.stringify(b)}::vector,
                    search_vector = setweight(to_tsvector('english', COALESCE(${x.title||""}, '')), 'A') ||
                                   setweight(to_tsvector('english', COALESCE(${x.subject.name||""}, '')), 'B') ||
                                   setweight(to_tsvector('english', COALESCE(${a.content||""}, '')), 'C')
                WHERE id = ${a.id}
            `}console.log("[BG-PROCESSOR] Generated embeddings and search vectors for all chunks"),console.log("[BG-PROCESSOR] Generating page screenshots...");let y=(0,h.join)((0,i.tmpdir)(),`chapter-${b}-images`),z=await (0,j.generatePageImages)(q,y,b,l,n),A=await (0,j.uploadPageImages)(z,`chapter-${b}`),B=s.map(a=>({chapter_id:p,page_number:a.page,image_url:A.get(a.page)||"",width:a.width||null,height:a.height||null}));await d.prisma.chapterPage.createMany({data:B}),console.log(`[BG-PROCESSOR] Created ${B.length} page records`),await (0,g.unlink)(q),console.log("[BG-PROCESSOR] Generating study materials..."),await o(b,x),console.log(`[BG-PROCESSOR] Study materials generated for chapter ${b}`),a.questionConfig&&(console.log("[BG-PROCESSOR] Generating Question Bank..."),await (0,m.generateQuestionBank)(b,a.questionConfig),console.log(`[BG-PROCESSOR] Question Bank generated for chapter ${b}`)),await d.prisma.chapter.update({where:{id:p},data:{processing_status:"COMPLETED",processed_at:new Date,error_message:null}}),console.log(`[BG-PROCESSOR] Chapter ${b} completed successfully`)}catch(a){throw console.error(`[BG-PROCESSOR] Error processing chapter ${b}:`,a),await d.prisma.chapter.update({where:{id:p},data:{processing_status:"FAILED",error_message:a.message||"Unknown error during processing"}}),a}}[f,k,m]=n.then?(await n)():n,a.s(["processChapterBackground",()=>p]),c()}catch(a){c(a)}},!1),336413,a=>a.a(async(b,c)=>{try{var d=a.i(137936),e=a.i(539088),f=a.i(766518),g=a.i(20971),h=a.i(547256),i=a.i(109307),j=a.i(713095),k=b([e]);async function l(a){let b=await (0,g.getServerSession)(h.authOptions);if(!b?.user||!(0,i.isAdmin)(b.user.role))return{success:!1,error:"Unauthorized"};try{let b=a.get("subjectId"),c=JSON.parse(a.get("chapters"));JSON.parse(a.get("fullPages"));let d=a.get("file"),g=a.getAll("accessibleBoards"),h=a.get("questionConfig"),i=h?JSON.parse(h):void 0;if(!d||!b||!c||0===c.length)return{success:!1,error:"Missing required fields"};let j=await f.prisma.subject.findUnique({where:{id:parseInt(b)},include:{program:{include:{board:!0}}}});if(!j)return{success:!1,error:"Subject not found"};let k=j.program.board_id,l=g.includes("GLOBAL"),m=l?[]:g.length>0?g.filter(a=>"GLOBAL"!==a):[k],n=Buffer.from(await d.arrayBuffer()),o=[],p=[];for(let a of c){let c=await f.prisma.chapter.create({data:{title:a.title,subject_id:parseInt(b),chapter_number:a.chapterNumber,content_json:[],accessible_boards:m,is_global:l,is_active:!0,processing_status:"PENDING"}});o.push(c.id.toString()),p.push({chapterId:c.id.toString(),pdfBuffer:n,fileName:d.name,startPage:a.startPage,endPage:a.endPage,questionConfig:i})}return setImmediate(async()=>{for(let a of p)try{await (0,e.processChapterBackground)(a)}catch(b){console.error(`Failed to process chapter ${a.chapterId}:`,b)}}),{success:!0,message:`Created ${c.length} chapter(s) - Processing in background`,chapterIds:o}}catch(a){return console.error("Error creating chapters:",a),{success:!1,error:a.message||"Failed to create chapters"}}}async function m(a){let b=await (0,g.getServerSession)(h.authOptions);if(!b?.user||!(0,i.isAdmin)(b.user.role))return{success:!1,error:"Unauthorized"};try{let b=a.get("file"),c=a.get("title"),d=a.get("subjectId"),g=a.get("chapterNumber"),h=a.getAll("accessibleBoards"),i=a.get("questionConfig"),j=i?JSON.parse(i):void 0;if(!b||!c||!d)return{success:!1,error:"Missing required fields"};let k=await f.prisma.subject.findUnique({where:{id:parseInt(d)},include:{program:{include:{board:!0}}}});if(!k)return{success:!1,error:"Subject not found"};let l=k.program.board_id,m=h.includes("GLOBAL"),n=m?[]:h.length>0?h.filter(a=>"GLOBAL"!==a):[l],o=Buffer.from(await b.arrayBuffer()),p=await f.prisma.chapter.create({data:{title:c,subject_id:parseInt(d),chapter_number:g?parseInt(g):null,content_json:[],accessible_boards:n,is_global:m,is_active:!0,processing_status:"PENDING"}});return setImmediate(async()=>{try{await (0,e.processChapterBackground)({chapterId:p.id.toString(),pdfBuffer:o,fileName:b.name,questionConfig:j})}catch(a){console.error(`Failed to process chapter ${p.id}:`,a)}}),{success:!0,message:"Chapter created - Processing in background",chapterId:p.id.toString()}}catch(a){return console.error("Error ingesting chapter:",a),{success:!1,error:a.message||"Failed to ingest chapter"}}}[e]=k.then?(await k)():k,(0,j.ensureServerEntryExports)([l,m]),(0,d.registerServerReference)(l,"4008add61ba6e0f825c8aa3f65c3c51dc87e9799fa",null),(0,d.registerServerReference)(m,"4054eccc7d78f138ed33536b4ab6af09891ec8d3ce",null),a.s(["batchCreateChaptersAsync",()=>l,"ingestChapterAsync",()=>m]),c()}catch(a){c(a)}},!1),475292,a=>a.a(async(b,c)=>{try{var d=a.i(336413),e=b([d]);[d]=e.then?(await e)():e,a.s([]),c()}catch(a){c(a)}},!1),187143,a=>a.a(async(b,c)=>{try{var d=a.i(475292),e=a.i(336413),f=b([d,e]);[d,e]=f.then?(await f)():f,a.s(["4008add61ba6e0f825c8aa3f65c3c51dc87e9799fa",()=>e.batchCreateChaptersAsync,"4054eccc7d78f138ed33536b4ab6af09891ec8d3ce",()=>e.ingestChapterAsync]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=_20cb8860._.js.map