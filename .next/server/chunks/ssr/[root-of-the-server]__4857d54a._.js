module.exports=[442461,a=>a.a(async(b,c)=>{try{let b=await a.y("@xenova/transformers");a.n(b),c()}catch(a){c(a)}},!0),934304,a=>a.a(async(b,c)=>{try{var d=a.i(442461),e=a.i(761469),f=b([d]);[d]=f.then?(await f)():f;let g="Xenova/all-MiniLM-L6-v2";class h{static embedder=null;static async initialize(){this.embedder||(console.log(`[SEMANTIC] Initializing local embedder model: ${g}...`),this.embedder=await (0,d.pipeline)("feature-extraction",g),console.log("[SEMANTIC] Embedder initialized successfully"))}static async generateEmbedding(a){if(await this.initialize(),!a||!a.trim())throw Error("Text is required for embedding generation");let b=a.replace(/\n+/g," ").trim().substring(0,2e3);try{let a=await this.embedder(b,{pooling:"mean",normalize:!0});return Array.from(a.data)}catch(a){throw console.error("[SEMANTIC] Error generating embedding:",a),a}}static async updateSemanticVector(a){try{let b=await e.db.fileList.findUnique({where:{id:a},select:{title:!0,category:!0,note:!0}});if(!b)throw Error(`File with ID ${a} not found`);let c=`Title: ${b.title}. Category: ${b.category}. Content: ${b.note||""}`;console.log(`[SEMANTIC] Generating vector for file ${a} (${c.length} chars)...`);let d=await this.generateEmbedding(c);await e.db.$executeRaw`
				UPDATE file_list
				SET semantic_vector = ${JSON.stringify(d)}::vector
				WHERE id = ${a}
			`,console.log(`[SEMANTIC] Successfully updated vector for file ${a}`)}catch(b){console.error(`[SEMANTIC] Failed to update vector for file ${a}:`,b)}}static async generateChunkVectors(a){try{let b=await e.db.fileChunk.findMany({where:{file_id:a},select:{id:!0,content:!0}});for(let c of(console.log(`[SEMANTIC] Generating vectors for ${b.length} chunks of file ${a}...`),b))try{let a=await this.generateEmbedding(c.content);await e.db.$executeRaw`
						UPDATE file_chunks
						SET semantic_vector = ${JSON.stringify(a)}::vector
						WHERE id = ${c.id}
					`}catch(a){console.error(`[SEMANTIC] Failed to generate vector for chunk ${c.id}:`,a)}console.log(`[SEMANTIC] Successfully updated vectors for file ${a} chunks`)}catch(b){console.error(`[SEMANTIC] Failed to generate chunk vectors for file ${a}:`,b)}}static async batchUpdateSemanticVectors(){console.log("[SEMANTIC] Starting batch update for missing vectors...");let a=await e.db.$queryRaw`
			SELECT id FROM file_list WHERE semantic_vector IS NULL
		`;for(let b of(console.log(`[SEMANTIC] Found ${a.length} records to update.`),a))await this.updateSemanticVector(b.id);console.log("[SEMANTIC] Batch update completed.")}}a.s(["SemanticVectorService",()=>h]),c()}catch(a){c(a)}},!1),580949,(a,b,c)=>{"use strict";var d=Object.defineProperty,e=Object.getOwnPropertyDescriptor,f=Object.getOwnPropertyNames,g=Object.prototype.hasOwnProperty,h={},i={VercelOidcTokenError:()=>k};for(var j in i)d(h,j,{get:i[j],enumerable:!0});b.exports=((a,b,c,h)=>{if(b&&"object"==typeof b||"function"==typeof b)for(let c of f(b))g.call(a,c)||void 0===c||d(a,c,{get:()=>b[c],enumerable:!(h=e(b,c))||h.enumerable});return a})(d({},"__esModule",{value:!0}),h);class k extends Error{constructor(a,b){super(a),this.name="VercelOidcTokenError",this.cause=b}toString(){return this.cause?`${this.name}: ${this.message}: ${this.cause}`:`${this.name}: ${this.message}`}}},149047,a=>{"use strict";class b{cache=new Map;defaultTTL=36e5;get(a){let b=this.cache.get(a);return b?Date.now()>b.expiresAt?(this.cache.delete(a),null):b.value:null}set(a,b,c){let d=c??this.defaultTTL,e=Date.now()+d;this.cache.set(a,{value:b,expiresAt:e})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}cleanup(){let a=Date.now();for(let[b,c]of this.cache.entries())a>c.expiresAt&&this.cache.delete(b)}stats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}let c=new b,d="phase-production-build"===process.env.NEXT_PHASE||"phase-development-build"===process.env.NEXT_PHASE;d||(console.log("[QUIZ-CACHE] Clearing cache on server start"),c.clear()),d||setInterval(()=>{c.cleanup()},6e5),a.s(["CacheKeys",0,{chapterContext:a=>`chapter:${a}:context`,subjectContext:a=>`subject:${a}:context`},"quizCache",0,c])},603317,a=>a.a(async(b,c)=>{try{var d=a.i(137936),e=a.i(20971),f=a.i(547256),g=a.i(766518),h=a.i(742150),i=a.i(107341),j=a.i(149047),k=a.i(713095),l=b([h]);async function m(a){let b=j.CacheKeys.chapterContext(a),c=j.quizCache.get(b);if(c)return console.log(`[QUIZ-CACHE] Hit for chapter ${a}`),c;console.log(`[QUIZ-CACHE] Miss for chapter ${a}, fetching from DB`);let d=await g.prisma.chapter.findUnique({where:{id:BigInt(a)},select:{title:!0,subject:{select:{program:{select:{name:!0,board:{select:{id:!0}}}}}}}});if(!d)throw Error("Chapter not found");let e=await g.prisma.chapterChunk.findMany({where:{chapter_id:BigInt(a)},select:{content:!0,chunk_index:!0},orderBy:{chunk_index:"asc"}});console.log(`[QUIZ-CACHE] Found ${e.length} chunks for chapter ${a}`);let f=e.map(a=>a.content).join("\n\n");console.log(`[QUIZ-CACHE] Total context length: ${f.length} characters`);let h={title:d.title,context:f,board:d.subject?.program?.board?.id,level:d.subject?.program?.name};return j.quizCache.set(b,h,36e5),h}async function n(a){let b=j.CacheKeys.subjectContext(a),c=j.quizCache.get(b);if(c)return console.log(`[QUIZ-CACHE] Hit for subject ${a}`),c;console.log(`[QUIZ-CACHE] Miss for subject ${a}, fetching from DB`);let d=await g.prisma.subject.findUnique({where:{id:a},select:{program:{select:{name:!0,board:{select:{id:!0}}}}}}),e=await g.prisma.chapter.findMany({where:{subject_id:a,is_active:!0},select:{id:!0}});if(0===e.length)throw Error("No chapters found for subject");let f=Math.min(3,e.length),h=[...e].sort(()=>Math.random()-.5).slice(0,f).map(a=>a.id);console.log(`[QUIZ-CACHE] Sampling ${f} chapters for subject context`);let i=await g.prisma.chapterChunk.findMany({where:{chapter_id:{in:h}},select:{content:!0,chunk_index:!0,chapter_id:!0},orderBy:[{chapter_id:"asc"},{chunk_index:"asc"}]});console.log(`[QUIZ-CACHE] Found ${i.length} total chunks from ${f} chapters`);let k={context:i.map(a=>a.content).join("\n\n"),board:d?.program?.board?.id,level:d?.program?.name};return j.quizCache.set(b,k,18e5),k}async function o(a,b,c,d,i,j=!0){let k=await (0,e.getServerSession)(f.authOptions);if(!k?.user?.id)throw Error("Unauthorized");let l=parseInt(k.user.id);try{let e="",f="",k=[];if(b){let a=BigInt(b),h={chapter_id:a,is_active:!0};"exam"===c?h.difficulty="exam":(h.question_type={in:i},h.difficulty={in:[c,"exam"]});let l=await g.prisma.question.findMany({where:h,select:{id:!0}});if("exam"===c){if(0===l.length)throw Error("No exam questions found for this chapter. Please upload past papers first.");console.log(`[QUIZ-GEN] Found ${l.length} exam questions.`)}if("exam"!==c&&l.length<d&&!j){console.log(`[QUIZ-GEN] Not enough ${c} questions. Trying ALL difficulties from bank...`);let b=await g.prisma.question.findMany({where:{chapter_id:a,question_type:{in:i},is_active:!0},select:{id:!0}}),d=new Set(l.map(a=>a.id));for(let a of b)d.has(a.id)||(l.push(a),d.add(a.id))}if(l.length>=d||"exam"===c&&l.length>0){console.log(`[QUIZ-GEN] Found ${l.length} questions in bank for chapter ${b}. Using Bank.`);let h=l.sort(()=>.5-Math.random()).slice(0,d).map(a=>a.id);k=(await g.prisma.question.findMany({where:{id:{in:h}}})).map(a=>({question_text:a.question_text,question_type:a.question_type,options:a.options?a.options:void 0,correct_answer:a.correct_answer,points:a.points,explanation:a.explanation||"Correct answer"}));let i=await g.prisma.chapter.findUnique({where:{id:a},select:{title:!0}});e=`${i?.title||"Chapter"} Quiz`,f=`A ${c} difficulty quiz on ${i?.title}`}else{if(console.log(`[QUIZ-GEN] Not enough questions in bank (${l.length}/${d}).`),!j)throw Error(`Not enough questions in the Question Bank for this chapter. Found ${l.length}, needed ${d}. Please contact admin.`);console.log("[QUIZ-GEN] Falling back to AI.")}}if(0===k.length){if(!j)throw Error("AI generation is disabled for this request (Battle Mode). Please select a chapter with existing questions.");let l="",o="",p="",q="",r=await g.prisma.subject.findUnique({where:{id:a},select:{name:!0}});if(!r)throw Error("Subject not found");let s=r.name;if(b){let a=await m(b);o=a.title,l=a.context,p=a.board||"",q=a.level||""}else{o="General Review";let b=await n(a);l=b.context,p=b.board||"",q=b.level||""}if(!l||l.trim().length<200)throw Error("Insufficient content available for quiz generation. Please ensure the chapter has content.");let t={subject:s,topic:o,difficulty:c,questionCount:d,questionTypes:i,context:l},u=await (0,h.generateQuiz)(t,{board:p,level:q});k=u.questions,e=u.title,f=u.description}let o=await g.prisma.quiz.create({data:{user_id:l,subject_id:a,chapter_id:b?BigInt(b):null,title:e,description:f,total_points:k.reduce((a,b)=>a+b.points,0),questions:{create:k.map(a=>({question_text:a.question_text,question_type:a.question_type,options:a.options?a.options:void 0,correct_answer:a.correct_answer,points:a.points,explanation:a.explanation}))}},include:{questions:!0}});return{...o,chapter_id:o.chapter_id?.toString()||null,questions:o.questions.map(a=>({...a,correct_answer:null,explanation:null}))}}catch(a){throw console.error("Error in generateQuizAction:",a),Error(a.message||"Failed to generate quiz")}}async function p(b,c){let d=await (0,e.getServerSession)(f.authOptions);if(!d?.user?.id)throw Error("Unauthorized");let i=parseInt(d.user.id);try{let d=await g.prisma.quiz.findUnique({where:{id:b},include:{questions:!0}});if(!d)throw Error("Quiz not found");if(d.user_id!==i)throw Error("Unauthorized");if("COMPLETED"===d.status)return{success:!0,score:d.score,totalPoints:d.total_points};let e=0,f=[],j=[];for(let a of d.questions){let b=c[a.id],d=!1,h=0;if(["SHORT_ANSWER","LONG_ANSWER"].includes(a.question_type)){j.push({id:a.id,question_text:a.question_text,user_answer:String(b),correct_answer:String(a.correct_answer),type:a.question_type,max_points:a.points});continue}{let c=a.correct_answer,e=Array.isArray(b)?b:[b],f=Array.isArray(c)?c:[c],g=new Set(f.map(a=>String(a).trim())),i=new Set(e.map(a=>String(a).trim()));g.size===i.size&&[...g].every(a=>i.has(a))&&(d=!0,h=a.points)}e+=h,f.push(g.prisma.quizQuestion.update({where:{id:a.id},data:{user_answer:b,is_correct:d}}))}if(j.length>0)for(let a of(await (0,h.gradeQuiz)(j))){let b=j.find(b=>b.question_text===a.question_text);if(b){let c=Math.round(a.score_percentage/100*b.max_points);e+=c,f.push(g.prisma.quizQuestion.update({where:{id:b.id},data:{user_answer:b.user_answer,is_correct:a.is_correct,feedback:a.feedback}}))}}if(await g.prisma.$transaction(f),await g.prisma.quiz.update({where:{id:b},data:{status:"COMPLETED",score:e,completed_at:new Date}}),e>0){await g.prisma.userPoints.create({data:{user_id:i,points:e,reason:"quiz_completion",metadata:{quiz_id:b,title:d.title}}});let{calculateStreak:c,checkAndAwardBadges:f}=await a.A(506844),h=await c(i);await f(i,h)}return{success:!0,score:e,totalPoints:d.total_points}}catch(a){throw console.error("Error submitting quiz:",a),Error("Failed to submit quiz")}}async function q(a=10){try{let b=await g.prisma.userPoints.groupBy({by:["user_id"],_sum:{points:!0},orderBy:{_sum:{points:"desc"}},take:a}),c=b.map(a=>a.user_id),d=await g.prisma.user.findMany({where:{id:{in:c}},select:{id:!0,username:!0}});return b.map(a=>{let b=d.find(b=>b.id===a.user_id);return{userId:a.user_id,username:b?.username||"Unknown User",points:a._sum.points||0}})}catch(a){throw console.error("Error fetching leaderboard:",a),Error("Failed to fetch leaderboard")}}async function r(){let a=await (0,e.getServerSession)(f.authOptions);if(!a?.user?.id)throw Error("Unauthorized");let b=parseInt(a.user.id);try{let a=(await g.prisma.userPoints.aggregate({where:{user_id:b},_sum:{points:!0}}))._sum.points||0,c=await g.prisma.quiz.count({where:{user_id:b,status:"COMPLETED"}}),d=await g.prisma.quiz.findMany({where:{user_id:b,status:"COMPLETED"},select:{score:!0,total_points:!0}}),e=d.length>0?d.reduce((a,b)=>a+b.score/b.total_points*100,0)/d.length:0,f=(await g.prisma.userPoints.groupBy({by:["user_id"],_sum:{points:!0},orderBy:{_sum:{points:"desc"}}})).findIndex(a=>a.user_id===b)+1,h=await g.prisma.userPoints.findMany({where:{user_id:b},orderBy:{created_at:"desc"},take:10,select:{points:!0,reason:!0,created_at:!0,metadata:!0}});return{totalPoints:a,rank:f||null,quizCount:c,avgScore:Math.round(e),recentPoints:h.map(a=>({...a,created_at:a.created_at.toISOString()}))}}catch(a){throw console.error("Error fetching user stats:",a),Error("Failed to fetch user stats")}}async function s(){let a=await (0,e.getServerSession)(f.authOptions);if(!a?.user?.id)return null;let b=parseInt(a.user.id);try{return await g.prisma.quiz.findMany({where:{user_id:b,status:i.QuizStatus.COMPLETED},include:{subject:{select:{name:!0}},chapter:{select:{title:!0}}},orderBy:{completed_at:"desc"}})}catch(a){throw console.error("Error fetching quiz history:",a),Error("Failed to fetch quiz history")}}[h]=l.then?(await l)():l,(0,k.ensureServerEntryExports)([o,p,q,r,s]),(0,d.registerServerReference)(o,"7e436d76fae84b2adc9acd9af9d6625a080aa95db8",null),(0,d.registerServerReference)(p,"600ef7fe9124c6ac15b9cd02f970afcd29310d2e4b",null),(0,d.registerServerReference)(q,"40609e2848cfc38069b1f5e6d1e4701c0ca1ac2afb",null),(0,d.registerServerReference)(r,"00e85743d2f680688f9389d762d8a19e394bbe6e25",null),(0,d.registerServerReference)(s,"0057a1df77156afe118963654aa92392f4f8709948",null),a.s(["generateQuizAction",()=>o,"getLeaderboardAction",()=>q,"getQuizHistory",()=>s,"getUserStatsAction",()=>r,"submitQuizAction",()=>p]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__4857d54a._.js.map