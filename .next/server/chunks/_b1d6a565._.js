module.exports=[880643,e=>e.a(async(t,r)=>{try{var i=e.i(745015),a=e.i(757660),n=e.i(856292),s=e.i(698043),o=e.i(946502),u=e.i(660724),l=e.i(257474),c=e.i(195975),d=t([o]);async function p(e){let t=l.CacheKeys.chapterContext(e),r=l.quizCache.get(t);if(r)return console.log(`[QUIZ-CACHE] Hit for chapter ${e}`),r;console.log(`[QUIZ-CACHE] Miss for chapter ${e}, fetching from DB`);let i=await s.prisma.chapter.findUnique({where:{id:BigInt(e)},select:{title:!0,subject:{select:{program:{select:{name:!0,board:{select:{id:!0}}}}}}}});if(!i)throw Error("Chapter not found");let a=await s.prisma.chapterChunk.findMany({where:{chapter_id:BigInt(e)},select:{content:!0,chunk_index:!0},orderBy:{chunk_index:"asc"}});console.log(`[QUIZ-CACHE] Found ${a.length} chunks for chapter ${e}`);let n=a.map(e=>e.content).join("\n\n");console.log(`[QUIZ-CACHE] Total context length: ${n.length} characters`);let o={title:i.title,context:n,board:i.subject?.program?.board?.id,level:i.subject?.program?.name};return l.quizCache.set(t,o,36e5),o}async function h(e){let t=l.CacheKeys.subjectContext(e),r=l.quizCache.get(t);if(r)return console.log(`[QUIZ-CACHE] Hit for subject ${e}`),r;console.log(`[QUIZ-CACHE] Miss for subject ${e}, fetching from DB`);let i=await s.prisma.subject.findUnique({where:{id:e},select:{program:{select:{name:!0,board:{select:{id:!0}}}}}}),a=await s.prisma.chapter.findMany({where:{subject_id:e,is_active:!0},select:{id:!0}});if(0===a.length)throw Error("No chapters found for subject");let n=Math.min(3,a.length),o=[...a].sort(()=>Math.random()-.5).slice(0,n).map(e=>e.id);console.log(`[QUIZ-CACHE] Sampling ${n} chapters for subject context`);let u=await s.prisma.chapterChunk.findMany({where:{chapter_id:{in:o}},select:{content:!0,chunk_index:!0,chapter_id:!0},orderBy:[{chapter_id:"asc"},{chunk_index:"asc"}]});console.log(`[QUIZ-CACHE] Found ${u.length} total chunks from ${n} chapters`);let c={context:u.map(e=>e.content).join("\n\n"),board:i?.program?.board?.id,level:i?.program?.name};return l.quizCache.set(t,c,18e5),c}async function f(e,t,r,i,u,l=!0){let c=await (0,a.getServerSession)(n.authOptions);if(!c?.user?.id)throw Error("Unauthorized");let d=parseInt(c.user.id);try{let a="",n="",c=[];if(t){let e=BigInt(t),o={chapter_id:e,is_active:!0};"exam"===r?o.difficulty="exam":(o.question_type={in:u},o.difficulty={in:[r,"exam"]});let d=await s.prisma.question.findMany({where:o,select:{id:!0}});if("exam"===r){if(0===d.length)throw Error("No exam questions found for this chapter. Please upload past papers first.");console.log(`[QUIZ-GEN] Found ${d.length} exam questions.`)}if("exam"!==r&&d.length<i&&!l){console.log(`[QUIZ-GEN] Not enough ${r} questions. Trying ALL difficulties from bank...`);let t=await s.prisma.question.findMany({where:{chapter_id:e,question_type:{in:u},is_active:!0},select:{id:!0}}),i=new Set(d.map(e=>e.id));for(let e of t)i.has(e.id)||(d.push(e),i.add(e.id))}if(d.length>=i||"exam"===r&&d.length>0){console.log(`[QUIZ-GEN] Found ${d.length} questions in bank for chapter ${t}. Using Bank.`);let o=d.sort(()=>.5-Math.random()).slice(0,i).map(e=>e.id);c=(await s.prisma.question.findMany({where:{id:{in:o}}})).map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.options?e.options:void 0,correct_answer:e.correct_answer,points:e.points,explanation:e.explanation||"Correct answer"}));let u=await s.prisma.chapter.findUnique({where:{id:e},select:{title:!0}});a=`${u?.title||"Chapter"} Quiz`,n=`A ${r} difficulty quiz on ${u?.title}`}else{if(console.log(`[QUIZ-GEN] Not enough questions in bank (${d.length}/${i}).`),!l)throw Error(`Not enough questions in the Question Bank for this chapter. Found ${d.length}, needed ${i}. Please contact admin.`);console.log("[QUIZ-GEN] Falling back to AI.")}}if(0===c.length){if(!l)throw Error("AI generation is disabled for this request (Battle Mode). Please select a chapter with existing questions.");let d="",f="",w="",m="",g=await s.prisma.subject.findUnique({where:{id:e},select:{name:!0}});if(!g)throw Error("Subject not found");let _=g.name;if(t){let e=await p(t);f=e.title,d=e.context,w=e.board||"",m=e.level||""}else{f="General Review";let t=await h(e);d=t.context,w=t.board||"",m=t.level||""}if(!d||d.trim().length<200)throw Error("Insufficient content available for quiz generation. Please ensure the chapter has content.");let q={subject:_,topic:f,difficulty:r,questionCount:i,questionTypes:u,context:d},y=await (0,o.generateQuiz)(q,{board:w,level:m});c=y.questions,a=y.title,n=y.description}let f=await s.prisma.quiz.create({data:{user_id:d,subject_id:e,chapter_id:t?BigInt(t):null,title:a,description:n,total_points:c.reduce((e,t)=>e+t.points,0),questions:{create:c.map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.options?e.options:void 0,correct_answer:e.correct_answer,points:e.points,explanation:e.explanation}))}},include:{questions:!0}});return{...f,chapter_id:f.chapter_id?.toString()||null,questions:f.questions.map(e=>({...e,correct_answer:null,explanation:null}))}}catch(e){throw console.error("Error in generateQuizAction:",e),Error(e.message||"Failed to generate quiz")}}async function w(t,r){let i=await (0,a.getServerSession)(n.authOptions);if(!i?.user?.id)throw Error("Unauthorized");let u=parseInt(i.user.id);try{let i=await s.prisma.quiz.findUnique({where:{id:t},include:{questions:!0}});if(!i)throw Error("Quiz not found");if(i.user_id!==u)throw Error("Unauthorized");if("COMPLETED"===i.status)return{success:!0,score:i.score,totalPoints:i.total_points};let a=0,n=[],l=[];for(let e of i.questions){let t=r[e.id],i=!1,o=0;if(["SHORT_ANSWER","LONG_ANSWER"].includes(e.question_type)){l.push({id:e.id,question_text:e.question_text,user_answer:String(t),correct_answer:String(e.correct_answer),type:e.question_type,max_points:e.points});continue}{let r=e.correct_answer,a=Array.isArray(t)?t:[t],n=Array.isArray(r)?r:[r],s=new Set(n.map(e=>String(e).trim())),u=new Set(a.map(e=>String(e).trim()));s.size===u.size&&[...s].every(e=>u.has(e))&&(i=!0,o=e.points)}a+=o,n.push(s.prisma.quizQuestion.update({where:{id:e.id},data:{user_answer:t,is_correct:i}}))}if(l.length>0)for(let e of(await (0,o.gradeQuiz)(l))){let t=l.find(t=>t.question_text===e.question_text);if(t){let r=Math.round(e.score_percentage/100*t.max_points);a+=r,n.push(s.prisma.quizQuestion.update({where:{id:t.id},data:{user_answer:t.user_answer,is_correct:e.is_correct,feedback:e.feedback}}))}}if(await s.prisma.$transaction(n),await s.prisma.quiz.update({where:{id:t},data:{status:"COMPLETED",score:a,completed_at:new Date}}),a>0){await s.prisma.userPoints.create({data:{user_id:u,points:a,reason:"quiz_completion",metadata:{quiz_id:t,title:i.title}}});let{calculateStreak:r,checkAndAwardBadges:n}=await e.A(28930),o=await r(u);await n(u,o)}return{success:!0,score:a,totalPoints:i.total_points}}catch(e){throw console.error("Error submitting quiz:",e),Error("Failed to submit quiz")}}async function m(e=10){try{let t=await s.prisma.userPoints.groupBy({by:["user_id"],_sum:{points:!0},orderBy:{_sum:{points:"desc"}},take:e}),r=t.map(e=>e.user_id),i=await s.prisma.user.findMany({where:{id:{in:r}},select:{id:!0,username:!0}});return t.map(e=>{let t=i.find(t=>t.id===e.user_id);return{userId:e.user_id,username:t?.username||"Unknown User",points:e._sum.points||0}})}catch(e){throw console.error("Error fetching leaderboard:",e),Error("Failed to fetch leaderboard")}}async function g(){let e=await (0,a.getServerSession)(n.authOptions);if(!e?.user?.id)throw Error("Unauthorized");let t=parseInt(e.user.id);try{let e=(await s.prisma.userPoints.aggregate({where:{user_id:t},_sum:{points:!0}}))._sum.points||0,r=await s.prisma.quiz.count({where:{user_id:t,status:"COMPLETED"}}),i=await s.prisma.quiz.findMany({where:{user_id:t,status:"COMPLETED"},select:{score:!0,total_points:!0}}),a=i.length>0?i.reduce((e,t)=>e+t.score/t.total_points*100,0)/i.length:0,n=(await s.prisma.userPoints.groupBy({by:["user_id"],_sum:{points:!0},orderBy:{_sum:{points:"desc"}}})).findIndex(e=>e.user_id===t)+1,o=await s.prisma.userPoints.findMany({where:{user_id:t},orderBy:{created_at:"desc"},take:10,select:{points:!0,reason:!0,created_at:!0,metadata:!0}});return{totalPoints:e,rank:n||null,quizCount:r,avgScore:Math.round(a),recentPoints:o.map(e=>({...e,created_at:e.created_at.toISOString()}))}}catch(e){throw console.error("Error fetching user stats:",e),Error("Failed to fetch user stats")}}async function _(){let e=await (0,a.getServerSession)(n.authOptions);if(!e?.user?.id)return null;let t=parseInt(e.user.id);try{return await s.prisma.quiz.findMany({where:{user_id:t,status:u.QuizStatus.COMPLETED},include:{subject:{select:{name:!0}},chapter:{select:{title:!0}}},orderBy:{completed_at:"desc"}})}catch(e){throw console.error("Error fetching quiz history:",e),Error("Failed to fetch quiz history")}}[o]=d.then?(await d)():d,(0,c.ensureServerEntryExports)([f,w,m,g,_]),(0,i.registerServerReference)(f,"7e436d76fae84b2adc9acd9af9d6625a080aa95db8",null),(0,i.registerServerReference)(w,"600ef7fe9124c6ac15b9cd02f970afcd29310d2e4b",null),(0,i.registerServerReference)(m,"40609e2848cfc38069b1f5e6d1e4701c0ca1ac2afb",null),(0,i.registerServerReference)(g,"00e85743d2f680688f9389d762d8a19e394bbe6e25",null),(0,i.registerServerReference)(_,"0057a1df77156afe118963654aa92392f4f8709948",null),e.s(["generateQuizAction",()=>f]),r()}catch(e){r(e)}},!1),285468,e=>e.a(async(t,r)=>{try{var i=e.i(89171),a=e.i(757660),n=e.i(856292),s=e.i(260819),o=e.i(880643),u=e.i(698043),l=t([o]);async function c(e){try{let t=await (0,a.getServerSession)(n.authOptions);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=parseInt(t.user.id),{battleId:l}=await e.json();if(!l)return i.NextResponse.json({error:"Battle ID required"},{status:400});let c=await u.prisma.battle.findUnique({where:{id:l},include:{quiz:{select:{subject_id:!0,chapter_id:!0,questions:{take:1,select:{question_type:!0}}}},participants:!0}});if(!c)return i.NextResponse.json({error:"Battle not found"},{status:404});if(!c.participants.some(e=>e.user_id===r))return i.NextResponse.json({error:"Not a participant"},{status:403});let d=c.participants.find(e=>e.user_id!==r);if(!d)return i.NextResponse.json({error:"Opponent not found"},{status:404});let p=new Date(Date.now()-3e5),h=await u.prisma.battle.findFirst({where:{created_by:d.user_id,status:"WAITING",created_at:{gte:p},quiz:{subject_id:c.quiz.subject_id,chapter_id:c.quiz.chapter_id},participants:{every:{user_id:d.user_id}}},include:{quiz:{include:{questions:!0}},participants:{include:{user:!0}}},orderBy:{created_at:"desc"}});if(h&&1===h.participants.length){console.log(`[REMATCH] Auto-joining opponent's battle: ${h.id}`),await s.BattleService.joinBattle(r,h.code);let e=await u.prisma.battle.findUnique({where:{id:h.id},include:{participants:{include:{user:!0}},quiz:{include:{questions:!0}}}});if(!e)return i.NextResponse.json({error:"Failed to fetch joined battle"},{status:500});let t={...e,quiz:{...e.quiz,chapter_id:e.quiz.chapter_id?.toString()||null,questions:e.quiz.questions.map(e=>({...e,quiz_id:e.quiz_id?.toString()||null}))}};return i.NextResponse.json({success:!0,battleId:e.id,battle:t,autoJoined:!0})}console.log(`[REMATCH] Creating new battle for user ${r}`);let f=await (0,o.generateQuizAction)(c.quiz.subject_id,c.quiz.chapter_id?Number(c.quiz.chapter_id):null,"medium",5,["MCQ"],!1),w=await s.BattleService.rematchBattle(l,f.id,r),m={...w,quiz:{...w.quiz,chapter_id:w.quiz.chapter_id?.toString()||null,questions:w.quiz.questions.map(e=>({...e,quiz_id:e.quiz_id?.toString()||null}))}};return i.NextResponse.json({success:!0,battleId:w.id,battle:m})}catch(e){return console.error("[BATTLE REMATCH] Error:",e),i.NextResponse.json({error:e.message||"Failed to create rematch"},{status:500})}}[o]=l.then?(await l)():l,e.s(["POST",()=>c]),r()}catch(e){r(e)}},!1),26229,e=>e.a(async(t,r)=>{try{var i=e.i(747909),a=e.i(174017),n=e.i(996250),s=e.i(759756),o=e.i(561916),u=e.i(114444),l=e.i(837092),c=e.i(869741),d=e.i(316795),p=e.i(487718),h=e.i(995169),f=e.i(47587),w=e.i(666012),m=e.i(570101),g=e.i(626937),_=e.i(10372),q=e.i(193695);e.i(52474);var y=e.i(257297),E=e.i(285468),b=t([E]);[E]=b.then?(await b)():b;let v=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/battle/rematch/route",pathname:"/api/battle/rematch",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/battle/rematch/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:C,workUnitAsyncStorage:S,serverHooks:z}=v;function R(){return(0,n.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:S})}async function x(e,t,r){v.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/battle/rematch/route";i=i.replace(/\/index$/,"")||"/";let n=await v.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:E,params:b,nextConfig:R,parsedUrl:x,isDraftMode:C,prerenderManifest:S,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,resolvedPathname:N,clientReferenceManifest:U,serverActionsManifest:M}=n,j=(0,c.normalizeAppPath)(i),P=!!(S.dynamicRoutes[j]||S.routes[N]),T=async()=>((null==z?void 0:z.render404)?await z.render404(e,t,x,!1):t.end("This page could not be found"),null);if(P&&!C){let e=!!S.routes[N],t=S.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await T();throw new q.NoFallbackError}}let O=null;!P||v.isDev||C||(O=N,O="/index"===O?"/":O);let k=!0===v.isDev||!P,$=P&&!k;M&&U&&(0,u.setReferenceManifestsSingleton)({page:i,clientReferenceManifest:U,serverActionsManifest:M,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:M})});let H=e.method||"GET",B=(0,o.getTracer)(),Q=B.getActiveScopeSpan(),D={params:b,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i)=>v.onRequestError(e,t,i,z)},sharedContext:{buildId:E}},F=new d.NodeNextRequest(e),L=new d.NodeNextResponse(t),Z=p.NextRequestAdapter.fromNodeNextRequest(F,(0,p.signalFromNodeResponse)(t));try{let n=async e=>v.handle(Z,D).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${i}`)}),u=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var o,l;let c=async({previousCacheEntry:a})=>{try{if(!u&&A&&I&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(s);e.fetchMetrics=D.renderOpts.fetchMetrics;let o=D.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let l=D.renderOpts.collectedTags;if(!P)return await (0,w.sendResponse)(F,L,i,D.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[_.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==D.renderOpts.collectedRevalidate&&!(D.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&D.renderOpts.collectedRevalidate,a=void 0===D.renderOpts.collectedExpire||D.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:D.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:A})},z),t}},d=await v.handleResponse({req:e,nextConfig:R,cacheKey:O,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:u});if(!P)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return u&&P||p.delete(_.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,w.sendResponse)(F,L,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};Q?await l(Q):await B.withPropagatedContext(e.headers,()=>B.trace(h.BaseServerSpan.handleRequest,{spanName:`${H} ${i}`,kind:o.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof q.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:A})}),P)throw t;return await (0,w.sendResponse)(F,L,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>R,"routeModule",()=>v,"serverHooks",()=>z,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>S]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_b1d6a565._.js.map