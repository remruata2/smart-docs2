module.exports=[948751,e=>e.a(async(t,r)=>{try{var a=e.i(89171),s=e.i(757660),n=e.i(856292),o=e.i(946502),i=e.i(341890),l=e.i(249526),u=e.i(219166),d=e.i(237295),c=e.i(660724),p=t([o]);async function h(e){try{let t=await (0,s.getServerSession)(n.authOptions);if(!t?.user)return a.NextResponse.json({error:"Authentication required"},{status:401});let r=parseInt(t.user.id),p=t.user.email,h=await (0,u.enforceUsageLimit)(c.UsageType.chat_message,r);if(!h.success)return a.NextResponse.json({error:h.error,limitExceeded:!0},{status:h.status});let g=p||t.user.id||"unknown",R=await i.chatRateLimiter.check(g);if(!R.allowed)return a.NextResponse.json({error:`Rate limit exceeded. You can make ${R.remaining} more requests. Try again in ${Math.ceil(R.resetIn/1e3)} seconds.`,errorCode:"RATE_LIMIT_EXCEEDED",resetAt:R.resetAt},{status:429});let y=await e.json(),{message:f,provider:m,model:v,keyId:E,stream:A,boardId:C,subjectId:w,chapterId:x}=y,T=y.conversationHistory;if(!f||"string"!=typeof f)return a.NextResponse.json({error:"Message is required and must be a string"},{status:400});if(0===f.trim().length)return a.NextResponse.json({error:"Message cannot be empty"},{status:400});if(f.length>1e3)return a.NextResponse.json({error:"Message is too long (max 1000 characters)"},{status:400});let N=(0,l.sanitizeAIInput)(f,1e3);N.removedPatterns.length>0&&console.warn(`[SECURITY] Sanitized input for user ${g}. Removed patterns:`,N.removedPatterns);let S=N.sanitized;if(T){let e=(0,l.validateConversationHistory)(T,50,1e3);if(!e.valid)return a.NextResponse.json({error:e.error},{status:400});T=e.sanitized}let D={};if(m){if("gemini"!==m)return a.NextResponse.json({error:"Unsupported provider. Currently only 'gemini' is supported."},{status:400});D.provider=m}if(v&&"string"==typeof v&&(D.model=v),void 0!==E){let e=Number(E);if(!Number.isFinite(e))return a.NextResponse.json({error:"keyId must be a number"},{status:400});D.keyId=e}let b={boardId:C||"CBSE"};if(w&&(b.subjectId=Number(w)),x&&(b.chapterId=Number(x)),console.log(`[DASHBOARD CHAT] User ${p} asked a question (length: ${S.length})`),A){console.log("[DASHBOARD CHAT] Using streaming mode");let e=new TextEncoder,t=new ReadableStream({async start(t){try{let a=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s={},n=[],i={},l=null;for await(let r of(0,o.processChatMessageEnhancedStream)(S,T||[],void 0,!0,D,b))if("metadata"===r.type){s={searchQuery:r.searchQuery,searchMethod:r.searchMethod,queryType:r.queryType,analysisUsed:r.analysisUsed,stats:r.stats};let a=JSON.stringify({type:"metadata",...s});t.enqueue(e.encode(`data: ${a}

`))}else if("progress"===r.type){let a=JSON.stringify({type:"progress",progress:r.progress});t.enqueue(e.encode(`data: ${a}

`))}else if("token"===r.type){let a=JSON.stringify({type:"token",text:r.text});t.enqueue(e.encode(`data: ${a}

`))}else if("sources"===r.type){n=r.sources||[];let a=JSON.stringify({type:"sources",sources:n});t.enqueue(e.encode(`data: ${a}

`))}else if("data"===r.type){l=r.chartData,console.log("[CHART API] Received chart data chunk:",JSON.stringify(l,null,2));let a=JSON.stringify({type:"data",chartData:l});console.log("[CHART API] Sending data event to frontend"),t.enqueue(e.encode(`data: ${a}

`))}else if("done"===r.type){i=r.tokenCount||{},console.log("[CHART API] Done event - chartData:",l?"present":"missing");let s=JSON.stringify({type:"done",tokenCount:i,messageId:a,chartData:l});t.enqueue(e.encode(`data: ${s}

`))}await (0,d.trackUsage)(r,c.UsageType.chat_message),t.close()}catch(a){console.error("[DASHBOARD CHAT] Streaming error:",a);let r=JSON.stringify({type:"error",error:"Failed to process your question. Please try again."});t.enqueue(e.encode(`data: ${r}

`)),t.close()}}});return new a.NextResponse(t,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}{let e=await (0,o.processChatMessageEnhanced)(S,T||[],void 0,!0,D,b);return Date.now(),Math.random().toString(36).substr(2,9),e.response,e.sources,e.tokenCount,console.log(`[DASHBOARD CHAT] Response generated with ${e.sources.length} sources`),await (0,d.trackUsage)(r,c.UsageType.chat_message),a.NextResponse.json({response:e.response,sources:e.sources,searchQuery:e.searchQuery,searchMethod:e.searchMethod,queryType:e.queryType,analysisUsed:e.analysisUsed,tokenCount:e.tokenCount,stats:e.stats,chartData:e.chartData})}}catch(e){if(console.error("[DASHBOARD CHAT] Error processing chat message:",e),"RATE_LIMIT_EXCEEDED"===e.message)return a.NextResponse.json({success:!1,error:"You are asking too fast, please try again after some time.",errorCode:"RATE_LIMIT_EXCEEDED"},{status:429});return e instanceof Error&&e.message,a.NextResponse.json({success:!1,error:"Failed to process your question. Please try again.",details:void 0},{status:500})}}async function g(e){try{let e=await (0,s.getServerSession)(n.authOptions);if(!e?.user)return a.NextResponse.json({error:"Authentication required"},{status:401});return a.NextResponse.json({success:!0,message:"Dashboard AI Chat API is available",user:e.user.email,timestamp:new Date().toISOString()})}catch(e){return console.error("[DASHBOARD CHAT] Error in GET endpoint:",e),a.NextResponse.json({success:!1,error:"API endpoint error"},{status:500})}}[o]=p.then?(await p)():p,e.s(["GET",()=>g,"POST",()=>h]),r()}catch(e){r(e)}},!1),603378,e=>e.a(async(t,r)=>{try{var a=e.i(747909),s=e.i(174017),n=e.i(996250),o=e.i(759756),i=e.i(561916),l=e.i(114444),u=e.i(837092),d=e.i(869741),c=e.i(316795),p=e.i(487718),h=e.i(995169),g=e.i(47587),R=e.i(666012),y=e.i(570101),f=e.i(626937),m=e.i(10372),v=e.i(193695);e.i(52474);var E=e.i(257297),A=e.i(948751),C=t([A]);[A]=C.then?(await C)():C;let T=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/dashboard/chat/route",pathname:"/api/dashboard/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/dashboard/chat/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:N,workUnitAsyncStorage:S,serverHooks:D}=T;function w(){return(0,n.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:S})}async function x(e,t,r){T.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/dashboard/chat/route";a=a.replace(/\/index$/,"")||"/";let n=await T.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:A,params:C,nextConfig:w,parsedUrl:x,isDraftMode:N,prerenderManifest:S,routerServerContext:D,isOnDemandRevalidate:b,revalidateOnlyGenerated:O,resolvedPathname:I,clientReferenceManifest:H,serverActionsManifest:P}=n,q=(0,d.normalizeAppPath)(a),M=!!(S.dynamicRoutes[q]||S.routes[I]),_=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,x,!1):t.end("This page could not be found"),null);if(M&&!N){let e=!!S.routes[I],t=S.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await _();throw new v.NoFallbackError}}let k=null;!M||T.isDev||N||(k=I,k="/index"===k?"/":k);let U=!0===T.isDev||!M,j=M&&!U;P&&H&&(0,l.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:H,serverActionsManifest:P,serverModuleMap:(0,u.createServerModuleMap)({serverActionsManifest:P})});let $=e.method||"GET",B=(0,i.getTracer)(),F=B.getActiveScopeSpan(),L={params:C,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>T.onRequestError(e,t,a,D)},sharedContext:{buildId:A}},J=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),X=p.NextRequestAdapter.fromNodeNextRequest(J,(0,p.signalFromNodeResponse)(t));try{let n=async e=>T.handle(X,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${$} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${a}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),u=async o=>{var i,u;let d=async({previousCacheEntry:s})=>{try{if(!l&&b&&O&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(o);e.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let u=L.renderOpts.collectedTags;if(!M)return await (0,R.sendResponse)(J,K,a,L.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,s=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:b})},D),t}},c=await T.handleResponse({req:e,nextConfig:w,cacheKey:k,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:l});if(!M)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",b?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,y.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&M||p.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,R.sendResponse)(J,K,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};F?await u(F):await B.withPropagatedContext(e.headers,()=>B.trace(h.BaseServerSpan.handleRequest,{spanName:`${$} ${a}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},u))}catch(t){if(t instanceof v.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:b})}),M)throw t;return await (0,R.sendResponse)(J,K,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>w,"routeModule",()=>T,"serverHooks",()=>D,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>S]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_36c2376e._.js.map