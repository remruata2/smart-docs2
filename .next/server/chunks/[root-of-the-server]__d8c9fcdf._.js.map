{"version":3,"sources":["../../../src/lib/db.ts","../../../src/lib/prisma.ts","turbopack:///[project]/node_modules/openid-client/package.json","../../../node_modules/next-auth/core/types.js","../../../node_modules/next-auth/index.js","../../../src/lib/usage-limits.ts","../../../src/lib/usage-tracking.ts","../../../src/services/subscription-service.ts","../../../node_modules/date-fns/constants.js","../../../node_modules/date-fns/constructFrom.js","../../../node_modules/date-fns/toDate.js","../../../node_modules/date-fns/startOfMonth.js","../../../node_modules/date-fns/endOfMonth.js","../../../src/lib/semantic-vector.ts","../../../node_modules/%40vercel/oidc/dist/token-error.js","../../../src/lib/app-settings.ts","../../../src/lib/input-sanitizer.ts","../../../src/lib/rate-limiter.ts"],"sourcesContent":["import { PrismaClient } from '../generated/prisma';\n\n// Define the global type for PrismaClient\ndeclare global {\n  var prisma: PrismaClient | undefined;\n}\n\n// PrismaClient is attached to the `global` object in development to prevent\n// exhausting your database connection limit.\nexport const db = global.prisma || new PrismaClient();\n\n// In development, keep the connection alive between hot reloads\nif (process.env.NODE_ENV !== 'production') global.prisma = db;\n","import { db } from \"./db\";\n\nexport const prisma = db;\nexport default prisma;\n","{\"name\":\"openid-client\",\"version\":\"5.7.1\",\"description\":\"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs\",\"keywords\":[\"auth\",\"authentication\",\"basic\",\"certified\",\"client\",\"connect\",\"dynamic\",\"electron\",\"hybrid\",\"identity\",\"implicit\",\"oauth\",\"oauth2\",\"oidc\",\"openid\",\"passport\",\"relying party\",\"strategy\"],\"homepage\":\"https://github.com/panva/openid-client\",\"repository\":\"panva/openid-client\",\"funding\":{\"url\":\"https://github.com/sponsors/panva\"},\"license\":\"MIT\",\"author\":\"Filip Skokan <panva.ip@gmail.com>\",\"exports\":{\"types\":\"./types/index.d.ts\",\"import\":\"./lib/index.mjs\",\"require\":\"./lib/index.js\"},\"main\":\"./lib/index.js\",\"types\":\"./types/index.d.ts\",\"files\":[\"lib\",\"types/index.d.ts\"],\"scripts\":{\"format\":\"npx prettier --loglevel silent --write ./lib ./test ./certification ./types\",\"test\":\"mocha test/**/*.test.js\"},\"dependencies\":{\"jose\":\"^4.15.9\",\"lru-cache\":\"^6.0.0\",\"object-hash\":\"^2.2.0\",\"oidc-token-hash\":\"^5.0.3\"},\"devDependencies\":{\"@types/node\":\"^16.18.106\",\"@types/passport\":\"^1.0.16\",\"base64url\":\"^3.0.1\",\"chai\":\"^4.5.0\",\"mocha\":\"^10.7.3\",\"nock\":\"^13.5.5\",\"prettier\":\"^2.8.8\",\"readable-mock-req\":\"^0.2.2\",\"sinon\":\"^9.2.4\",\"timekeeper\":\"^2.3.1\"},\"standard-version\":{\"scripts\":{\"postchangelog\":\"sed -i '' -e 's/### \\\\[/## [/g' CHANGELOG.md\"},\"types\":[{\"type\":\"feat\",\"section\":\"Features\"},{\"type\":\"fix\",\"section\":\"Fixes\"},{\"type\":\"chore\",\"hidden\":true},{\"type\":\"docs\",\"hidden\":true},{\"type\":\"style\",\"hidden\":true},{\"type\":\"refactor\",\"section\":\"Refactor\",\"hidden\":false},{\"type\":\"perf\",\"section\":\"Performance\",\"hidden\":false},{\"type\":\"test\",\"hidden\":true}]}}","\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});","\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar _exportNames = {};\nObject.defineProperty(exports, \"default\", {\n  enumerable: true,\n  get: function () {\n    return _next.default;\n  }\n});\nvar _types = require(\"./core/types\");\nObject.keys(_types).forEach(function (key) {\n  if (key === \"default\" || key === \"__esModule\") return;\n  if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;\n  if (key in exports && exports[key] === _types[key]) return;\n  Object.defineProperty(exports, key, {\n    enumerable: true,\n    get: function () {\n      return _types[key];\n    }\n  });\n});\nvar _next = _interopRequireWildcard(require(\"./next\"));\nObject.keys(_next).forEach(function (key) {\n  if (key === \"default\" || key === \"__esModule\") return;\n  if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;\n  if (key in exports && exports[key] === _next[key]) return;\n  Object.defineProperty(exports, key, {\n    enumerable: true,\n    get: function () {\n      return _next[key];\n    }\n  });\n});\nfunction _getRequireWildcardCache(e) { if (\"function\" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }\nfunction _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || \"object\" != typeof e && \"function\" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if (\"default\" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }","import { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth-options\";\nimport { getCurrentUsage } from \"@/lib/usage-tracking\";\nimport { getUserLimits } from \"@/services/subscription-service\";\nimport { UsageType } from \"@/generated/prisma\";\n\nexport interface UsageLimitResult {\n\tallowed: boolean;\n\treason?: string;\n\tcurrentUsage?: number;\n\tlimit?: number;\n}\n\n/**\n * Check if user can perform an action based on their subscription limits\n */\nexport async function checkUsageLimit(\n\tusageType: UsageType,\n\tuserId?: number\n): Promise<UsageLimitResult> {\n\ttry {\n\t\t// Skip usage limits in development mode or if DISABLE_USAGE_LIMITS is set\n\t\tif (\n\t\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\t\tprocess.env.DISABLE_USAGE_LIMITS === \"true\"\n\t\t) {\n\t\t\tconsole.log(\n\t\t\t\t\"[USAGE-LIMITS] Usage limits disabled (development mode or DISABLE_USAGE_LIMITS=true)\"\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentUsage: 0,\n\t\t\t\tlimit: -1, // Unlimited\n\t\t\t};\n\t\t}\n\n\t\t// Get session if userId not provided\n\t\tif (!userId) {\n\t\t\tconst session = await getServerSession(authOptions);\n\t\t\tif (!session?.user?.id) {\n\t\t\t\treturn {\n\t\t\t\t\tallowed: false,\n\t\t\t\t\treason: \"Authentication required\",\n\t\t\t\t};\n\t\t\t}\n\t\t\tuserId = parseInt(session.user.id as string);\n\t\t}\n\n\t\t// Get user's limits\n\t\tconst limits = await getUserLimits(userId);\n\t\tconst limit =\n\t\t\tlimits[\n\t\t\t\tusageType === \"file_upload\"\n\t\t\t\t\t? \"files\"\n\t\t\t\t\t: usageType === \"chat_message\"\n\t\t\t\t\t? \"chats\"\n\t\t\t\t\t: \"exports\"\n\t\t\t];\n\n\t\t// Unlimited plans\n\t\tif (limit === -1) {\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentUsage: 0,\n\t\t\t\tlimit: -1,\n\t\t\t};\n\t\t}\n\n\t\t// Check current usage\n\t\tconst currentUsage = await getCurrentUsage(userId, usageType);\n\t\tconst allowed = currentUsage < limit;\n\n\t\treturn {\n\t\t\tallowed,\n\t\t\tcurrentUsage,\n\t\t\tlimit,\n\t\t\treason: allowed\n\t\t\t\t? undefined\n\t\t\t\t: `You have reached your ${usageType.replace(\n\t\t\t\t\t\t\"_\",\n\t\t\t\t\t\t\" \"\n\t\t\t\t  )} limit of ${limit}. Please upgrade your plan.`,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"[USAGE-LIMITS] Error checking usage limit:\", error);\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Error checking usage limits\",\n\t\t};\n\t}\n}\n\n/**\n * Middleware helper to enforce usage limits in API routes\n */\nexport async function enforceUsageLimit(\n\tusageType: UsageType,\n\tuserId?: number\n): Promise<\n\t{ success: true } | { success: false; error: string; status: number }\n> {\n\t// Skip usage limits in development mode or if DISABLE_USAGE_LIMITS is set\n\tif (\n\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\tprocess.env.DISABLE_USAGE_LIMITS === \"true\"\n\t) {\n\t\tconsole.log(\n\t\t\t\"[USAGE-LIMITS] Usage limits disabled (development mode or DISABLE_USAGE_LIMITS=true)\"\n\t\t);\n\t\treturn { success: true };\n\t}\n\n\tconst result = await checkUsageLimit(usageType, userId);\n\n\tif (!result.allowed) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: result.reason || \"Usage limit exceeded\",\n\t\t\tstatus: 429, // Too Many Requests\n\t\t};\n\t}\n\n\treturn { success: true };\n}\n","import { db } from \"@/lib/db\";\nimport { UsageType, Prisma } from \"@/generated/prisma\";\nimport { startOfMonth, endOfMonth } from \"date-fns\";\n\n/**\n * Track usage for a user\n */\nexport async function trackUsage(\n\tuserId: number,\n\tusageType: UsageType,\n\tcount: number = 1,\n\tmetadata?: Record<string, any>\n) {\n\tconst now = new Date();\n\tconst periodStart = startOfMonth(now);\n\tconst periodEnd = endOfMonth(now);\n\n\t// Check if usage record exists for this period\n\tconst existing = await db.usageTracking.findFirst({\n\t\twhere: {\n\t\t\tuser_id: userId,\n\t\t\tusage_type: usageType,\n\t\t\tperiod_start: periodStart,\n\t\t\tperiod_end: periodEnd,\n\t\t},\n\t});\n\n\tif (existing) {\n\t\t// Update existing record\n\t\treturn await db.usageTracking.update({\n\t\t\twhere: { id: existing.id },\n\t\t\tdata: {\n\t\t\t\tcount: existing.count + count,\n\t\t\t\tmetadata: metadata\n\t\t\t\t\t? { ...(existing.metadata as object), ...metadata }\n\t\t\t\t\t: existing.metadata === null\n\t\t\t\t\t\t? Prisma.JsonNull\n\t\t\t\t\t\t: existing.metadata,\n\t\t\t},\n\t\t});\n\t} else {\n\t\t// Create new record\n\t\treturn await db.usageTracking.create({\n\t\t\tdata: {\n\t\t\t\tuser_id: userId,\n\t\t\t\tusage_type: usageType,\n\t\t\t\tcount,\n\t\t\t\tperiod_start: periodStart,\n\t\t\t\tperiod_end: periodEnd,\n\t\t\t\tmetadata: metadata || {},\n\t\t\t},\n\t\t});\n\t}\n}\n\n/**\n * Get current period usage for a user\n */\nexport async function getCurrentUsage(\n\tuserId: number,\n\tusageType: UsageType\n): Promise<number> {\n\tconst now = new Date();\n\tconst periodStart = startOfMonth(now);\n\tconst periodEnd = endOfMonth(now);\n\n\tconst usage = await db.usageTracking.findFirst({\n\t\twhere: {\n\t\t\tuser_id: userId,\n\t\t\tusage_type: usageType,\n\t\t\tperiod_start: periodStart,\n\t\t\tperiod_end: periodEnd,\n\t\t},\n\t});\n\n\treturn usage?.count || 0;\n}\n\n/**\n * Get all current period usage for a user\n */\nexport async function getAllCurrentUsage(userId: number) {\n\tconst now = new Date();\n\tconst periodStart = startOfMonth(now);\n\tconst periodEnd = endOfMonth(now);\n\n\tconst usageRecords = await db.usageTracking.findMany({\n\t\twhere: {\n\t\t\tuser_id: userId,\n\t\t\tperiod_start: periodStart,\n\t\t\tperiod_end: periodEnd,\n\t\t},\n\t});\n\n\tconst usage: Record<UsageType, number> = {\n\t\tfile_upload: 0,\n\t\tchat_message: 0,\n\t\tdocument_export: 0,\n\t\tai_processing: 0,\n\t\tquiz_generation: 0,\n\t\tbattle_match: 0,\n\t\tai_tutor_session: 0,\n\t};\n\n\tusageRecords.forEach((record) => {\n\t\tusage[record.usage_type] = record.count;\n\t});\n\n\treturn usage;\n}\n\n/**\n * Check if user has exceeded limit for a usage type\n */\nexport async function hasExceededLimit(\n\tuserId: number,\n\tusageType: UsageType,\n\tlimit: number\n): Promise<boolean> {\n\tconst currentUsage = await getCurrentUsage(userId, usageType);\n\treturn currentUsage >= limit;\n}\n\n/**\n * Check if user can perform an action (hasn't exceeded limit)\n */\nexport async function canPerformAction(\n\tuserId: number,\n\tusageType: UsageType,\n\tlimit: number\n): Promise<boolean> {\n\treturn !(await hasExceededLimit(userId, usageType, limit));\n}\n\n/**\n * Get usage statistics for a user\n */\nexport async function getUserUsageStats(userId: number) {\n\tconst now = new Date();\n\tconst periodStart = startOfMonth(now);\n\tconst periodEnd = endOfMonth(now);\n\n\tconst usageRecords = await db.usageTracking.findMany({\n\t\twhere: {\n\t\t\tuser_id: userId,\n\t\t\tperiod_start: {\n\t\t\t\tgte: periodStart,\n\t\t\t\tlte: periodEnd,\n\t\t\t},\n\t\t},\n\t\torderBy: {\n\t\t\tcreated_at: \"desc\",\n\t\t},\n\t});\n\n\treturn usageRecords;\n}\n","import { db } from \"@/lib/db\";\nimport { SubscriptionStatus, BillingCycle } from \"@/generated/prisma\";\n\n/**\n * Get subscription plan by ID\n */\nexport async function getSubscriptionPlan(planId: number) {\n\treturn await db.subscriptionPlan.findUnique({\n\t\twhere: { id: planId },\n\t});\n}\n\n/**\n * Get all active subscription plans\n */\nexport async function getActivePlans() {\n\treturn await db.subscriptionPlan.findMany({\n\t\twhere: { is_active: true },\n\t\torderBy: { price_monthly: \"asc\" },\n\t});\n}\n\n/**\n * Get default subscription plan (free tier)\n */\nexport async function getDefaultPlan() {\n\treturn await db.subscriptionPlan.findFirst({\n\t\twhere: { is_default: true, is_active: true },\n\t});\n}\n\n/**\n * Get user's current subscription\n */\nexport async function getUserSubscription(userId: number) {\n\treturn await db.userSubscription.findUnique({\n\t\twhere: { user_id: userId },\n\t\tinclude: {\n\t\t\tplan: true,\n\t\t},\n\t});\n}\n\n/**\n * Create or update user subscription\n */\nexport async function upsertUserSubscription(\n\tuserId: number,\n\tdata: {\n\t\tplanId: number;\n\t\trazorpaySubscriptionId?: string;\n\t\trazorpayCustomerId?: string;\n\t\trazorpayOrderId?: string;\n\t\tstatus?: SubscriptionStatus;\n\t\tbillingCycle?: BillingCycle;\n\t\tcurrentPeriodStart: Date;\n\t\tcurrentPeriodEnd: Date;\n\t}\n) {\n\tconst {\n\t\tplanId,\n\t\trazorpaySubscriptionId,\n\t\trazorpayCustomerId,\n\t\trazorpayOrderId,\n\t\tstatus = SubscriptionStatus.active,\n\t\tbillingCycle = BillingCycle.monthly,\n\t\tcurrentPeriodStart,\n\t\tcurrentPeriodEnd,\n\t} = data;\n\n\treturn await db.userSubscription.upsert({\n\t\twhere: { user_id: userId },\n\t\tupdate: {\n\t\t\tplan_id: planId,\n\t\t\trazorpay_subscription_id: razorpaySubscriptionId,\n\t\t\trazorpay_customer_id: razorpayCustomerId,\n\t\t\trazorpay_order_id: razorpayOrderId,\n\t\t\tstatus,\n\t\t\tbilling_cycle: billingCycle,\n\t\t\tcurrent_period_start: currentPeriodStart,\n\t\t\tcurrent_period_end: currentPeriodEnd,\n\t\t},\n\t\tcreate: {\n\t\t\tuser_id: userId,\n\t\t\tplan_id: planId,\n\t\t\trazorpay_subscription_id: razorpaySubscriptionId,\n\t\t\trazorpay_customer_id: razorpayCustomerId,\n\t\t\trazorpay_order_id: razorpayOrderId,\n\t\t\tstatus,\n\t\t\tbilling_cycle: billingCycle,\n\t\t\tcurrent_period_start: currentPeriodStart,\n\t\t\tcurrent_period_end: currentPeriodEnd,\n\t\t},\n\t\tinclude: {\n\t\t\tplan: true,\n\t\t},\n\t});\n}\n\n/**\n * Cancel user subscription\n */\nexport async function cancelSubscription(\n\tuserId: number,\n\tcancelAtPeriodEnd: boolean = true\n) {\n\treturn await db.userSubscription.update({\n\t\twhere: { user_id: userId },\n\t\tdata: {\n\t\t\tcancel_at_period_end: cancelAtPeriodEnd,\n\t\t\tcanceled_at: cancelAtPeriodEnd ? null : new Date(),\n\t\t\tstatus: cancelAtPeriodEnd\n\t\t\t\t? SubscriptionStatus.active\n\t\t\t\t: SubscriptionStatus.canceled,\n\t\t},\n\t\tinclude: {\n\t\t\tplan: true,\n\t\t},\n\t});\n}\n\n/**\n * Update subscription status\n */\nexport async function updateSubscriptionStatus(\n\tuserId: number,\n\tstatus: SubscriptionStatus\n) {\n\treturn await db.userSubscription.update({\n\t\twhere: { user_id: userId },\n\t\tdata: { status },\n\t\tinclude: {\n\t\t\tplan: true,\n\t\t},\n\t});\n}\n\n/**\n * Get user's subscription limits\n */\nexport async function getUserLimits(userId: number) {\n\tconst subscription = await getUserSubscription(userId);\n\n\tif (!subscription) {\n\t\t// Return default plan limits if no subscription\n\t\tconst defaultPlan = await getDefaultPlan();\n\t\tif (!defaultPlan) {\n\t\t\t// Fallback to free tier limits if no default plan exists in database\n\t\t\t// This handles cases where the database hasn't been seeded yet\n\t\t\tconsole.warn(\n\t\t\t\t\"[SUBSCRIPTION-SERVICE] No default plan found, using fallback free tier limits\"\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tfiles: 10,\n\t\t\t\tchats: 20,\n\t\t\t\texports: 5,\n\t\t\t};\n\t\t}\n\t\treturn defaultPlan.limits as {\n\t\t\tfiles: number;\n\t\t\tchats: number;\n\t\t\texports: number;\n\t\t};\n\t}\n\n\treturn subscription.plan.limits as {\n\t\tfiles: number;\n\t\tchats: number;\n\t\texports: number;\n\t};\n}\n\n/**\n * Check if user has active subscription\n */\nexport async function hasActiveSubscription(userId: number): Promise<boolean> {\n\tconst subscription = await getUserSubscription(userId);\n\n\tif (!subscription) {\n\t\treturn false;\n\t}\n\n\treturn (\n\t\tsubscription.status === SubscriptionStatus.active ||\n\t\tsubscription.status === SubscriptionStatus.trialing\n\t);\n}\n\n/**\n * Get subscription features\n */\nexport async function getUserFeatures(userId: number) {\n\tconst subscription = await getUserSubscription(userId);\n\n\tif (!subscription) {\n\t\tconst defaultPlan = await getDefaultPlan();\n\t\tif (!defaultPlan) {\n\t\t\treturn [];\n\t\t}\n\t\treturn (defaultPlan.features as string[]) || [];\n\t}\n\n\treturn (subscription.plan.features as string[]) || [];\n}\n","/**\n * @module constants\n * @summary Useful constants\n * @description\n * Collection of useful date constants.\n *\n * The constants could be imported from `date-fns/constants`:\n *\n * ```ts\n * import { maxTime, minTime } from \"./constants/date-fns/constants\";\n *\n * function isAllowedTime(time) {\n *   return time <= maxTime && time >= minTime;\n * }\n * ```\n */\n\n/**\n * @constant\n * @name daysInWeek\n * @summary Days in 1 week.\n */\nexport const daysInWeek = 7;\n\n/**\n * @constant\n * @name daysInYear\n * @summary Days in 1 year.\n *\n * @description\n * How many days in a year.\n *\n * One years equals 365.2425 days according to the formula:\n *\n * > Leap year occurs every 4 years, except for years that are divisible by 100 and not divisible by 400.\n * > 1 mean year = (365+1/4-1/100+1/400) days = 365.2425 days\n */\nexport const daysInYear = 365.2425;\n\n/**\n * @constant\n * @name maxTime\n * @summary Maximum allowed time.\n *\n * @example\n * import { maxTime } from \"./constants/date-fns/constants\";\n *\n * const isValid = 8640000000000001 <= maxTime;\n * //=> false\n *\n * new Date(8640000000000001);\n * //=> Invalid Date\n */\nexport const maxTime = Math.pow(10, 8) * 24 * 60 * 60 * 1000;\n\n/**\n * @constant\n * @name minTime\n * @summary Minimum allowed time.\n *\n * @example\n * import { minTime } from \"./constants/date-fns/constants\";\n *\n * const isValid = -8640000000000001 >= minTime;\n * //=> false\n *\n * new Date(-8640000000000001)\n * //=> Invalid Date\n */\nexport const minTime = -maxTime;\n\n/**\n * @constant\n * @name millisecondsInWeek\n * @summary Milliseconds in 1 week.\n */\nexport const millisecondsInWeek = 604800000;\n\n/**\n * @constant\n * @name millisecondsInDay\n * @summary Milliseconds in 1 day.\n */\nexport const millisecondsInDay = 86400000;\n\n/**\n * @constant\n * @name millisecondsInMinute\n * @summary Milliseconds in 1 minute\n */\nexport const millisecondsInMinute = 60000;\n\n/**\n * @constant\n * @name millisecondsInHour\n * @summary Milliseconds in 1 hour\n */\nexport const millisecondsInHour = 3600000;\n\n/**\n * @constant\n * @name millisecondsInSecond\n * @summary Milliseconds in 1 second\n */\nexport const millisecondsInSecond = 1000;\n\n/**\n * @constant\n * @name minutesInYear\n * @summary Minutes in 1 year.\n */\nexport const minutesInYear = 525600;\n\n/**\n * @constant\n * @name minutesInMonth\n * @summary Minutes in 1 month.\n */\nexport const minutesInMonth = 43200;\n\n/**\n * @constant\n * @name minutesInDay\n * @summary Minutes in 1 day.\n */\nexport const minutesInDay = 1440;\n\n/**\n * @constant\n * @name minutesInHour\n * @summary Minutes in 1 hour.\n */\nexport const minutesInHour = 60;\n\n/**\n * @constant\n * @name monthsInQuarter\n * @summary Months in 1 quarter.\n */\nexport const monthsInQuarter = 3;\n\n/**\n * @constant\n * @name monthsInYear\n * @summary Months in 1 year.\n */\nexport const monthsInYear = 12;\n\n/**\n * @constant\n * @name quartersInYear\n * @summary Quarters in 1 year\n */\nexport const quartersInYear = 4;\n\n/**\n * @constant\n * @name secondsInHour\n * @summary Seconds in 1 hour.\n */\nexport const secondsInHour = 3600;\n\n/**\n * @constant\n * @name secondsInMinute\n * @summary Seconds in 1 minute.\n */\nexport const secondsInMinute = 60;\n\n/**\n * @constant\n * @name secondsInDay\n * @summary Seconds in 1 day.\n */\nexport const secondsInDay = secondsInHour * 24;\n\n/**\n * @constant\n * @name secondsInWeek\n * @summary Seconds in 1 week.\n */\nexport const secondsInWeek = secondsInDay * 7;\n\n/**\n * @constant\n * @name secondsInYear\n * @summary Seconds in 1 year.\n */\nexport const secondsInYear = secondsInDay * daysInYear;\n\n/**\n * @constant\n * @name secondsInMonth\n * @summary Seconds in 1 month\n */\nexport const secondsInMonth = secondsInYear / 12;\n\n/**\n * @constant\n * @name secondsInQuarter\n * @summary Seconds in 1 quarter.\n */\nexport const secondsInQuarter = secondsInMonth * 3;\n\n/**\n * @constant\n * @name constructFromSymbol\n * @summary Symbol enabling Date extensions to inherit properties from the reference date.\n *\n * The symbol is used to enable the `constructFrom` function to construct a date\n * using a reference date and a value. It allows to transfer extra properties\n * from the reference date to the new date. It's useful for extensions like\n * [`TZDate`](https://github.com/date-fns/tz) that accept a time zone as\n * a constructor argument.\n */\nexport const constructFromSymbol = Symbol.for(\"constructDateFrom\");\n","import { constructFromSymbol } from \"./constants.js\";\n\n/**\n * @name constructFrom\n * @category Generic Helpers\n * @summary Constructs a date using the reference date and the value\n *\n * @description\n * The function constructs a new date using the constructor from the reference\n * date and the given value. It helps to build generic functions that accept\n * date extensions.\n *\n * It defaults to `Date` if the passed reference date is a number or a string.\n *\n * Starting from v3.7.0, it allows to construct a date using `[Symbol.for(\"constructDateFrom\")]`\n * enabling to transfer extra properties from the reference date to the new date.\n * It's useful for extensions like [`TZDate`](https://github.com/date-fns/tz)\n * that accept a time zone as a constructor argument.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n *\n * @param date - The reference date to take constructor from\n * @param value - The value to create the date\n *\n * @returns Date initialized using the given date and value\n *\n * @example\n * import { constructFrom } from \"./constructFrom/date-fns\";\n *\n * // A function that clones a date preserving the original type\n * function cloneDate<DateType extends Date>(date: DateType): DateType {\n *   return constructFrom(\n *     date, // Use constructor from the given date\n *     date.getTime() // Use the date value to create a new date\n *   );\n * }\n */\nexport function constructFrom(date, value) {\n  if (typeof date === \"function\") return date(value);\n\n  if (date && typeof date === \"object\" && constructFromSymbol in date)\n    return date[constructFromSymbol](value);\n\n  if (date instanceof Date) return new date.constructor(value);\n\n  return new Date(value);\n}\n\n// Fallback for modularized imports:\nexport default constructFrom;\n","import { constructFrom } from \"./constructFrom.js\";\n\n/**\n * @name toDate\n * @category Common Helpers\n * @summary Convert the given argument to an instance of Date.\n *\n * @description\n * Convert the given argument to an instance of Date.\n *\n * If the argument is an instance of Date, the function returns its clone.\n *\n * If the argument is a number, it is treated as a timestamp.\n *\n * If the argument is none of the above, the function returns Invalid Date.\n *\n * Starting from v3.7.0, it clones a date using `[Symbol.for(\"constructDateFrom\")]`\n * enabling to transfer extra properties from the reference date to the new date.\n * It's useful for extensions like [`TZDate`](https://github.com/date-fns/tz)\n * that accept a time zone as a constructor argument.\n *\n * **Note**: *all* Date arguments passed to any *date-fns* function is processed by `toDate`.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param argument - The value to convert\n *\n * @returns The parsed date in the local time zone\n *\n * @example\n * // Clone the date:\n * const result = toDate(new Date(2014, 1, 11, 11, 30, 30))\n * //=> Tue Feb 11 2014 11:30:30\n *\n * @example\n * // Convert the timestamp to date:\n * const result = toDate(1392098430000)\n * //=> Tue Feb 11 2014 11:30:30\n */\nexport function toDate(argument, context) {\n  // [TODO] Get rid of `toDate` or `constructFrom`?\n  return constructFrom(context || argument, argument);\n}\n\n// Fallback for modularized imports:\nexport default toDate;\n","import { toDate } from \"./toDate.js\";\n\n/**\n * The {@link startOfMonth} function options.\n */\n\n/**\n * @name startOfMonth\n * @category Month Helpers\n * @summary Return the start of a month for the given date.\n *\n * @description\n * Return the start of a month for the given date. The result will be in the local timezone.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments.\n * Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed,\n * or inferred from the arguments.\n *\n * @param date - The original date\n * @param options - An object with options\n *\n * @returns The start of a month\n *\n * @example\n * // The start of a month for 2 September 2014 11:55:00:\n * const result = startOfMonth(new Date(2014, 8, 2, 11, 55, 0))\n * //=> Mon Sep 01 2014 00:00:00\n */\nexport function startOfMonth(date, options) {\n  const _date = toDate(date, options?.in);\n  _date.setDate(1);\n  _date.setHours(0, 0, 0, 0);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default startOfMonth;\n","import { toDate } from \"./toDate.js\";\n\n/**\n * The {@link endOfMonth} function options.\n */\n\n/**\n * @name endOfMonth\n * @category Month Helpers\n * @summary Return the end of a month for the given date.\n *\n * @description\n * Return the end of a month for the given date.\n * The result will be in the local timezone.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The original date\n * @param options - An object with options\n *\n * @returns The end of a month\n *\n * @example\n * // The end of a month for 2 September 2014 11:55:00:\n * const result = endOfMonth(new Date(2014, 8, 2, 11, 55, 0))\n * //=> Tue Sep 30 2014 23:59:59.999\n */\nexport function endOfMonth(date, options) {\n  const _date = toDate(date, options?.in);\n  const month = _date.getMonth();\n  _date.setFullYear(_date.getFullYear(), month + 1, 0);\n  _date.setHours(23, 59, 59, 999);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default endOfMonth;\n","// semantic-vector.ts\nimport { pipeline } from \"@xenova/transformers\";\nimport { db as prisma } from \"./db\";\n\n// Define the model we want to use.\n// 'Xenova/all-MiniLM-L6-v2' is standard for RAG: fast, small (23MB), and accurate.\nconst EMBEDDING_MODEL = \"Xenova/all-MiniLM-L6-v2\";\n\nexport class SemanticVectorService {\n\t// Singleton instance of the embedder pipeline to avoid reloading model on every call\n\tprivate static embedder: any = null;\n\n\t/**\n\t * Initialize the local embedding pipeline.\n\t * This downloads the model files (once) and caches them.\n\t */\n\tstatic async initialize() {\n\t\tif (!this.embedder) {\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Initializing local embedder model: ${EMBEDDING_MODEL}...`\n\t\t\t);\n\t\t\tthis.embedder = await pipeline(\"feature-extraction\", EMBEDDING_MODEL);\n\t\t\tconsole.log(\"[SEMANTIC] Embedder initialized successfully\");\n\t\t}\n\t}\n\n\t/**\n\t * Generates a vector embedding locally using Transformers.js\n\t * No API limits, no costs.\n\t */\n\tstatic async generateEmbedding(text: string): Promise<number[]> {\n\t\tawait this.initialize();\n\n\t\tif (!text || !text.trim()) {\n\t\t\tthrow new Error(\"Text is required for embedding generation\");\n\t\t}\n\n\t\t// 1. Pre-process text:\n\t\t// Replace newlines to keep semantic meaning consistent and trim\n\t\tconst cleanedText = text.replace(/\\n+/g, \" \").trim();\n\n\t\t// 2. Truncate text to avoid model limits (512 tokens approx ~2000 chars)\n\t\t// We truncate to 2000 characters to be safe.\n\t\t// For full document search, you should ideally chunk the document and average the vectors,\n\t\t// but for a simple file-level vector, truncating the first 2000 chars (header + summary) works well.\n\t\tconst truncatedText = cleanedText.substring(0, 2000);\n\n\t\ttry {\n\t\t\t// 3. Run inference\n\t\t\tconst result = await this.embedder(truncatedText, {\n\t\t\t\tpooling: \"mean\", // Average the token vectors to get one sentence vector\n\t\t\t\tnormalize: true, // Important for cosine similarity\n\t\t\t});\n\n\t\t\t// 4. Convert Float32Array to regular number array\n\t\t\treturn Array.from(result.data);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[SEMANTIC] Error generating embedding:\", error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Updates the semantic vector for a specific file.\n\t * @deprecated This function references the old file_list table. Use chapter-processor.ts for chapter chunks instead.\n\t */\n\tstatic async updateSemanticVector(fileId: number) {\n\t\ttry {\n\t\t\tconst file = await prisma.fileList.findUnique({\n\t\t\t\twhere: { id: fileId },\n\t\t\t\tselect: { title: true, category: true, note: true },\n\t\t\t});\n\n\t\t\tif (!file) {\n\t\t\t\tthrow new Error(`File with ID ${fileId} not found`);\n\t\t\t}\n\n\t\t\t// Combine fields.\n\t\t\t// Tip: Put the most important keywords (Title/Category) FIRST\n\t\t\t// because truncation happens at the end.\n\t\t\tconst textToEmbed = `Title: ${file.title}. Category: ${file.category\n\t\t\t\t}. Content: ${file.note || \"\"}`;\n\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Generating vector for file ${fileId} (${textToEmbed.length} chars)...`\n\t\t\t);\n\n\t\t\tconst embedding = await this.generateEmbedding(textToEmbed);\n\n\t\t\t// Update DB using raw query for pgvector compatibility\n\t\t\tawait prisma.$executeRaw`\n\t\t\t\tUPDATE file_list\n\t\t\t\tSET semantic_vector = ${JSON.stringify(embedding)}::vector\n\t\t\t\tWHERE id = ${fileId}\n\t\t\t`;\n\n\t\t\tconsole.log(`[SEMANTIC] Successfully updated vector for file ${fileId}`);\n\t\t} catch (error) {\n\t\t\tconsole.error(\n\t\t\t\t`[SEMANTIC] Failed to update vector for file ${fileId}:`,\n\t\t\t\terror\n\t\t\t);\n\t\t\t// Don't throw here if this is part of a background batch job, just log it.\n\t\t\t// throw error;\n\t\t}\n\t}\n\n\t/**\n\t * Generate semantic vectors for file chunks\n\t * @deprecated This function references the old file_chunks table. Use chapter-processor.ts for chapter chunks instead.\n\t */\n\tstatic async generateChunkVectors(fileId: number) {\n\t\ttry {\n\t\t\t// Get all chunks for this file\n\t\t\tconst chunks = await prisma.fileChunk.findMany({\n\t\t\t\twhere: { file_id: fileId },\n\t\t\t\tselect: { id: true, content: true },\n\t\t\t});\n\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Generating vectors for ${chunks.length} chunks of file ${fileId}...`\n\t\t\t);\n\n\t\t\tfor (const chunk of chunks) {\n\t\t\t\ttry {\n\t\t\t\t\tconst embedding = await this.generateEmbedding(chunk.content);\n\n\t\t\t\t\t// Update chunk's semantic vector\n\t\t\t\t\tawait prisma.$executeRaw`\n\t\t\t\t\t\tUPDATE file_chunks\n\t\t\t\t\t\tSET semantic_vector = ${JSON.stringify(embedding)}::vector\n\t\t\t\t\t\tWHERE id = ${chunk.id}\n\t\t\t\t\t`;\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t`[SEMANTIC] Failed to generate vector for chunk ${chunk.id}:`,\n\t\t\t\t\t\terr\n\t\t\t\t\t);\n\t\t\t\t\t// Continue with other chunks\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`[SEMANTIC] Successfully updated vectors for file ${fileId} chunks`\n\t\t\t);\n\t\t} catch (error) {\n\t\t\tconsole.error(\n\t\t\t\t`[SEMANTIC] Failed to generate chunk vectors for file ${fileId}:`,\n\t\t\t\terror\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Batch/Repair function: Find all files missing vectors and generate them.\n\t * @deprecated This function references the old file_list table. Use updateSearchVectors() in ai-service-enhanced.ts for chapter chunks instead.\n\t */\n\tstatic async batchUpdateSemanticVectors() {\n\t\tconsole.log(\"[SEMANTIC] Starting batch update for missing vectors...\");\n\n\t\t// Find IDs where vector is NULL\n\t\tconst records = await prisma.$queryRaw<{ id: number }[]>`\n\t\t\tSELECT id FROM file_list WHERE semantic_vector IS NULL\n\t\t`;\n\n\t\tconsole.log(`[SEMANTIC] Found ${records.length} records to update.`);\n\n\t\tfor (const record of records) {\n\t\t\tawait this.updateSemanticVector(record.id);\n\t\t}\n\n\t\tconsole.log(\"[SEMANTIC] Batch update completed.\");\n\t}\n}\n","\"use strict\";\nvar __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __getOwnPropNames = Object.getOwnPropertyNames;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __export = (target, all) => {\n  for (var name in all)\n    __defProp(target, name, { get: all[name], enumerable: true });\n};\nvar __copyProps = (to, from, except, desc) => {\n  if (from && typeof from === \"object\" || typeof from === \"function\") {\n    for (let key of __getOwnPropNames(from))\n      if (!__hasOwnProp.call(to, key) && key !== except)\n        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });\n  }\n  return to;\n};\nvar __toCommonJS = (mod) => __copyProps(__defProp({}, \"__esModule\", { value: true }), mod);\nvar token_error_exports = {};\n__export(token_error_exports, {\n  VercelOidcTokenError: () => VercelOidcTokenError\n});\nmodule.exports = __toCommonJS(token_error_exports);\nclass VercelOidcTokenError extends Error {\n  constructor(message, cause) {\n    super(message);\n    this.name = \"VercelOidcTokenError\";\n    this.cause = cause;\n  }\n  toString() {\n    if (this.cause) {\n      return `${this.name}: ${this.message}: ${this.cause}`;\n    }\n    return `${this.name}: ${this.message}`;\n  }\n}\n// Annotate the CommonJS export names for ESM import in node:\n0 && (module.exports = {\n  VercelOidcTokenError\n});\n","import prisma from \"@/lib/prisma\";\n\n// Minimal settings store using raw SQL to avoid Prisma schema changes.\n// It lazily creates the table `app_settings` if it does not exist, concurrency-safe.\n\nlet ensureOncePromise: Promise<void> | null = null;\nasync function ensureTableOnce(): Promise<void> {\n  if (ensureOncePromise) return ensureOncePromise;\n  ensureOncePromise = (async () => {\n    try {\n      // Serialize DDL using a Postgres advisory lock to avoid concurrent DDL conflicts\n      await prisma.$executeRawUnsafe(\n        `SELECT pg_advisory_lock(hashtext('cid_ai_app_settings_ddl_lock'));`\n      );\n      try {\n        await prisma.$executeRawUnsafe(\n          `CREATE TABLE IF NOT EXISTS app_settings (\n            key TEXT PRIMARY KEY,\n            value TEXT NOT NULL,\n            created_at TIMESTAMPTZ DEFAULT NOW(),\n            updated_at TIMESTAMPTZ DEFAULT NOW()\n          );`\n        );\n        await prisma.$executeRawUnsafe(\n          `CREATE OR REPLACE FUNCTION set_updated_at()\n           RETURNS TRIGGER AS $$\n           BEGIN\n             NEW.updated_at = NOW();\n             RETURN NEW;\n           END;\n           $$ LANGUAGE plpgsql;`\n        );\n        await prisma.$executeRawUnsafe(\n          `DO $$\n           BEGIN\n             IF NOT EXISTS (\n               SELECT 1 FROM pg_trigger WHERE tgname = 'app_settings_set_updated_at'\n             ) THEN\n               CREATE TRIGGER app_settings_set_updated_at\n               BEFORE UPDATE ON app_settings\n               FOR EACH ROW EXECUTE FUNCTION set_updated_at();\n             END IF;\n           END $$;`\n        );\n      } finally {\n        await prisma.$executeRawUnsafe(\n          `SELECT pg_advisory_unlock(hashtext('cid_ai_app_settings_ddl_lock'));`\n        );\n      }\n    } catch (e) {\n      // Do not block; log and continue. If permissions disallow DDL, reads will just 404.\n      console.warn(\"[APP-SETTINGS] ensureTable failed (non-fatal)\", e);\n    }\n  })();\n  return ensureOncePromise;\n}\n\nexport async function getSetting(key: string): Promise<string | null> {\n  try {\n    await ensureTableOnce();\n    const rows: Array<{ value: string }> = await prisma.$queryRawUnsafe(\n      `SELECT value FROM app_settings WHERE key = $1 LIMIT 1`,\n      key\n    );\n    if (rows && rows.length > 0) return rows[0].value;\n    return null;\n  } catch (e) {\n    console.warn(\"[APP-SETTINGS] getSetting failed\", e);\n    return null;\n  }\n}\n\nexport async function setSetting(key: string, value: string): Promise<void> {\n  await ensureTableOnce();\n  await prisma.$executeRawUnsafe(\n    `INSERT INTO app_settings (key, value)\n     VALUES ($1, $2)\n     ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value`,\n    key,\n    value\n  );\n}\n\nexport async function getSettingInt(key: string, defaultValue: number): Promise<number> {\n  const v = await getSetting(key);\n  if (v == null) return defaultValue;\n  const n = Number(v);\n  if (!Number.isFinite(n) || n <= 0) return defaultValue;\n  return Math.floor(n);\n}\n\nexport async function setSettingInt(key: string, value: number): Promise<void> {\n  if (!Number.isFinite(value) || value <= 0) {\n    throw new Error(\"Value must be a positive integer\");\n  }\n  await setSetting(key, String(Math.floor(value)));\n}\n","/**\n * Input Sanitization for AI Prompts\n * \n * Prevents prompt injection attacks and ensures safe input to AI models\n */\n\nexport interface SanitizationResult {\n  sanitized: string;\n  wasModified: boolean;\n  removedPatterns: string[];\n}\n\n/**\n * Sanitize user input before sending to AI\n * Removes potentially malicious patterns while preserving legitimate queries\n */\nexport function sanitizeAIInput(input: string, maxLength: number = 1000): SanitizationResult {\n  const removedPatterns: string[] = [];\n  let sanitized = input;\n  const original = input;\n\n  // 1. Enforce max length first\n  if (sanitized.length > maxLength) {\n    sanitized = sanitized.slice(0, maxLength);\n    removedPatterns.push('length_exceeded');\n  }\n\n  // 2. Remove control characters except newlines and tabs\n  const beforeControl = sanitized;\n  sanitized = sanitized.replace(/[\\x00-\\x08\\x0B-\\x0C\\x0E-\\x1F\\x7F]/g, '');\n  if (beforeControl !== sanitized) removedPatterns.push('control_characters');\n\n  // 3. Detect and neutralize common prompt injection patterns\n  const injectionPatterns = [\n    /ignore\\s+(?:all\\s+)?(?:previous|above|prior)\\s+(?:instructions?|prompts?|rules?)/gi,\n    /disregard\\s+(?:all\\s+)?(?:previous|above|prior)\\s+(?:instructions?|prompts?)/gi,\n    /you\\s+are\\s+now\\s+(?:a\\s+)?(?:different|new)/gi,\n    /act\\s+as\\s+(?:a\\s+)?(?:different|new)/gi,\n    /pretend\\s+(?:you\\s+are|to\\s+be)/gi,\n    /system\\s*:?\\s*(?:override|bypass|ignore)/gi,\n  ];\n\n  for (const pattern of injectionPatterns) {\n    if (pattern.test(sanitized)) {\n      sanitized = sanitized.replace(pattern, '[REDACTED]');\n      removedPatterns.push('injection_attempt');\n    }\n  }\n\n  // 4. Limit consecutive special characters (potential encoding attacks)\n  const beforeSpecial = sanitized;\n  sanitized = sanitized.replace(/([\\\\'\"`;{}[\\]()<>]){3,}/g, '$1$1');\n  if (beforeSpecial !== sanitized) removedPatterns.push('excessive_special_chars');\n\n  // 5. Remove potential SQL injection patterns (extra safety layer)\n  const sqlPatterns = [\n    /;\\s*(?:drop|delete|truncate|alter|create)\\s+(?:table|database)/gi,\n    /union\\s+(?:all\\s+)?select/gi,\n    /(?:exec|execute)\\s*\\(/gi,\n  ];\n\n  for (const pattern of sqlPatterns) {\n    if (pattern.test(sanitized)) {\n      sanitized = sanitized.replace(pattern, '[REDACTED]');\n      removedPatterns.push('sql_injection_attempt');\n    }\n  }\n\n  // 6. Limit multiple newlines\n  sanitized = sanitized.replace(/\\n{4,}/g, '\\n\\n\\n');\n\n  return {\n    sanitized: sanitized.trim(),\n    wasModified: original !== sanitized,\n    removedPatterns,\n  };\n}\n\n/**\n * Validate conversation history message\n */\nexport interface ConversationMessage {\n  role: 'user' | 'assistant';\n  content: string;\n  id?: string;\n  timestamp?: Date | string;\n}\n\nexport function validateConversationHistory(\n  history: any[],\n  maxLength: number = 20,\n  maxMessageLength: number = 1000\n): { valid: boolean; error?: string; sanitized?: ConversationMessage[] } {\n  if (!Array.isArray(history)) {\n    return { valid: false, error: 'conversationHistory must be an array' };\n  }\n\n  if (history.length > maxLength) {\n    return {\n      valid: false,\n      error: `conversationHistory too long (max ${maxLength} messages)`,\n    };\n  }\n\n  const sanitized: ConversationMessage[] = [];\n\n  for (let i = 0; i < history.length; i++) {\n    const msg = history[i];\n\n    // Validate structure\n    if (typeof msg !== 'object' || msg === null) {\n      return { valid: false, error: `Message ${i} is not an object` };\n    }\n\n    // Validate role\n    if (!msg.role || !['user', 'assistant'].includes(msg.role)) {\n      return { valid: false, error: `Message ${i} has invalid role` };\n    }\n\n    // Validate content\n    if (!msg.content || typeof msg.content !== 'string') {\n      return { valid: false, error: `Message ${i} has invalid content` };\n    }\n\n    // Only apply length limit to user messages (assistant messages can be long)\n    if (msg.role === 'user' && msg.content.length > maxMessageLength) {\n      return {\n        valid: false,\n        error: `Message ${i} content too long (max ${maxMessageLength} characters)`,\n      };\n    }\n\n    // Sanitize content\n    const sanitizationResult = sanitizeAIInput(msg.content, maxMessageLength);\n\n    sanitized.push({\n      role: msg.role,\n      content: sanitizationResult.sanitized,\n      id: typeof msg.id === 'string' ? msg.id : undefined,\n      timestamp: msg.timestamp,\n    });\n  }\n\n  return { valid: true, sanitized };\n}\n\n/**\n * Sanitize filter values (category)\n */\nexport function sanitizeFilterValue(value: string): string {\n  return value\n    .trim()\n    .replace(/[<>'\"`;\\\\]/g, '') // Remove potentially dangerous characters\n    .slice(0, 100); // Limit length\n}\n\n","/**\n * Rate Limiter Implementation\n *\n * Protects API endpoints from abuse by limiting requests per time window\n */\n\ninterface RateLimitInfo {\n\tcount: number;\n\tresetAt: number;\n}\n\nexport class RateLimiter {\n\tprivate cache: Map<string, RateLimitInfo>;\n\tprivate options: {\n\t\twindowMs: number;\n\t\tmax: number;\n\t};\n\n\tconstructor(options: { windowMs: number; max: number }) {\n\t\tthis.cache = new Map();\n\t\tthis.options = options;\n\n\t\t// Cleanup expired entries every minute\n\t\tsetInterval(() => this.cleanup(), 60000);\n\t}\n\n\tprivate cleanup() {\n\t\tconst now = Date.now();\n\t\tfor (const [key, info] of this.cache.entries()) {\n\t\t\tif (now > info.resetAt) {\n\t\t\t\tthis.cache.delete(key);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync check(key: string): Promise<{\n\t\tallowed: boolean;\n\t\tremaining: number;\n\t\tresetIn: number;\n\t\tresetAt: Date;\n\t}> {\n\t\tconst now = Date.now();\n\t\tlet info = this.cache.get(key);\n\n\t\t// Reset if window expired\n\t\tif (!info || now > info.resetAt) {\n\t\t\tinfo = {\n\t\t\t\tcount: 0,\n\t\t\t\tresetAt: now + this.options.windowMs,\n\t\t\t};\n\t\t}\n\n\t\tinfo.count++;\n\t\tthis.cache.set(key, info);\n\n\t\tconst allowed = info.count <= this.options.max;\n\t\tconst remaining = Math.max(0, this.options.max - info.count);\n\t\tconst resetIn = info.resetAt - now;\n\n\t\treturn {\n\t\t\tallowed,\n\t\t\tremaining,\n\t\t\tresetIn,\n\t\t\tresetAt: new Date(info.resetAt),\n\t\t};\n\t}\n\n\treset(key: string) {\n\t\tthis.cache.delete(key);\n\t}\n}\n\n// Pre-configured rate limiters for different endpoints\nexport const chatRateLimiter = new RateLimiter({\n\twindowMs: 60 * 1000, // 1 minute\n\tmax: 10, // 10 requests per minute per user\n});\n\nexport const apiRateLimiter = new RateLimiter({\n\twindowMs: 60 * 1000,\n\tmax: 30, // 30 requests per minute for general API\n});\n"],"names":[],"mappings":"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","ignoreList":[3,4,8,9,10,11,12,14]}